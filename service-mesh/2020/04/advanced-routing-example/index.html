<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="OpenShift 4.x and Service Mesh/istio Tutorial 6 - Advanced Routing. Try routing traffic based on canary, mirroring or loadbalancing traffic."><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><meta name=keywords content="Istio,Service Mesh,OpenShift,OCP,Grayscale,Canary,DestinationRule,Mirror,Loadbalancer"><link rel=canonical href=https://blog.stderr.at/service-mesh/2020/04/advanced-routing-example/><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Advanced Routing Example :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1689582119 rel=stylesheet><link href=/css/fontawesome-all.min.css?1689582119 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1689582119 rel=stylesheet><link href=/css/hybrid.css?1689582119 rel=stylesheet><link href=/css/featherlight.min.css?1689582119 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1689582119 rel=stylesheet><link href=/css/auto-complete.css?1689582119 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1689582119 rel=stylesheet><link href=/css/theme.min.css?1689582119 rel=stylesheet><link href=/css/hugo-theme.css?1689582119 rel=stylesheet><link href=/css/theme-yaub.css?1689582119 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1689582119></script>
<script src=/js/jquery.waypoints.min.js?1689582119></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/service-mesh/2020/04/advanced-routing-example/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<span class=read-progress></span><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1689582119></script>
<script type=text/javascript src=/js/auto-complete.js?1689582119></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1689582119></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class=dd-item><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2023-03-20-operator-installation-with-argocd/ title="Operator installation with Argo CD" class=dd-item><a href=/openshift/2023-03-20-operator-installation-with-argocd/>Operator installation with Argo CD</a></li><li data-nav-id=/openshift/2023-16-02-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" class=dd-item><a href=/openshift/2023-16-02-ssl-certificate-management/>SSL Certificate Management for OpenShift on AWS</a></li><li data-nav-id=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD" class=dd-item><a href=/openshift/2022-11-04-argocd-and-serversideapply/>Using ServerSideApply with ArgoCD</a></li><li data-nav-id=/openshift/2022-08-16-hashicorp-vault/ title="Secrets Management - Vault on OpenShift" class=dd-item><a href=/openshift/2022-08-16-hashicorp-vault/>Secrets Management - Vault on OpenShift</a></li><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2022-01-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2022-01-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2022-01-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2022-01-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/securesupplychain/ title="Secure Supply Chain" class=dd-item><a href=/securesupplychain/>Secure Supply Chain</a><ul><li data-nav-id=/securesupplychain/2023-06-15-securesupplychain-intro/ title="Introduction to a Secure Supply Chain" class=dd-item><a href=/securesupplychain/2023-06-15-securesupplychain-intro/>Introduction to a Secure Supply Chain</a></li><li data-nav-id=/securesupplychain/2023-06-16-securesupplychain-step1/ title="Step 1 - Listen to Events" class=dd-item><a href=/securesupplychain/2023-06-16-securesupplychain-step1/>Step 1 - Listen to Events</a></li><li data-nav-id=/securesupplychain/2023-06-17-securesupplychain-step2/ title="Step 2 - Pipelines" class=dd-item><a href=/securesupplychain/2023-06-17-securesupplychain-step2/>Step 2 - Pipelines</a></li><li data-nav-id=/securesupplychain/2023-06-18-securesupplychain-step3/ title="Step 3 - SonarQube" class=dd-item><a href=/securesupplychain/2023-06-18-securesupplychain-step3/>Step 3 - SonarQube</a></li><li data-nav-id=/securesupplychain/2023-06-19-securesupplychain-step4/ title="Step 4 - Verify Git Commit" class=dd-item><a href=/securesupplychain/2023-06-19-securesupplychain-step4/>Step 4 - Verify Git Commit</a></li><li data-nav-id=/securesupplychain/2023-06-20-securesupplychain-step5/ title="Step 5 - Build and Sign Image" class=dd-item><a href=/securesupplychain/2023-06-20-securesupplychain-step5/>Step 5 - Build and Sign Image</a></li><li data-nav-id=/securesupplychain/2023-06-21-securesupplychain-step6/ title="Step 6 - Scanning with ACS" class=dd-item><a href=/securesupplychain/2023-06-21-securesupplychain-step6/>Step 6 - Scanning with ACS</a></li><li data-nav-id=/securesupplychain/2023-06-22-securesupplychain-step7/ title="Step 7 - Generating a SBOM" class=dd-item><a href=/securesupplychain/2023-06-22-securesupplychain-step7/>Step 7 - Generating a SBOM</a></li><li data-nav-id=/securesupplychain/2023-06-23-securesupplychain-step8/ title="Step 8 - Updating Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-23-securesupplychain-step8/>Step 8 - Updating Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-24-securesupplychain-step9/ title="Step 9 - Linting Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-24-securesupplychain-step9/>Step 9 - Linting Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-25-securesupplychain-step10/ title="Step 10 - The Example Application" class=dd-item><a href=/securesupplychain/2023-06-25-securesupplychain-step10/>Step 10 - The Example Application</a></li><li data-nav-id=/securesupplychain/2023-06-26-securesupplychain-step11/ title="Step 11 - ACS Deployment Check" class=dd-item><a href=/securesupplychain/2023-06-26-securesupplychain-step11/>Step 11 - ACS Deployment Check</a></li><li data-nav-id=/securesupplychain/2023-06-27-securesupplychain-step12/ title="Step 12 - Verify TLog Signature" class=dd-item><a href=/securesupplychain/2023-06-27-securesupplychain-step12/>Step 12 - Verify TLog Signature</a></li><li data-nav-id=/securesupplychain/2023-06-28-securesupplychain-step13/ title="Step 13 - Bring it to Production" class=dd-item><a href=/securesupplychain/2023-06-28-securesupplychain-step13/>Step 13 - Bring it to Production</a></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class="dd-item
parent"><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class="dd-item active"><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/archive/ title=Archive class=dd-item><a href=/archive/>Archive</a></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://charts.stderr.at/><i class='fas fa-book'></i> Helm Charts</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body class=post-content><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_advanced_routing>Advanced Routing</a><ul><li><a href=#_canary_deployments>Canary Deployments</a></li><li><a href=#_routing_based_on_user_agent_header>Routing based on user-agent header</a></li><li><a href=#_mirroring_traffic>Mirroring Traffic</a></li><li><a href=#_load_balancing>Load Balancing</a></li></ul></li></ul></nav><div id=navigation><a class=nav-prev href=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic"><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/service-mesh/2020/04/routing-example/ title="Routing Example" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/service-mesh/><span itemprop=name>Service Mesh</span><meta itemprop=position content="2"></a></span>> Advanced Routing Example</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_advanced_routing>Advanced Routing</a><ul><li><a href=#_canary_deployments>Canary Deployments</a></li><li><a href=#_routing_based_on_user_agent_header>Routing based on user-agent header</a></li><li><a href=#_mirroring_traffic>Mirroring Traffic</a></li><li><a href=#_load_balancing>Load Balancing</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/istio>Istio</a>
<a class=tag-link href=/tags/service-mesh>Service Mesh</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/grayscale>Grayscale</a>
<a class=tag-link href=/tags/canary>Canary</a>
<a class=tag-link href=/tags/destinationrule>DestinationRule</a>
<a class=tag-link href=/tags/mirror>Mirror</a>
<a class=tag-link href=/tags/loadbalancer>Loadbalancer</a></div></div><div id=body-inner><h1>Advanced Routing Example</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2020-04-03T00:00:00Z><strong>April 3, 2020</strong></time>
- By:
Thomas Jungbauer
( Lastmod: 2021-08-14 ) - <span class=readtime><strong>4 min read</strong></span></p><div class=paragraph><p>Welcome to part 6 of <strong>OpenShift 4 and Service Mesh</strong> Advanced routing, like Canary Deployments, traffic mirroring and loadbalancing are discussed and tested. All operations have been successdully tested on OpenShift 4.3.</p></div><div class=sect1><h2 id=_advanced_routing>Advanced Routing</h2><div class=sectionbody><div class=paragraph><p>During <a href=/service-mesh/2020/04/routing-example>Issue #5</a> some simple routing was implemented. The traffic was split by 100% to a new version (v2) of the <em>recommendation</em> microservice.
This section shall give a brief overview of advanced routing possibilities.</p></div><div class=sect2><h3 id=_canary_deployments>Canary Deployments</h3><div class=paragraph><p>A canary deployment is a strategy to roll out a new version of your service by using traffic splitting. A small amount of traffic (10%) will be sent to the new version, while most of the traffic will be sent to the old version still. The traffic to the new version can be analysed and if everything works as expected more and more traffic can be sent to the new version.</p></div><div class=paragraph><p>To enable split traffic, the VirtualService must be update:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v1
      weight: 90
    - destination:
        host: recommendation
        subset: version-v2
      weight: 10</code></pre></div></div><div class=paragraph><p>Apply the change</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc apply -f VitualService_split_v1_and_v1.yaml</code></pre></div></div><div class=paragraph><p>Test the traffic and verify that 10% will be sent to v2</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 100 $GATEWAY_URL

# 0: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 1060
# 1: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 1061
# 2: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 2060
# 3: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 1062
# 4: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 1063
...</code></pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>If an error is shown, then you most probably forget to configure the DestinationRule as described <a href=/service-mesh/2020/04/routing-example>here</a>.</td></tr></tbody></table></div><div class=imageblock><div class=content><img src="/service-mesh/images/Kiali_Canary_90_10.png?width=940px&height=224px" alt="Kiali Canary 90 10"></div><div class=title>Figure 1. Kiali split traffic 90/10</div></div><div style=page-break-after:always></div></div><div class=sect2><h3 id=_routing_based_on_user_agent_header>Routing based on user-agent header</h3><div class=paragraph><p>It is possible to send traffic to different versions based on the browser type which is calling the application.
In our test application the service <em>customer</em> is setting the header <strong>baggage-user-agent</strong> and propagates it to the other services.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>>> headers.putSingle("baggage-user-agent", userAgent);</td></tr></tbody></table></div><div class=paragraph><p>Create the following file</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - match:
    - headers:
        baggage-user-agent:
          regex: .*Safari.*
    route:
    - destination:
        host: recommendation
        subset: version-v2
  - route:
    - destination:
        host: recommendation
        subset: version-v1</code></pre></div></div><div class=paragraph><p>and apply the change</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc apply -f VitualService_safari.yaml</code></pre></div></div><div class=paragraph><p>In order to test the result, either use the appropriate browser or use <em>curl</em> to set the user-agent. As expected, request from <em>Safari</em> are sent to v2, other are sent to v1.</p></div><div class=paragraph><p><strong>Safari</strong></p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>curl -v -A Safari $GATEWAY_URL
[...]
&gt; User-Agent: Safari
[...]
customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 2365</code></pre></div></div><div class=paragraph><p><strong>Firefox</strong></p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>curl -v -A Firefox $GATEWAY_URL
[...]
&gt; User-Agent: Firefox
[...]
customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 3762</code></pre></div></div><div style=page-break-after:always></div></div><div class=sect2><h3 id=_mirroring_traffic>Mirroring Traffic</h3><div class=paragraph><p>Mirroring Traffic, aka Dark Launch, will duplicate the traffic to another service, allowing you to analyse it before sending production data to it. Responses of the mirrored requests are ignored.</p></div><div class=paragraph><p>Run the following command and be sure that recommendation-v1 and recommendation-v2 are both running:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc get pod -n tutorial| grep recommendation
recommendation-v1-69db8d6c48-h8brv   2/2     Running   0          24h
recommendation-v2-6c5b86bbd8-jnk8b   2/2     Running   0          23h</code></pre></div></div><div class=paragraph><p>Update the VirtualService, so that version v2 will receive mirrored traffic, while the actual request will be sent to v1:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v1
    mirror: <i class=conum data-value=1></i><b>(1)</b>
      host: recommendation
      subset: version-v2</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This must be set to 'mirror'</td></tr></tbody></table></div><div class=paragraph><p>Apply the change</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc apply -f VitualService_mirrored-traffic.yaml</code></pre></div></div><div class=paragraph><p>Now lets open and follow the logs of recommandation-v2 in order to see that traffic will reach this service, but responses are ignored:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc logs -f $(oc get pods|grep recommendation-v2|awk &#39;{ print $1 }&#39;) -c recommendation</code></pre></div></div><div class=paragraph><p>In a second terminal window send some traffic to our service.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 100 $GATEWAY_URL</code></pre></div></div><div class=paragraph><p>You will see that only v1 answers, while in the 2nd window, v2 gets the same traffic.</p></div></div><div class=sect2><h3 id=_load_balancing>Load Balancing</h3><div class=paragraph><p>In the default OpenShift environment the kube-proxy forwards all requests to pods randomly. With Red Hat ServiceMesh it is possible to add more complexity and let the Envoy proxy handle load balancing for your services.</p></div><div class=paragraph><p>Three methods are supported:</p></div><div class=ulist><ul><li><p>random</p></li><li><p>round-robin</p></li><li><p>least connection</p></li></ul></div><div class=paragraph><p>The round robin function is used by default, when there is no DestinationRule configured. We can use the DestinationRule to use the least connection option to see how the traffic is sent.</p></div><div class=paragraph><p>Before we start we need to delete the VirtualService for the recommendation microservice</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc delete virtualservice recommendation</code></pre></div></div><div class=paragraph><p>The we scale version v2 to 3:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc scale deployment recommendation-v2 --replicas=3</code></pre></div></div><div class=paragraph><p>After a few seconds the folling pods should run now:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>NAME                                 READY   STATUS    RESTARTS   AGE
customer-6948b8b959-jdjlg            2/2     Running   1          25h
preference-v1-7fdb89c86b-nktqn       2/2     Running   0          25h
recommendation-v1-69db8d6c48-h8brv   2/2     Running   0          25h
recommendation-v2-6c5b86bbd8-6lgz6   2/2     Running   0          91s
recommendation-v2-6c5b86bbd8-dnc8b   2/2     Running   0          91s
recommendation-v2-6c5b86bbd8-jnk8b   2/2     Running   0          24h</code></pre></div></div><div class=paragraph><p>If you send traffic to the application, you would see that 3 quarter are sent to v1 and one is sent to v1.</p></div><div class=paragraph><p>With the following DestinationRule the traffic will be sent randomly to the application</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendation
spec:
  host: recommendation
  trafficPolicy:
      loadBalancer:
        simple: RANDOM</code></pre></div></div><div class=paragraph><p>If you now sent traffic to the service, you will see that the traffic is sent randomly to the versions. (verify the serial number)</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 100 $GATEWAY_URL

# 140: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 5729
# 141: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 7119
# 142: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 361
# 143: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 362
# 144: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 5730
# 145: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 362
# 146: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 7120
# 147: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 7121
# 148: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 363
...</code></pre></div></div></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic"><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> Limit Egress/External Traffic</a>
<a class="nav-next btn btn-default" href=/service-mesh/2020/04/routing-example/ title="Routing Example" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Routing Example</a></div><div class=copyright><p>Copyright &copy; 2020 - 2023 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><script>(function(){$("document").ready(function(){var s=$(".read-progress").waypoint({handler:function(e){e=="down"?($(".read-progress").addClass("position-fixed"),$(".read-progress").css("top",0)):($(".read-progress").removeClass("position-fixed"),$(".read-progress").css("top"))}}),t=$(window).height(),e=$(".post-content").height();$(window).on("scroll",n),$(window).on("resize",function(){t=$(window).height(),e=$(".post-content").height(),n()});function n(){var s=$(this).scrollTop(),o=$(".post-content").offset().top,i=e-(e-(t-(o-s))),n=i/e*100,n=n>100?100:n;$(".read-progress").width(n+"%")}})})()</script><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1689582124></script>
<script src=/js/perfect-scrollbar.min.js?1689582124></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1689582124></script>
<script src=/js/jquery.sticky.js?1689582124></script>
<script src=/js/featherlight.min.js?1689582124></script>
<script src=/js/highlight.pack.js?1689582124></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1689582124></script>
<script src=/js/learn.js?1689582124></script>
<script src=/js/hugo-learn.js?1689582124></script>
<script src=/js/yaub.js?1689582124></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script></body></html>