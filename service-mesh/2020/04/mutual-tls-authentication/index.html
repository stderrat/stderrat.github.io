<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="OpenShift 4.x and Service Mesh/Istio Tutorial 9 - Mutual TLS/mTLS Authentication"><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Mutual TLS Authentication :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1657805797 rel=stylesheet><link href=/css/fontawesome-all.min.css?1657805797 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1657805797 rel=stylesheet><link href=/css/hybrid.css?1657805797 rel=stylesheet><link href=/css/featherlight.min.css?1657805797 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1657805797 rel=stylesheet><link href=/css/auto-complete.css?1657805797 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1657805797 rel=stylesheet><link href=/css/theme.min.css?1657805797 rel=stylesheet><link href=/css/hugo-theme.css?1657805797 rel=stylesheet><link href=/css/theme-yaub.css?1657805797 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1657805797></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/service-mesh/2020/04/mutual-tls-authentication/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1657805797></script>
<script type=text/javascript src=/js/auto-complete.js?1657805797></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1657805797></script></div><div class=togglemode><button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class=dd-item><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2021-11-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2021-11-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2021-11-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2021-11-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class="dd-item
parent"><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class="dd-item active"><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/archive/ title=Archive class=dd-item><a href=/archive/>Archive</a></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://blog.stderr.at/tags><i class='fas fa-tags'></i> Tags</a></li><li><a class=padding href=https://blog.stderr.at/categories><i class='far fa-bookmark'></i> Catagories</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_how_does_it_work>How does it work?</a></li><li><a href=#_preparations>Preparations</a></li><li><a href=#_enabling_mutual_tls>Enabling Mutual TLS</a></li><li><a href=#_mutual_tls_migration>Mutual TLS Migration</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav><div id=navigation><a class=nav-prev href=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT"><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/service-mesh/2020/04/fault-injection/ title="Fault Injection" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/service-mesh/><span itemprop=name>Service Mesh</span><meta itemprop=position content="2"></a></span>> Mutual TLS Authentication</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_how_does_it_work>How does it work?</a></li><li><a href=#_preparations>Preparations</a></li><li><a href=#_enabling_mutual_tls>Enabling Mutual TLS</a></li><li><a href=#_mutual_tls_migration>Mutual TLS Migration</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/istio>Istio</a>
<a class=tag-link href=/tags/service-mesh>Service Mesh</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/mtls>mTLS</a></div></div><div id=body-inner><h1>Mutual TLS Authentication</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2020-04-08T00:00:00Z><strong>April 8, 2020</strong></time>
- By:
Thomas Jungbauer
( Lastmod: 2021-08-14 )</p><div class=paragraph><p>When more and more microservices are involved in an application, more and more traffic is sent on the network. It should be considered to secure this traffic, to prevent the possibility to inject malicious packets. Mutual TLS/mTLS authentication or two-way authentication offers a way to encrypt service traffic with certificates.</p></div><div class=paragraph><p>With Red Hat OpenShift Service Mesh, Mutual TLS can be used without the microservice knowing that it is happening. The TLS is managed completely by the Service Mesh Operator between two Envoy proxies using a defined mTLS policy.</p></div><div class=paragraph><p>Issue 9 of <strong>OpenShift 4 and Service Mesh</strong> will explain how to enable Mutual TLS inside the Service Mesh to secure the traffic between the different microservices.</p></div><div class=sect1><h2 id=_how_does_it_work>How does it work?</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>If a microservice sends a request to a server, it must pass the local sidecar Envoy proxy first.</p></li><li><p>The proxy will intercept the outbound request and starts a mutual TLS handshake with the proxy at the server side. During this handshake the certificates are exchanged and loaded into the proxy containers by Service Mesh.</p></li><li><p>The client side Envoy starts a mutual TLS handshake with the server side Envoy.</p></li><li><p>The client proxy does a secure naming check on the server’s certificate to verify that the identity in the certificate is authorized.</p></li><li><p>A mutual TLS connection is established between the client and the server.</p></li><li><p>The Envoy proxy at the server sides decrypts the traffic and forwards it to the application through a local TCP connection.</p></li></ol></div></div></div><div class=sect1><h2 id=_preparations>Preparations</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>Before we can start be sure that the services are setup like in <a href=/service-mesh/2020/03/ingress-traffic/>Issue #3</a>.<br>In addition, be sure that the following DestinationRule already exists:</p><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendation
spec:
  host: recommendation
  subsets:
  - labels:
      version: v1
    name: version-v1
  - labels:
      version: v2
    name: version-v2</code></pre></div></div></li><li><p>Now we will create a pod, which is running outside of the Service Mesh. It will not have a sidecar proxy and will simply curl our application.</p><div class=paragraph><p>Store the following yaml and create the object in our cluster.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: curl
    version: v1
  name: curl
spec:
  replicas: 1
  selector:
    matchLabels:
      app: curl
      version: v1
  template:
    metadata:
      labels:
        app: curl
        version: v1
      annotations: <i class=conum data-value=1></i><b>(1)</b>
        sidecar.istio.io/proxyCPU: &#34;500m&#34;
        sidecar.istio.io/proxyMemory: 400Mi
    spec:
      containers:
      - image: quay.io/maistra_demos/curl:latest
        command: [&#34;/bin/sleep&#34;, &#34;3650d&#34;]
        imagePullPolicy: Always
        name: curl</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>since no sidecar is injected (sidecar.istio.io/inject: "true"), only 1 container will be started.</td></tr></tbody></table></div></li></ol></div><div class=paragraph><p>The traffic coming from the microservice <em>customer</em> AND from the external client <em>curl</em> must be simulated. To achieve this the following shell script can be used:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>#!/bin/sh

export CURL_POD=$(oc get pods -n tutorial -l app=curl | grep curl | awk &#39;{ print $1}&#39; )
export CUSTOMER_POD=$(oc get pods -n tutorial -l app=customer | grep customer | awk &#39;{ print $1}&#39; )

echo &#34;A load generating script is running in the next step. Ctrl+C to stop&#34;

while :; do

echo &#34;Executing curl in curl pod&#34;
oc exec -n tutorial $CURL_POD -- curl -s http://preference:8080 &gt; /dev/null
sleep 0.5

echo &#34;Executing curl in customer pod&#34;
oc exec -n tutorial $CUSTOMER_POD -c customer -- curl -s http://preference:8080 &gt; /dev/null

sleep 0.5

done</code></pre></div></div><div class=paragraph><p>By executing this, it will first execute a curl command out of the <em>curl</em> pod and then the same curl command out of the <em>customer</em> container.
<strong>Kepp this script running</strong></p></div></div></div><div class=sect1><h2 id=_enabling_mutual_tls>Enabling Mutual TLS</h2><div class=sectionbody><div class=paragraph><p>Lets execute the shell script above and verify Kiali. As you notice there are requests coming from the <em>customer</em> microservice and from the source called <em>unknown</em>, which is the curl-service running outside the Service Mesh.</p></div><div class=imageblock><div class=content><img src=/service-mesh/images/Kiali-mtls_1.png alt="Kiali mtls 1"></div><div class=title>Figure 1. Kiali: traffic coming from customer microserver and external pod</div></div><div class=paragraph><p>Enable the policy by creating the following object:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: &#34;authentication.istio.io/v1alpha1&#34;
kind: &#34;Policy&#34;
metadata:
  name: &#34;preference-mutualtls&#34;
spec:
  targets:
  - name: preference
  peers:
  - mtls:
      mode: STRICT <i class=conum data-value=1></i><b>(1)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>We are enforcing mtls for the target preference</td></tr></tbody></table></div><div class=paragraph><p>After a few seconds the curl pod cannot reach the application anymore:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>Executing curl in curl pod
command terminated with exit code 56
Executing curl in customer pod
Executing curl in curl pod
command terminated with exit code 56
Executing curl in customer pod
Executing curl in curl pod
command terminated with exit code 5</code></pre></div></div><div class=paragraph><p>This is expected, since the <em>preference</em> service allows traffic over mutual TLS only. This was enforced by the Policy object (<strong>STRICT</strong> mode). The <em>customer</em> service, which is running inside the Service Mesh receives the error "5053 Service Unavalable" since it tries to send traffic, but it does not know yet to use mTLS.</p></div><div class=paragraph><p>In Kiali you will see the following:</p></div><div class=imageblock><div class=content><img src=/service-mesh/images/Kiali-mtls_2.png alt="Kiali mtls 2"></div><div class=title>Figure 2. Kiali: traffic is blocked</div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>The <em>curl</em> pod is greyed out, since the traffic it tries to send, never reaches the preference service and is therefor not counted in the metric.</td></tr></tbody></table></div><div class=paragraph><p>To make <em>customer</em> aware that mutual TLS shall be used, a DestinationRule must be configured:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: &#34;networking.istio.io/v1alpha3&#34;
kind: &#34;DestinationRule&#34;
metadata:
  name: &#34;preference-destination-rule&#34;
spec:
  host: &#34;preference&#34;
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL <i class=conum data-value=1></i><b>(1)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Let’s use mTLS</td></tr></tbody></table></div><div class=paragraph><p>This defines that <strong>ISTIO_MUTUAL</strong> shall be used for the service <em>preference</em>. The <em>customer</em> service recognizes this and automatically enables mTLS. After a few minutes the traffic graph in Kiali will show "green" traffic from <em>customer</em> through <em>preference</em> to _recommendation:</p></div><div class=imageblock><div class=content><img src=/service-mesh/images/Kiali-mtls_3.png alt="Kiali mtls 3"></div><div class=title>Figure 3. Kiali: traffic for Service Mesh components is fine again.</div></div><hr></div></div><div class=sect1><h2 id=_mutual_tls_migration>Mutual TLS Migration</h2><div class=sectionbody><div class=paragraph><p>As you can see in the previous section, the <em>curl</em> pod cannot reach the application inside the Service Mesh. This happens because <em>prefernce</em> is strictly enforcing encrypted traffic, but <em>curl</em> only sends plain text. Luckily, Istio provides a method to gradually monitor the traffic and migrate to mTLS. Instead of STRICT mode PERMISSIVE can be used. Enabling permissive mode, <em>preference</em> will accept both, encrypted and plain-text traffic.</p></div><div class=paragraph><p>Replace the Policy object with the following configuration:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: &#34;authentication.istio.io/v1alpha1&#34;
kind: &#34;Policy&#34;
metadata:
  name: &#34;preference-mutualtls&#34;
spec:
  targets:
  - name: preference
  peers:
  - mtls:
      mode: PERMISSIVE</code></pre></div></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc replace -f Policy-permissive.yaml</code></pre></div></div><div class=paragraph><p>Now let’s wait a few minutes and observe Kiali, which should end up with:</p></div><div class=imageblock><div class=content><img src=/service-mesh/images/Kiali-mtls_4.png alt="Kiali mtls 4"></div><div class=title>Figure 4. Kiali: Encrypted and Plain-Text traffic</div></div><div class=paragraph><p>As you can see with the lock icon, the traffic between <em>cunstomer</em> and <em>preference</em> is encrypted, while the traffic from <em>unknown</em> (which is our curl pod), is plain-text.</p></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>The errors you may see in Kiali happen due a known issue: <a href=https://issues.jboss.org/browse/MAISTRA-1000 class=bare>https://issues.jboss.org/browse/MAISTRA-1000</a></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_cleanup>Cleanup</h2><div class=sectionbody><div class=paragraph><p>Clean up your environment:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc delete policy -n tutorial preference-mutualtls
oc delete destinationrule -n tutorial preference-destination-rule</code></pre></div></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT"><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> Authentication JWT</a>
<a class="nav-next btn btn-default" href=/service-mesh/2020/04/fault-injection/ title="Fault Injection" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Fault Injection</a></div><div class=copyright><p>Copyright &copy; 2020 - 2022 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1657805802></script>
<script src=/js/perfect-scrollbar.min.js?1657805802></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1657805802></script>
<script src=/js/jquery.sticky.js?1657805802></script>
<script src=/js/featherlight.min.js?1657805802></script>
<script src=/js/highlight.pack.js?1657805802></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1657805802></script>
<script src=/js/learn.js?1657805802></script>
<script src=/js/hugo-learn.js?1657805802></script>
<script src=/js/yaub.js?1657805802></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script><script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){if(prefersDarkScheme.matches){document.body.classList.toggle("light-theme");var e=document.body.classList.contains("light-theme")?"light":"dark"}else document.body.classList.toggle("dark-theme"),e=document.body.classList.contains("dark-theme")?"dark":"light";localStorage.setItem("theme",e)})</script></body></html>