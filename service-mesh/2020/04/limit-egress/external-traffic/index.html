<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI">
<meta charset=utf-8>
<meta name=color-scheme content="dark light">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.87.0">
<meta name=description content="OpenShift 4.x and Service Mesh/istio Tutorial 7 - Test and control your egress/external traffic.">
<meta name=author content="Toni Schmidbauer & Thomas Jungbauer">
<link rel=icon href=/images/favicon.ico type=image/png>
<link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png>
<link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png>
<link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png>
<link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png>
<link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png>
<link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png>
<link rel="shortcut icon" href=/images/favicon.ico>
<link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png>
<link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<title>Limit Egress/External Traffic :: TechBlog about OpenShift/Ansible/Satellite and much more</title>
<link rel=manifest href=/manifest.json>
<meta name=theme-color content="#317EFB">
<link href=/css/nucleus.min.css?1648545785 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1648545785 rel=stylesheet>
<link href=/css/font-awesome-animation.min.css?1648545785 rel=stylesheet>
<link href=/css/hybrid.css?1648545785 rel=stylesheet>
<link href=/css/featherlight.min.css?1648545785 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1648545785 rel=stylesheet>
<link href=/css/auto-complete.css?1648545785 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1648545785 rel=stylesheet>
<link href=/css/theme.min.css?1648545785 rel=stylesheet>
<link href=/css/hugo-theme.css?1648545785 rel=stylesheet>
<link href=/css/theme-yaub.css?1648545785 rel=stylesheet>
<script src=/js/jquery-3.6.0.min.js?1648545785></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
</head>
<body data-url=/service-mesh/2020/04/limit-egress/external-traffic/>
<button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/>
<p class="fa fa-cloud-upload-alt faa-float animated"></p>
<span class=text>YAUB</span>
<p class=logoarea><span class="text small">Yet another Useless Blog</span></p>
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1648545785></script>
<script type=text/javascript src=/js/auto-complete.js?1648545785></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script>
<script type=text/javascript src=/js/search.js?1648545785></script>
</div>
<div class=togglemode>
<button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button>
</div>
<section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Home</a>
</li>
</ul>
</section>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/openshift/ title=OpenShift class=dd-item>
<a href=/openshift/>
OpenShift
</a>
<ul>
<li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item>
<a href=/openshift/2021-09-25-sealed_secrets/>
Secure your secrets with Sealed Secrets
</a>
</li>
<li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item>
<a href=/openshift/2021-02-27-understanding-block-devices/>
Understanding RWO block device handling in OpenShift
</a>
</li>
<li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item>
<a href=/openshift/2021-01-27-writingoperatoransible/>
Writing Operator using Ansible
</a>
</li>
<li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item>
<a href=/openshift/2020-12-10-thanos-vs-thanos/>
Thanos Querier vs Thanos Querier
</a>
</li>
<li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item>
<a href=/openshift/2020-08-06-argocd/>
GitOps - Argo CD
</a>
</li>
<li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item>
<a href=/openshift/2020-04-16-tekton/>
OpenShift Pipelines - Tekton Introduction
</a>
</li>
<li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item>
<a href=/openshift/2020-04-01-oc-commands/>
Helpful oc / kubectl commands
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item>
<a href=/day-2/>
OpenShift Day-2
</a>
<ul>
<li data-nav-id=/day-2/etcd/ title=etcd class=dd-item>
<a href=/day-2/etcd/>
etcd
</a>
<ul>
<li data-nav-id=/day-2/etcd/2021-11-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item>
<a href=/day-2/etcd/2021-11-29-automatedetcdbackup/>
Automated ETCD Backup
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item>
<a href=/day-2/labels_environmets/>
Labels & Environments
</a>
<ul>
<li data-nav-id=/day-2/labels_environmets/2021-11-12-creatingenvironment/ title="Working with Environments" class=dd-item>
<a href=/day-2/labels_environmets/2021-11-12-creatingenvironment/>
Working with Environments
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item>
<a href=/day-2/pod-placement/>
Pod Placement
</a>
<ul>
<li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item>
<a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>
Introduction
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-29-node-affinity/>
Node Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item>
<a href=/day-2/pod-placement/2021-08-27-podplacement/>
NodeSelector
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-28-affinity/>
Pod Affinity/Anti-Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item>
<a href=/day-2/pod-placement/2021-08-30-taints/>
Taints and Tolerations
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item>
<a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>
Topology Spread Constraints
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item>
<a href=/day-2/pod-placement/2021-09-01-descheduler/>
Using Descheduler
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/compliance/ title=Compliance class=dd-item>
<a href=/compliance/>
Compliance
</a>
<ul>
<li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item>
<a href=/compliance/2021/07/oc-compliance-command-line-plugin/>
oc compliance command line plugin
</a>
</li>
<li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item>
<a href=/compliance/2021/07/compliance-operator/>
Compliance Operator
</a>
</li>
</ul>
</li>
<li data-nav-id=/service-mesh/ title="Service Mesh" class="dd-item
parent">
<a href=/service-mesh/>
Service Mesh
</a>
<ul>
<li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item>
<a href=/service-mesh/2020/05/enable-automatic-route-creation/>
Enable Automatic Route Creation
</a>
</li>
<li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item>
<a href=/service-mesh/2020/05/authorization-rbac/>
Authorization (RBAC)
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item>
<a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>
Deploy Example Bookinfo Application
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item>
<a href=/service-mesh/2020/04/service-mesh-1.1-released/>
Service Mesh 1.1 released
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item>
<a href=/service-mesh/2020/04/authentication-jwt/>
Authentication JWT
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item>
<a href=/service-mesh/2020/04/mutual-tls-authentication/>
Mutual TLS Authentication
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item>
<a href=/service-mesh/2020/04/fault-injection/>
Fault Injection
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class="dd-item active">
<a href=/service-mesh/2020/04/limit-egress/external-traffic/>
Limit Egress/External Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/advanced-routing-example/>
Advanced Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/routing-example/>
Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item>
<a href=/service-mesh/2020/03/ingress-with-custom-domain/>
Ingress with custom domain
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item>
<a href=/service-mesh/2020/03/ingress-traffic/>
Ingress Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item>
<a href=/service-mesh/2020/03/deploy-microservices/>
Deploy Microservices
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item>
<a href=/service-mesh/2020/03/installation/>
Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/general/ title=General class=dd-item>
<a href=/general/>
General
</a>
<ul>
<li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item>
<a href=/general/2020/05/basic-usage-of-git/>
Basic usage of git
</a>
</li>
<li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item>
<a href=/general/2020/04/red-hat-satellite-cheat-sheet/>
Red Hat Satellite Cheat Sheet
</a>
</li>
</ul>
</li>
<li data-nav-id=/ansible/ title=Ansible class=dd-item>
<a href=/ansible/>
Ansible
</a>
<ul>
<li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item>
<a href=/ansible/2021/11/ansible-style-guide/>
Ansible Style Guide
</a>
</li>
<li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item>
<a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>
Automation Controller and LDAP Authentication
</a>
</li>
<li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item>
<a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>
Ansible Tower and downloading collections
</a>
</li>
<li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item>
<a href=/ansible/2020/04/ansible-azure-resource-manager-example/>
Ansible - Azure Resource Manager Example
</a>
</li>
<li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item>
<a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>
DO410 Ansible and Ansible Tower training notes
</a>
</li>
</ul>
</li>
<li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item>
<a href=/acs/>
Advanced Cluster Security
</a>
<ul>
<li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item>
<a href=/acs/2021-12-11-acsauth/>
Advanced Cluster Security - Authentication
</a>
</li>
</ul>
</li>
<li data-nav-id=/azure/ title=Azure class=dd-item>
<a href=/azure/>
Azure
</a>
<ul>
<li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item>
<a href=/azure/2021-10-29-private-aro/>
Stumbling into Azure Part II: Setting up a private ARO cluster
</a>
</li>
<li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item>
<a href=/azure/2021-10-17-s2s-vpn/>
Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing
</a>
</li>
</ul>
</li>
<li data-nav-id=/java/ title=Java class=dd-item>
<a href=/java/>
Java
</a>
<ul>
<li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item>
<a href=/java/2022-02-25-jpa-disconnected-entity/>
Adventures in Java Land: JPA disconnected entities
</a>
</li>
</ul>
</li>
<li data-nav-id=/quay/ title=Quay class=dd-item>
<a href=/quay/>
Quay
</a>
<ul>
<li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item>
<a href=/quay/2021-09-07-quay-upgrade-3.4/>
Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator
</a>
</li>
<li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item>
<a href=/quay/2020-05-13-quay-tutorial1/>
Red Hat Quay Registry - Overview and Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/archive/ title=Archive class=dd-item>
<a href=/archive/>
Archive
</a>
</li>
<li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item>
<a href=/legaldisclosure/>
Legal Disclosure
</a>
</li>
<li data-nav-id=/rss/ title="RSS Feeds" class=dd-item>
<a href=/rss/>
RSS Feeds
</a>
</li>
</ul>
<section id=shortcuts>
<h3 class=shortcut-title>More</h3>
<ul>
<li>
<a class=padding href=https://blog.stderr.at/tags><i class="fas fa-tags"></i> Tags</a>
</li>
<li>
<a class=padding href=https://blog.stderr.at/categories><i class="far fa-bookmark"></i> Catagories</a>
</li>
<li>
<a class=padding href=https://www.redhat.com><i class="fab fa-redhat"></i> Red Hat</a>
</li>
</ul>
</section>
<section id=footer>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<aside id=toc-field class="hidden lg:block tableOfContentContainer">
<header id=TableOfContentsHeader>What's on this Page</header>
<nav id=TableOfContents>
<ul>
<li><a href=#_preparation>Preparation</a></li>
<li><a href=#_setup_recommendation_v3>Setup <em>recommendation-v3</em></a>
<ul>
<li><a href=#_fixing_missing_proxy_sidecar_container>Fixing missing proxy sidecar container</a></li>
</ul>
</li>
<li><a href=#_create_destinationrule_and_virtualservice>Create DestinationRule and VirtualService</a></li>
<li><a href=#_test_egress_traffic>Test egress traffic</a></li>
<li><a href=#_limitcontrol_external_access>Limit/Control external access</a>
<ul>
<li><a href=#_fix_serviceentry>Fix ServiceEntry</a></li>
</ul>
</li>
<li><a href=#_verify_kiali>Verify Kiali</a></li>
<li><a href=#_optional_disallow_any_connections>OPTIONAL: Disallow ANY connections</a></li>
</ul>
</nav>
<div id=navigation>
<a class=nav-prev href=/service-mesh/2020/04/fault-injection/ title="Fault Injection"> <i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</aside>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/> <span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span> > <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/service-mesh/> <span itemprop=name>Service Mesh</span><meta itemprop=position content="2"></a></span> > Limit Egress/External Traffic
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#_preparation>Preparation</a></li>
<li><a href=#_setup_recommendation_v3>Setup <em>recommendation-v3</em></a>
<ul>
<li><a href=#_fixing_missing_proxy_sidecar_container>Fixing missing proxy sidecar container</a></li>
</ul>
</li>
<li><a href=#_create_destinationrule_and_virtualservice>Create DestinationRule and VirtualService</a></li>
<li><a href=#_test_egress_traffic>Test egress traffic</a></li>
<li><a href=#_limitcontrol_external_access>Limit/Control external access</a>
<ul>
<li><a href=#_fix_serviceentry>Fix ServiceEntry</a></li>
</ul>
</li>
<li><a href=#_verify_kiali>Verify Kiali</a></li>
<li><a href=#_optional_disallow_any_connections>OPTIONAL: Disallow ANY connections</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
<div class=tags>
<a class=tag-link href=/tags/istio>Istio</a>
<a class=tag-link href=/tags/service-mesh>Service Mesh</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/egress>Egress</a>
</div>
</div>
<div id=body-inner>
<h1>
Limit Egress/External Traffic
</h1>
<p class=tracked>
<time class="f6 mv4 dib tracked" datetime=2020-04-06T00:00:00Z>
<strong>April 6, 2020</strong>
</time>
- By:
Thomas Jungbauer
( Lastmod: 2021-08-14 )
</p>
<div class=paragraph>
<p>Sometimes services are only available from outside the OpenShift cluster (like external API) which must be reached. Part 7 of <strong>OpenShift 4 and Service Mesh</strong> takes care and explains how to control the egress or external traffic. All operations have been successdully tested on OpenShift 4.3.</p>
</div>
<div class=sect1>
<h2 id=_preparation>Preparation</h2>
<div class=sectionbody>
<div class=paragraph>
<p>Before this tutorial can be started, ensure that 3 microservices are deployed (recommendation may have 2 versions) and that the objects Gateway and VirtualService are configured. The status should be like in <a href=/service-mesh/2020/03/ingress-with-custom-domain/>Issue #4..6</a></p>
</div>
<div class=paragraph>
<p>You can verify this the following way:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>export GATEWAY_URL=$(oc -n istio-system get route istio-ingressgateway -o jsonpath=&#39;{.spec.host}&#39;)
curl $GATEWAY_URL</code></pre>
</div>
</div>
<div class=paragraph>
<p>which should simply print:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 7123</code></pre>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_setup_recommendation_v3>Setup <em>recommendation-v3</em></h2>
<div class=sectionbody>
<div class=paragraph>
<p>We need to deploy version 3 of our recommendation microservice. This will perform an external API call to <a href=http://worldclockapi.com class=bare>http://worldclockapi.com</a> to retrieve the current time.</p>
</div>
<div class=paragraph>
<p>To deploy the Deployment v3:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>cd ~/istio-tutorial/recommendation
oc apply -f kubernetes/Deployment-v3.yml -n tutorial</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-warning" title=Warning></i>
</td>
<td class=content>
If you list the pods at this moment, you will see that only one container (Ready 1/1) is started. This happens because the Deployment yaml file is missing an annotation.
</td>
</tr>
</tbody></table>
</div>
<div class=sect2>
<h3 id=_fixing_missing_proxy_sidecar_container>Fixing missing proxy sidecar container</h3>
<div class=paragraph>
<p>After you applied the Deployment-v3.yml, only 1 container is started. The proxy sidecar is not injected, because an annotation is missing in the configuration for the Deployment.</p>
</div>
<div class=paragraph>
<p>To fix this use the following command:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc patch deployment recommendation-v3 -n tutorial -p &#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;sidecar.istio.io/inject&#34;:&#34;true&#34;}}}}}&#39;</code></pre>
</div>
</div>
<div class=paragraph>
<p>This will automatically restart the pod with 2 containers.</p>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_create_destinationrule_and_virtualservice>Create DestinationRule and VirtualService</h2>
<div class=sectionbody>
<div class=paragraph>
<p>Use the following definition to create (overwrite) the DestinationRule for recommendation-v3.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendation
spec:
  host: recommendation
  subsets:
  - labels:
      version: v3
    name: version-v3</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
Only version 3 is used for now. The other versions are still there, but ignored for our tests.
</td>
</tr>
</tbody></table>
</div>
<div class=paragraph>
<p>Apply the change</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc apply -f DestinationRule_v3.yaml</code></pre>
</div>
</div>
<div class=paragraph>
<p>Define the VirtualService and send 100% of the traffic to v3 of the recommendation microservice.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v3
      weight: 100</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
As an alternative, you can also edit the existing VirtualService and add the section for version-v3 with a weight of 100, while changing the weight of v1 and v2 to 0.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_test_egress_traffic>Test egress traffic</h2>
<div class=sectionbody>
<div class=paragraph>
<p>As usual we test our application by sending traffic to it. The following command should print successful connection requests:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 1000 $GATEWAY_URL</code></pre>
</div>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash># 0: customer =&gt; preference =&gt; recommendation v3 2020-04-06T18:31+02:00 from &#39;83bbb6d11a7e&#39;: 1
# 1: customer =&gt; preference =&gt; recommendation v3 2020-04-06T18:31+02:00 from &#39;83bbb6d11a7e&#39;: 2
# 2: customer =&gt; preference =&gt; recommendation v3 2020-04-06T18:31+02:00 from &#39;83bbb6d11a7e&#39;: 3
# 3: customer =&gt; preference =&gt; recommendation v3 2020-04-06T18:31+02:00 from &#39;83bbb6d11a7e&#39;: 4
# 4: customer =&gt; preference =&gt; recommendation v3 2020-04-06T18:31+02:00 from &#39;83bbb6d11a7e&#39;: 5</code></pre>
</div>
</div>
<div class=paragraph>
<p>As you can see 100% of the traffic is sent to v3 <strong>AND</strong> a new field enters the output. The current time is now shown as well. The information for this field is fetched with an external API call to <a href=http://worldclockapi.com class=bare>http://worldclockapi.com</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
The traffic is simply sent to an external destination. There is not limit yet. Readers of the Istio documentation will miss the object <strong>ServiceEntry</strong> which somebody should think is required. However, Openshift is currently(?) configured in a way to simply allow ANY traffic. This is defined in a ConfigMap which might be changed to modify the default behavior. However, as soon as ServiceEntry and the appropriate VirtualService is configured, the traffic will be limited as well.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_limitcontrol_external_access>Limit/Control external access</h2>
<div class=sectionbody>
<div class=paragraph>
<p>As you can see above you can simply send egress traffic without any control about what is allowed or not. In order to limit your outgoing traffic a new object called <strong>ServiceEntry</strong> must be defined as well as a change in your <strong>VirtualService</strong> will be required.</p>
</div>
<div class=paragraph>
<p>Define the ServiceEntry and apply it to your cluster:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: worldclockapi-egress-rule
spec:
  hosts:
  - worldclockapi.com
  ports:
  - name: http-80
    number: 81 <i class=conum data-value=1></i><b>(1)</b>
    protocol: http</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>Wrong port 81 is set on purpose for demonstration</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
The port <strong>number: 81</strong> is set on purpose, to prove that the traffic will not work with a wrong ServiceEntry.
</td>
</tr>
</tbody></table>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc create -f ServiceEntry.yaml</code></pre>
</div>
</div>
<div class=paragraph>
<p>To actually limit the traffic a link between the ServiceEntry and a VirtualService, which defines the external destination, must be created. Moreover, a timeout is set for possible connection errors, to keep the application responding even when the external API is down.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: worldclockapi-timeout <i class=conum data-value=1></i><b>(1)</b>
spec:
  hosts:
    - worldclockapi.com <i class=conum data-value=2></i><b>(2)</b>
  http:
  - timeout: 3s <i class=conum data-value=3></i><b>(3)</b>
    route:
      - destination:
          host: worldclockapi.com
        weight: 100 <i class=conum data-value=4></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>The name of the object</td>
</tr>
<tr>
<td><i class=conum data-value=2></i><b>2</b></td>
<td>The external hostname we want to reach</td>
</tr>
<tr>
<td><i class=conum data-value=3></i><b>3</b></td>
<td>The timeout setting in seconds</td>
</tr>
<tr>
<td><i class=conum data-value=4></i><b>4</b></td>
<td>The destination route, which is sending 100% of the external traffic to the host above</td>
</tr>
</tbody></table>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc apply -f VirtualService-worldclockapi.yaml</code></pre>
</div>
</div>
<div class=paragraph>
<p>If you now run a connection test you will still get an error.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 1 $GATEWAY_URL

# customer =&gt; Error: 503 - preference =&gt; Error: 500 ...</code></pre>
</div>
</div>
<div class=sect2>
<h3 id=_fix_serviceentry>Fix ServiceEntry</h3>
<div class=paragraph>
<p>This happens, because we misconfigured the ServiceEntry on purpose to demonstrate that the traffic is sent to worldclockapi.com:80.</p>
</div>
<div class=paragraph>
<p>Fix the ServiceEntry object and apply to your cluster:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: worldclockapi-egress-rule
spec:
  hosts:
  - worldclockapi.com
  ports:
  - name: http-80
    number: 80 <i class=conum data-value=1></i><b>(1)</b>
    protocol: http</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>Changed from 81 to 80</td>
</tr>
</tbody></table>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc apply -f ServiceEntry.yaml</code></pre>
</div>
</div>
<div class=paragraph>
<p>Now the traffic should work and gives you back a connection to microservice and a current time:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 10 $GATEWAY_URL

# 0: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 138
# 1: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 139
# 2: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 140
# 3: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 141
# 4: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 142
# 5: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 143
# 6: customer =&gt; preference =&gt; recommendation v3 2020-04-07T07:47+02:00 from &#39;83bbb6d11a7e&#39;: 144</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_verify_kiali>Verify Kiali</h2>
<div class=sectionbody>
<div class=imageblock>
<div class=content>
<img src="/service-mesh/images/Kiali_with_external_service.png?width=940px&height=250px" alt="Kiali with external service">
</div>
<div class=title>Figure 1. Kiali shows traffic to the external service</div>
</div>
<hr>
</div>
</div>
<div class=sect1>
<h2 id=_optional_disallow_any_connections>OPTIONAL: Disallow ANY connections</h2>
<div class=sectionbody>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-warning" title=Warning></i>
</td>
<td class=content>
This is a change in the default ConfigMap of the ServiceMesh. Do this on your own risk and always consult the latest documentation of OCP.
</td>
</tr>
</tbody></table>
</div>
<div class=paragraph>
<p>As explained above, we are able to connect to an external service without any limitation. The ServiceEntry object together with the VirtualService define the actual destination and would disallow traffic if they are wrongly configured, but if you forget these entries, it would still be possible to establish an egress connection.</p>
</div>
<div class=paragraph>
<p>In OpenShift a ConfigMap in the <em>istio-system</em> namespace defines the default behavior. There are two possibilities:</p>
</div>
<div class=ulist>
<ul>
<li>
<p>ALLOW_ANY - outbound traffic to unknown destinations will be allowed, in case there are no services or ServiceEntries for the destination port</p>
</li>
<li>
<p>REGISTRY_ONLY - restrict outbound traffic to services defined in the service registry as well</p>
<div class="olist arabic">
<ol class=arabic>
<li>
<p>Let’s Cleanup the ServiceEntry and the VirtualService which have been created above</p>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc delete serviceentry worldclockapi-egress-rule
serviceentry.networking.istio.io &#34;worldclockapi-egress-rule&#34; deleted

oc delete virtualservice worldclockapi-timeout
virtualservice.networking.istio.io &#34;worldclockapi-timeout&#34; deleted</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
Now traffic to the external service will be allowed again
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Modify the ConfigMap <em>istio</em> in the namespace <em>istio-system</em></p>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc get configmap istio -n istio-system -o yaml | sed &#39;s/mode: ALLOW_ANY/mode: REGISTRY_ONLY/g&#39; | oc replace -n istio-system -f -</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class=paragraph>
<p>Wait a few seconds and try to connect. You will see that the connection is not possible anymore.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
If you now re-create the <strong>ServiceEntry</strong> the connection will be possible again, since the service is registered to the Service Mesh.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation-bottom>
<a class="nav-prev btn btn-default" href=/service-mesh/2020/04/fault-injection/ title="Fault Injection"> <i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous: </span> Fault Injection</a>
<a class="nav-next btn btn-default" href=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Advanced Routing Example</a>
</div>
<div class=copyright>
<p>Copyright &copy; 2020 - 2022 Toni Schmidbauer & Thomas Jungbauer</p>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1648545790></script>
<script src=/js/perfect-scrollbar.min.js?1648545790></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1648545790></script>
<script src=/js/jquery.sticky.js?1648545790></script>
<script src=/js/featherlight.min.js?1648545790></script>
<script src=/js/highlight.pack.js?1648545790></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1648545790></script>
<script src=/js/learn.js?1648545790></script>
<script src=/js/hugo-learn.js?1648545790></script>
<script src=/js/yaub.js?1648545790></script>
<script>window.addEventListener('DOMContentLoaded',()=>{const a=new IntersectionObserver(a=>{a.forEach(a=>{const b=a.target.getAttribute('id');a.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${b}"]`).parentElement.classList.add('active'))})});document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach(b=>{a.observe(b)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll('aside nav li').forEach(a=>{a.classList.remove('active')})}</script>
<script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script>
<script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script>
<script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){var a;prefersDarkScheme.matches?(document.body.classList.toggle("light-theme"),a=document.body.classList.contains("light-theme")?"light":"dark"):(document.body.classList.toggle("dark-theme"),a=document.body.classList.contains("dark-theme")?"dark":"light"),localStorage.setItem("theme",a)})</script>
</body>
</html>