<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI">
<meta charset=utf-8>
<meta name=color-scheme content="dark light">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.87.0">
<meta name=description content="Openshift 4.x and Service Mesh/Istio Tutorial 5 - Routing Examples. Learn about routing and create your first definitions for VirtualService and DesitnationRule">
<meta name=author content="Toni Schmidbauer & Thomas Jungbauer">
<link rel=icon href=/images/favicon.ico type=image/png>
<link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png>
<link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png>
<link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png>
<link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png>
<link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png>
<link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png>
<link rel="shortcut icon" href=/images/favicon.ico>
<link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png>
<link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<title>Routing Example :: TechBlog about OpenShift/Ansible/Satellite and much more</title>
<link rel=manifest href=/manifest.json>
<meta name=theme-color content="#317EFB">
<link href=/css/nucleus.min.css?1634398319 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1634398319 rel=stylesheet>
<link href=/css/font-awesome-animation.min.css?1634398319 rel=stylesheet>
<link href=/css/hybrid.css?1634398319 rel=stylesheet>
<link href=/css/featherlight.min.css?1634398319 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1634398319 rel=stylesheet>
<link href=/css/auto-complete.css?1634398319 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1634398319 rel=stylesheet>
<link href=/css/theme.min.css?1634398319 rel=stylesheet>
<link href=/css/hugo-theme.css?1634398319 rel=stylesheet>
<link href=/css/theme-yaub.css?1634398319 rel=stylesheet>
<script src=/js/jquery-3.6.0.min.js?1634398319></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
</head>
<body data-url=/service-mesh/2020/04/routing-example/>
<button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/>
<p class="fa fa-cloud-upload-alt faa-float animated"></p>
<span class=text>YAUB</span>
<p class=logoarea><span class="text small">Yet another Useless Blog</span></p>
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1634398319></script>
<script type=text/javascript src=/js/auto-complete.js?1634398319></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script>
<script type=text/javascript src=/js/search.js?1634398319></script>
</div>
<div class=togglemode>
<button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button>
</div>
<section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Home</a>
</li>
</ul>
</section>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/openshift/ title=OpenShift class=dd-item>
<a href=/openshift/>
OpenShift
</a>
<ul>
<li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item>
<a href=/openshift/2021-09-25-sealed_secrets/>
Secure your secrets with Sealed Secrets
</a>
</li>
<li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item>
<a href=/openshift/2021-02-27-understanding-block-devices/>
Understanding RWO block device handling in OpenShift
</a>
</li>
<li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item>
<a href=/openshift/2021-01-27-writingoperatoransible/>
Writing Operator using Ansible
</a>
</li>
<li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item>
<a href=/openshift/2020-12-10-thanos-vs-thanos/>
Thanos Querier vs Thanos Querier
</a>
</li>
<li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item>
<a href=/openshift/2020-08-06-argocd/>
GitOps - Argo CD
</a>
</li>
<li data-nav-id=/openshift/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item>
<a href=/openshift/2020-05-13-quay-tutorial1/>
Red Hat Quay Registry - Overview and Installation
</a>
</li>
<li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item>
<a href=/openshift/2020-04-16-tekton/>
OpenShift Pipelines - Tekton Introduction
</a>
</li>
<li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item>
<a href=/openshift/2020-04-01-oc-commands/>
Helpful oc / kubectl commands
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item>
<a href=/day-2/>
OpenShift Day-2
</a>
<ul>
<li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item>
<a href=/day-2/pod-placement/>
Pod Placement
</a>
<ul>
<li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item>
<a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>
Introduction
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-29-node-affinity/>
Node Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item>
<a href=/day-2/pod-placement/2021-08-27-podplacement/>
NodeSelector
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-28-affinity/>
Pod Affinity/Anti-Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item>
<a href=/day-2/pod-placement/2021-08-30-taints/>
Taints and Tolerations
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item>
<a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>
Topology Spread Constraints
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item>
<a href=/day-2/pod-placement/2021-09-01-descheduler/>
Using Descheduler
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/compliance/ title=Compliance class=dd-item>
<a href=/compliance/>
Compliance
</a>
<ul>
<li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item>
<a href=/compliance/2021/07/oc-compliance-command-line-plugin/>
oc compliance command line plugin
</a>
</li>
<li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item>
<a href=/compliance/2021/07/compliance-operator/>
Compliance Operator
</a>
</li>
</ul>
</li>
<li data-nav-id=/service-mesh/ title="Service Mesh" class="dd-item
parent">
<a href=/service-mesh/>
Service Mesh
</a>
<ul>
<li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item>
<a href=/service-mesh/2020/05/enable-automatic-route-creation/>
Enable Automatic Route Creation
</a>
</li>
<li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item>
<a href=/service-mesh/2020/05/authorization-rbac/>
Authorization (RBAC)
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item>
<a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>
Deploy Example Bookinfo Application
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item>
<a href=/service-mesh/2020/04/service-mesh-1.1-released/>
Service Mesh 1.1 released
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item>
<a href=/service-mesh/2020/04/authentication-jwt/>
Authentication JWT
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item>
<a href=/service-mesh/2020/04/mutual-tls-authentication/>
Mutual TLS Authentication
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item>
<a href=/service-mesh/2020/04/fault-injection/>
Fault Injection
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item>
<a href=/service-mesh/2020/04/limit-egress/external-traffic/>
Limit Egress/External Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/advanced-routing-example/>
Advanced Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class="dd-item active">
<a href=/service-mesh/2020/04/routing-example/>
Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item>
<a href=/service-mesh/2020/03/ingress-with-custom-domain/>
Ingress with custom domain
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item>
<a href=/service-mesh/2020/03/ingress-traffic/>
Ingress Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item>
<a href=/service-mesh/2020/03/deploy-microservices/>
Deploy Microservices
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item>
<a href=/service-mesh/2020/03/installation/>
Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/general/ title=General class=dd-item>
<a href=/general/>
General
</a>
<ul>
<li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item>
<a href=/general/2020/05/basic-usage-of-git/>
Basic usage of git
</a>
</li>
<li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item>
<a href=/general/2020/04/red-hat-satellite-cheat-sheet/>
Red Hat Satellite Cheat Sheet
</a>
</li>
</ul>
</li>
<li data-nav-id=/ansible/ title=Ansible class=dd-item>
<a href=/ansible/>
Ansible
</a>
<ul>
<li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item>
<a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>
Ansible Tower and downloading collections
</a>
</li>
<li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item>
<a href=/ansible/2020/04/ansible-azure-resource-manager-example/>
Ansible - Azure Resource Manager Example
</a>
</li>
<li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item>
<a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>
DO410 Ansible and Ansible Tower training notes
</a>
</li>
</ul>
</li>
<li data-nav-id=/quay/ title=Quay class=dd-item>
<a href=/quay/>
Quay
</a>
<ul>
<li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item>
<a href=/quay/2021-09-07-quay-upgrade-3.4/>
Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator
</a>
</li>
</ul>
</li>
<li data-nav-id=/archive/ title=Archive class=dd-item>
<a href=/archive/>
Archive
</a>
</li>
<li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item>
<a href=/legaldisclosure/>
Legal Disclosure
</a>
</li>
<li data-nav-id=/rss/ title="RSS Feeds" class=dd-item>
<a href=/rss/>
RSS Feeds
</a>
</li>
</ul>
<section id=shortcuts>
<h3 class=shortcut-title>More</h3>
<ul>
<li>
<a class=padding href=https://blog.stderr.at/tags><i class="fas fa-tags"></i> Tags</a>
</li>
<li>
<a class=padding href=https://blog.stderr.at/categories><i class="far fa-bookmark"></i> Catagories</a>
</li>
<li>
<a class=padding href=https://www.redhat.com><i class="fab fa-redhat"></i> Red Hat</a>
</li>
</ul>
</section>
<section id=footer>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<aside id=toc-field class="hidden lg:block tableOfContentContainer">
<header id=TableOfContentsHeader>What's on this Page</header>
<nav id=TableOfContents>
<ul>
<li><a href=#_some_theory>Some Theory</a>
<ul>
<li><a href=#_blue_green_deployments>Blue-Green Deployments</a></li>
<li><a href=#_ab_deployments>A/B Deployments</a></li>
<li><a href=#_canary_deployments>Canary Deployments</a></li>
</ul>
</li>
<li><a href=#_prerequisites>Prerequisites</a></li>
<li><a href=#_prepare_simple_routing>Prepare Simple Routing</a>
<ul>
<li><a href=#_optional_build_the_recommendation_microservice>OPTIONAL: Build the <em>recommendation</em> microservice</a></li>
<li><a href=#_create_second_deployment_with_version2>Create second deployment with version2</a></li>
<li><a href=#_call_application>Call application</a></li>
</ul>
</li>
<li><a href=#_send_all_traffic_to_recommendationv2>Send all traffic to <em>recommendation:v2</em></a>
<ul>
<li><a href=#_define_destinationrule_for_recommendation>Define DestinationRule for <em>recommendation</em></a></li>
<li><a href=#_define_virtualservice_for_recommendation>Define VirtualService for <em>recommendation</em></a></li>
<li><a href=#_call_application_2>Call application</a></li>
</ul>
</li>
<li><a href=#_sources>Sources</a></li>
</ul>
</nav>
<div id=navigation>
<a class=nav-prev href=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example"> <i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</aside>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/> <span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span> > <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/service-mesh/> <span itemprop=name>Service Mesh</span><meta itemprop=position content="2"></a></span> > Routing Example
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#_some_theory>Some Theory</a>
<ul>
<li><a href=#_blue_green_deployments>Blue-Green Deployments</a></li>
<li><a href=#_ab_deployments>A/B Deployments</a></li>
<li><a href=#_canary_deployments>Canary Deployments</a></li>
</ul>
</li>
<li><a href=#_prerequisites>Prerequisites</a></li>
<li><a href=#_prepare_simple_routing>Prepare Simple Routing</a>
<ul>
<li><a href=#_optional_build_the_recommendation_microservice>OPTIONAL: Build the <em>recommendation</em> microservice</a></li>
<li><a href=#_create_second_deployment_with_version2>Create second deployment with version2</a></li>
<li><a href=#_call_application>Call application</a></li>
</ul>
</li>
<li><a href=#_send_all_traffic_to_recommendationv2>Send all traffic to <em>recommendation:v2</em></a>
<ul>
<li><a href=#_define_destinationrule_for_recommendation>Define DestinationRule for <em>recommendation</em></a></li>
<li><a href=#_define_virtualservice_for_recommendation>Define VirtualService for <em>recommendation</em></a></li>
<li><a href=#_call_application_2>Call application</a></li>
</ul>
</li>
<li><a href=#_sources>Sources</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
<div class=tags>
<a class=tag-link href=/tags/istio>Istio</a>
<a class=tag-link href=/tags/service-mesh>Service Mesh</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/grayscale>Grayscale</a>
<a class=tag-link href=/tags/canary>Canary</a>
<a class=tag-link href=/tags/destinationrule>DestinationRule</a>
</div>
</div>
<div id=body-inner>
<h1>
Routing Example
</h1>
<p class=tracked>
<time class="f6 mv4 dib tracked" datetime=2020-04-01T00:00:00Z>
<strong>April 1, 2020</strong>
</time>
- By:
Thomas Jungbauer
( Lastmod: 2021-08-14 )
</p>
<div class=paragraph>
<p>In part 5 of the <strong>OpenShift 4 and Service Mesh</strong> tutorials, basic routing, using the objects VirtualService and DesitnationRule, are described. All operations have been successfully tested on OpenShift 4.3.</p>
</div>
<div class=sect1>
<h2 id=_some_theory>Some Theory</h2>
<div class=sectionbody>
<div class=paragraph>
<p>In this section another version of the <em>recommendation</em> microservice will be deployed. The traffic to the new version will be controlled with different settings of the VirtualService. Multiple scenarios can be realized with ServiceMesh. In general these are defined as follows ([<a href=#source_1>1</a>]):</p>
</div>
<div class=sect2>
<h3 id=_blue_green_deployments>Blue-Green Deployments</h3>
<div class=paragraph>
<p>In a Blue-Green deployment the old version (green) is kept running, while a new version (blue) is deployed and tested. When testing is successful, the 100% of the traffic is switched to the new version.
If there is any error, the traffic could be switched back to the green version.</p>
</div>
</div>
<div class=sect2>
<h3 id=_ab_deployments>A/B Deployments</h3>
<div class=paragraph>
<p>A/B deployments, in difference to Blue-Green deployments, will enable you to try a new version of the application in a limited way in the production environment. It is possible to specify that the production version gets most of the user requests, while a limited number of requests is sent to the new version. This could be specified by location of the user for example, so that all users from Vienna are sent to the new version, while all others are still using the old version.</p>
</div>
</div>
<div class=sect2>
<h3 id=_canary_deployments>Canary Deployments</h3>
<div class=paragraph>
<p>Canary releases can be used to allow a small, minimum amount of traffic to the new version of your application. This traffic can be increased gradually until all traffic is sent to the new version. If any issues are found, you can roll back and send the traffic to the old version.</p>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_prerequisites>Prerequisites</h2>
<div class=sectionbody>
<div class=paragraph>
<p>It is assumed that an OpenShift environment is up and running and that Issues #1 - #3 are done at least:</p>
</div>
<div class=ulist>
<ul>
<li>
<p><a href=/service-mesh/2020/03/installation/>Openshift 4 and ServiceMesh 1 - Installation</a></p>
</li>
<li>
<p><a href=/service-mesh/2020/03/deploy-microservices/>Openshift 4 and ServiceMesh 2 - Deploy Microservices</a></p>
</li>
<li>
<p><a href=/service-mesh/2020/03/ingress-traffic/>Openshift 4 and ServiceMesh 3 - Ingress Traffic</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_prepare_simple_routing>Prepare Simple Routing</h2>
<div class=sectionbody>
<div class=sect2>
<h3 id=_optional_build_the_recommendation_microservice>OPTIONAL: Build the <em>recommendation</em> microservice</h3>
<div class=paragraph>
<p>If you want to locally build the microservice, you must change the source code from version v1 to v2 the following way:</p>
</div>
<div class=paragraph>
<p>Open the file:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>istio-tutorial/recommendation/java/vertx/src/main/java/com/redhat/developer/demos/recommendation/RecommendationVerticle.java</code></pre>
</div>
</div>
<div class=paragraph>
<p>and change the following line from v1 to <strong>v2</strong></p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-java data-lang=java>private static final String RESPONSE_STRING_FORMAT = &#34;recommendation <strong>v2</strong> from &#39;%s&#39;: %d\n&#34;;</code></pre>
</div>
</div>
<div class=paragraph>
<p>Now you can build the image:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>cd istio-tutorial/recommendation/java/vertx
mvn package
podman build -t example/recommendation:v2 . <i class=conum data-value=1></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>Note the v2 tag</td>
</tr>
</tbody></table>
</div>
</div>
<div class=sect2>
<h3 id=_create_second_deployment_with_version2>Create second deployment with version2</h3>
<div class=paragraph>
<p>A deployment with our recommendation:v2 microservice must be created. A service object must not be created this time, as it already exists.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>cd ~/istio-tutorial/recommendation/
oc apply -f kubernetes/Deployment-v2.yml -n tutorial
oc get pods -w</code></pre>
</div>
</div>
<div class=paragraph>
<p>If you want to <em>diff</em> v1 and v2 deployment, you will notice that the main change is the image which gets pulled.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-diff data-lang=diff>diff recommendation/kubernetes/Deployment-v2.yml  recommendation/kubernetes/Deployment.yml
6,7c6,7
&lt;     version: v2
&lt;   name: recommendation-v2
---
&gt;     version: v1
&gt;   name: recommendation-v1
13c13
&lt;       version: v2
---
&gt;       version: v1
18c18
&lt;         version: v2
---
&gt;         version: v1
27c27
&lt;         image: quay.io/rhdevelopers/istio-tutorial-recommendation:v2.1
---
&gt;         image: quay.io/rhdevelopers/istio-tutorial-recommendation:v1.1</code></pre>
</div>
</div>
</div>
<div class=sect2>
<h3 id=_call_application>Call application</h3>
<div class=paragraph>
<p>Execute the test command to access the application. Since no rules are defined yet, the traffic is split by 50% to version 1 and version 2 (round robin):</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 10 $GATEWAY_URL

# 0: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 27
# 1: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 27
# 2: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 28
# 3: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 28
...</code></pre>
</div>
</div>
<div class=paragraph>
<p>In Kiali presents this as well:</p>
</div>
<div class=imageblock>
<div class=content>
<img src=/service-mesh/images/Kiali-v1-v2-trafficsplit1.png alt="Kiali v1 v2 trafficsplit1">
</div>
<div class=title>Figure 1. Kiali sends 50% to v1 and v2</div>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_send_all_traffic_to_recommendationv2>Send all traffic to <em>recommendation:v2</em></h2>
<div class=sectionbody>
<div class=paragraph>
<p>To route the traffic accordingly a <strong>DestinationRule</strong> and a <strong>VirtualService</strong> must be created for <em>recommendation</em>. While the DesinationRule will add a name to each version, VirtualService specifies the actual destination of the traffic.</p>
</div>
<div class=sect2>
<h3 id=_define_destinationrule_for_recommendation>Define DestinationRule for <em>recommendation</em></h3>
<div class=paragraph>
<p>The object DestinationRule will define the versions in <em>subsets</em>.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendation
spec:
  host: recommendation
  subsets:
  - labels:
      version: v1
    name: version-v1
  - labels:
      version: v2
    name: version-v2</code></pre>
</div>
</div>
<div class=paragraph>
<p>Create the object with the command: <em>oc create -f &lt;filename></em></p>
</div>
</div>
<div class=sect2>
<h3 id=_define_virtualservice_for_recommendation>Define VirtualService for <em>recommendation</em></h3>
<div class=paragraph>
<p>The VirtualService defines that 100% (weight) of the traffic for recomendation (host) will be sent to the subset (version-v2), which is defined in the DefinationRule</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v2
      weight: 100</code></pre>
</div>
</div>
<div class=paragraph>
<p>Create the object with the command: <em>oc create -f &lt;filename></em></p>
</div>
</div>
<div class=sect2>
<h3 id=_call_application_2>Call application</h3>
<div class=paragraph>
<p>If you now call the application, only traffic to v2 should be shown:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>sh ~/run.sh 1000 $GATEWAY_URL

# 0: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 27
# 1: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 27
# 2: customer =&gt; preference =&gt; recommendation v2 from &#39;3cbba7a9cde5&#39;: 28
# 3: customer =&gt; preference =&gt; recommendation v1 from &#39;f11b097f1dd0&#39;: 28
...</code></pre>
</div>
</div>
<div class=paragraph>
<p>In Kiali presents this as well and send 100% of the traffic to <em>recommendation:v2</em>:</p>
</div>
<div class=imageblock>
<div class=content>
<img src=/service-mesh/images/Kiali-100-v2-trafficsplit2.png alt="Kiali 100 v2 trafficsplit2">
</div>
<div class=title>Figure 2. Kiali sends 100% to v2</div>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_sources>Sources</h2>
<div class=sectionbody>
<div class=ulist>
<ul>
<li>
<p><a id=source_1></a>[1]: <a href=https://dzone.com/articles/traffic-management-with-istio-2-grayscale-release target=_blank rel=noopener>DZone: Traffic Management With Istio</a></p>
</li>
</ul>
</div>
</div>
</div>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation-bottom>
<a class="nav-prev btn btn-default" href=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example"> <i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous: </span> Advanced Routing Example</a>
<a class="nav-next btn btn-default" href=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Ingress with custom domain</a>
</div>
<div class=copyright>
<p>Copyright &copy; 2020 - 2021 Toni Schmidbauer & Thomas Jungbauer</p>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1634398323></script>
<script src=/js/perfect-scrollbar.min.js?1634398323></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1634398323></script>
<script src=/js/jquery.sticky.js?1634398323></script>
<script src=/js/featherlight.min.js?1634398323></script>
<script src=/js/highlight.pack.js?1634398323></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1634398323></script>
<script src=/js/learn.js?1634398323></script>
<script src=/js/hugo-learn.js?1634398323></script>
<script src=/js/yaub.js?1634398323></script>
<script>window.addEventListener('DOMContentLoaded',()=>{const a=new IntersectionObserver(a=>{a.forEach(a=>{const b=a.target.getAttribute('id');a.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${b}"]`).parentElement.classList.add('active'))})});document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach(b=>{a.observe(b)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll('aside nav li').forEach(a=>{a.classList.remove('active')})}</script>
<script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script>
<script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script>
<script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){var a;prefersDarkScheme.matches?(document.body.classList.toggle("light-theme"),a=document.body.classList.contains("light-theme")?"light":"dark"):(document.body.classList.toggle("dark-theme"),a=document.body.classList.contains("dark-theme")?"dark":"light"),localStorage.setItem("theme",a)})</script>
</body>
</html>