<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"><!--<![endif]-->
<head>
    <meta name="google-site-verification" content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI" />
    <!-- Website Template designed by www.downloadwebsitetemplates.co.uk -->
    <!-- Modified to fit Cryogen.-->
    <meta charset="UTF-8">
    <title>Yaub: Compliance Operator</title>
    
<meta name="keywords" content="Route,ArgoCD,Storage,Bookinfo,Example,github,DestinationRule,Authorization,security,Loadbalancer,plugin,Tekton,OCP,Canary,Azure,Grayscale,Egress,JWT,Mirror,Gitops,Security,kubectl,Istio,git,Ansible Tower,Operator,Pipelines,Fault Injection,Satellite,compliance,Grafana,Hardening,Container Security,Thanos,Ansible,Quay,OpenShift,Service Mesh,mTLS,DO410,Kubernetes,Block devices,oc,Registry">

<meta name="description" content="Hardening OpenShift using the Compliance Operator">

<meta property="og:description" content="Hardening OpenShift using the Compliance Operator">

<meta property="og:url" content="http://blog.stderr.at/posts-output/2021-07-19-ComplianceOperator/" />
<meta property="og:title" content="Compliance Operator" />
<meta property="og:type" content="article" />

    <meta content="width=device-width, initial-scale=1, maximum-scale=5" name="viewport">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/ico/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/ico/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/img/ico/apple-touch-icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/ico/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/ico/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/ico/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" href="/img/ico/apple-touch-icon-57x57.png">
    <link rel="shortcut icon" href="/img/ico/favicon.ico">
    <!--[if IE]><![endif]-->   
    <link href="/css/style.css" rel="stylesheet" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/tomorrow-night-eighties.min.css">
    <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/font-awesome-animation.min.css"> 
    <script src="/js/lunr.min.js" async></script>
    <script src="/js/index/lunr_index.js" type="text/javascript" async></script>
    <script src="/js/lunrclient.js" async></script>

</head>
<body>  
<button onclick="topFunction()" id="myBtn" class="button fa fa-arrow-up" title="Go to top"></button> 

<div id="left">

    <p id="logo">
        <a title="Yaub" href="/">
            <span class="fa fa-cloud-upload faa-float animated"></span>
            <span class="text">YAUB</span>
            <span class="text small">Yet another Useless Blog</span>
        </a>
    </p>

    <!--- Search from -->
    <form id="lunrSearchForm" name="lunrSearchForm" action="/">
        <label> <input id="searchfield" class="search-input" name="q" placeholder="Enter search term" type="text"></label>
        <label> <input class="button nopadding" type="submit" value="Search"></label>
    </form>
    <div class="loading" id="loading-div">
        <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
        <span class="sr-only">Loading...</span>
    </div>

    <!-- menu -->
    <div id="menucont" class="bodycontainer clearfix">
        <div class="menutitle">
            <p><span class="fa fa-reorder"></span><strong>Menu</strong></p>
        </div>
        <ul class="menu">
          <a class="left" title="Home" href="/">
            <li >Home</li>
          </a>

          <a class="left" title="Archives" href="/archives/">
            <li >Archives</li>
          </a>

            
            <a class="left" title="Tags" href="/tags/">
            <li >Tags</li>
            </a>
            
            
            
            <a class="left" href="/pages-output/Legal/">
            <li >
                Legal Disclosure
            </li>
            </a>
            
            <a class="left" title="RSS" href="/feed.xml">
            <li>RSS</li>
            </a>
        </ul>
    </div>

    <hr class="menuhr">
      <div id="menucont">
        <ul class="menu">
          <li>Recent Posts:</li>
          
            <a class="nospacing left" href="/posts-output/2021-07-20-Compliance-Plugin-CLI/"><li class="smallpadding small">oc compliance command line plugin</li></a>
          
            <a class="nospacing left" href="/posts-output/2021-07-19-ComplianceOperator/"><li class="smallpadding small">Compliance Operator</li></a>
          
            <a class="nospacing left" href="/posts-output/2021-02-27-understanding-block-devices/"><li class="smallpadding small">Understanding RWO block device handling in OpenShift</li></a>
          
            <a class="nospacing left" href="/posts-output/2021-01-27-WritingOperatorAnsible/"><li class="smallpadding small">Writing Operator using Ansible</li></a>
          
            <a class="nospacing left" href="/posts-output/2020-12-10-Thanos-vs-Thanos/"><li class="smallpadding small">Thanos Querier vs Thanos Querier</li></a>
          
        </ul>
      </div>
    <hr class="menuhr">
      <div id="menucont">
        <ul class="menu">
          <li>Links:</li>
          <a class="nospacing left" href="https://redhat.com" rel="noopener"><li class="smallpadding small">Red Hat</li></a>
          <a class="nospacing left" href="https://docs.openshift.com/" rel="noopener"><li class="smallpadding small">OpenShift Docs</li></a>
          <a class="nospacing left" href="https://github.com/stderrat/stderrat.github.io" rel="noopener"><li class="smallpadding small">Source</li></a>
            
        </ul>
      </div>
</div>

<div id="right" class="clearfix">
  <div class="resultCount" id="resultCount"></div>
  <hr />
  <div id="searchResults">
    
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <strong>July 19, 2021</strong>
        
        <span class="col-lg-6 right">By: Thomas Jungbauer</span>
        
    </div>
    <h1>Compliance Operator</h1>
</div>
<div>
    
    <div class="paragraph small"><p><em>Last Modified: 2021-07-30 14:42:11 UTC</em></p></div><div class="paragraph"><p>OpenShift comes out of the box with a highly secure operating system, called Red Hat CoreOS. This OS is immutable, which means that no direct changes are done inside the OS, instead any configuration is managed by OpenShift itself using MachineConfig objects. Nevertheless, hardening certain settings must still be considered. Red Hat released a hardening guide (CIS Benchmark) which can be downloaded at <a href="https://www.cisecurity.org/" class="bare">https://www.cisecurity.org/</a>.</p></div><div class="paragraph"><p> <br />
However, an automated way to perform such checks would be nice too. To achieve this the <strong>Compliance Operator</strong> can be leveraged, which runs an OpenSCAP check to create reports of the clusters is compliant or as the official documentation describes:</p></div><div class="paragraph"><p> <br /></p></div><div class="paragraph"><p><em>The Compliance Operator lets OpenShift Container Platform administrators describe the desired compliance state of a cluster and provides them with an overview of gaps and ways to remediate them. The Compliance Operator assesses compliance of both the Kubernetes API resources of OpenShift Container Platform, as well as the nodes running the cluster. The Compliance Operator uses OpenSCAP, a NIST-certified tool, to scan and enforce security policies provided by the content.</em></p></div><div class="paragraph"><p> <br /></p></div><div class="paragraph"><p>This article shall show how to quickly install the operator and retrieve the first result. It is not a full documentation, which is written by other people at: <a href="https://docs.openshift.com/container-platform/4.7/security/compliance_operator/compliance-operator-installation.html">Compliance Operator</a>, especially remediation is not covered here.</p></div><div id="toc" class="toc"><div id="toctitle" class="title">Table of Contents</div><ul class="sectlevel1"><li><a href="#_install_the_compliance_operator">Install the Compliance Operator</a></li><li><a href="#_custom_resources_crds">Custom Resources (CRDs)</a></li><li><a href="#_create_a_scanbinding_object">Create a ScanBinding object</a></li><li><a href="#_profiles">Profiles</a><ul class="sectlevel2"><li><a href="#_profile_customization">Profile Customization</a></li></ul></li><li><a href="#_working_with_scan_results">Working with scan results</a><ul class="sectlevel2"><li><a href="#_retrieving_results_via_oc_command">Retrieving results via oc command</a></li><li><a href="#_retrieving_raw_results">Retrieving RAW results</a></li><li><a href="#_work_wth_raw_results">Work wth RAW results</a></li></ul></li><li><a href="#_performing_a_rescan">Performing a rescan</a></li></ul></div><div class="paragraph"><p>As prerequisites we have:</p></div><div class="ulist"><ul><li><p>Installed OpenShift 4.6+ cluster</p></li></ul></div><div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa icon-warning" title="Warning"></i></td><td class="content">
The Compliance Operator is available for Red Hat Enterprise Linux CoreOS (RHCOS) deployments only.
</td></tr></table></div><div class="sect1"><h2 id="_install_the_compliance_operator">Install the Compliance Operator</h2><div class="sectionbody"><div class="paragraph"><p>The easiest way to deploy the Compliance Operator is by searching the OperatorHub which is available inside OpenShift.</p></div><div class="imageblock bordered"><div class="content"><img src="/img/security/install_compliance_operator_1.png" alt="Install" width="640" /></div><div class="title">Figure 1. Install Compliance Operator</div></div><div class="paragraph"><p>Keep the default settings and wait until the operator has been installed.</p></div><div class="imageblock bordered"><div class="content"><img src="/img/security/install_compliance_operator_2.png" alt="Install" width="640" /></div><div class="title">Figure 2. Install Compliance Operator</div></div><hr /></div></div><div class="sect1"><h2 id="_custom_resources_crds">Custom Resources (CRDs)</h2><div class="sectionbody"><div class="paragraph"><p>The operator brings a ton of new CRDs into the system:</p></div><div class="ulist"><ul><li><p>ScanSetting …​ defines when and on which roles (worker, master …​) a check shall be executed. It also defines a persistent volume (PV) to store the scan results. Two ScanSettings are created during the installation:</p><div class="ulist"><ul><li><p><em>default</em>: just scans without automatically apply changes</p></li><li><p><em>default-auto-apply</em>: can automatically remediate without extra steps</p></li></ul></div></li><li><p>ScanSettingBinding …​ binds one or more profiles to a scan</p></li><li><p>Profile …​ Represent different compliance benchmarks with a set of rules. For this blog we will use CIS Benchmark profiles</p></li><li><p>ProfileBundle …​ Bundles a security image, which is later used by Profiles.</p></li><li><p>Rule …​ Rules which are used by profiles to verify the state of the cluster.</p></li><li><p>TailoredProfile …​ Customized profile</p></li><li><p>ComplianceScan …​ scans which have been performed</p></li><li><p>ComplianceCheckResult …​ The results of a scan. Each ComplianceCheckResult represents the result of one compliance rule check</p></li><li><p>ComplianceRemediation …​ If a rule ca be remediated automatically, this object is created.</p></li></ul></div></div></div><div class="sect1"><h2 id="_create_a_scanbinding_object">Create a ScanBinding object</h2><div class="sectionbody"><div class="paragraph"><p>The first step to do is to create a ScanBiding objects. (We reuse the <em>default</em> ScanSetting)</p></div><div class="paragraph"><p>Let’s create the following object, which is using the profiles <em>ocp4-cis</em> and <em>ocp4-cis-node</em></p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: compliance.openshift.io/v1alpha1
kind: ScanSettingBinding
metadata:
  name: cis-compliance
profiles:
  - name: ocp4-cis-node <i class="conum" data-value="1"></i><b>(1)</b>
    kind: Profile
    apiGroup: compliance.openshift.io/v1alpha1
  - name: ocp4-cis <i class="conum" data-value="2"></i><b>(2)</b>
    kind: Profile
    apiGroup: compliance.openshift.io/v1alpha1
settingsRef:
  name: default <i class="conum" data-value="3"></i><b>(3)</b>
  kind: ScanSetting
  apiGroup: compliance.openshift.io/v1alpha1</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>use the profile ocp4-cis-node</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>use the profile ocp4-cis</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>reference to the <em>default</em> scansetting</td></tr></table></div><div class="paragraph"><p>As soon as the object is created the cluster is scan is started. The objects <em>ComplianceSuite</em> and <em>ComplianceScan</em> are created automatically and will eventually reach the phase "DONE" when the scan is completed.</p></div><div class="paragraph"><p>The following command will show the results of the scans</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get compliancescan -n openshift-compliance

NAME                   PHASE   RESULT
ocp4-cis               DONE    NON-COMPLIANT
ocp4-cis-node-master   DONE    NON-COMPLIANT
ocp4-cis-node-worker   DONE    INCONSISTENT</code></pre></div></div><div class="paragraph"><p>Three different checks have been done. One overall cluster check and 2 separated for master and worker nodes.</p></div><div class="paragraph"><p>As we used the <em>default</em> ScanSetting the next check will run a 1 am.</p></div></div></div><div class="sect1"><h2 id="_profiles">Profiles</h2><div class="sectionbody"><div class="paragraph"><p>The operator comes with a set of standard profiles which represent different compliance benchmarks.</p></div><div class="paragraph"><p>To view available profiles:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get profiles.compliance -n openshift-compliance</code></pre></div></div><div class="listingblock hidecopy"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">NAME              AGE
ocp4-cis          28m
ocp4-cis-node     28m
ocp4-e8           28m
ocp4-moderate     28m
rhcos4-e8         28m
rhcos4-moderate   28m</code></pre></div></div><div class="paragraph"><p>Each profile contains a description which explains the intention and a list of rules which used in this profile.</p></div><div class="paragraph"><p>For example the profile 'ocp4-cis-node' used above is containing:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get profiles.compliance -n openshift-compliance -oyaml ocp4-cis-node

# Output
description: This profile defines a baseline that aligns to the Center for Internet Security® Red
Hat OpenShift Container Platform 4 Benchmark™, V0.3, currently unreleased. This profile includes
Center for Internet Security® Red Hat OpenShift Container Platform 4 CIS Benchmarks™ content.
Note that this part of the profile is meant to run on the Operating System that Red Hat
OpenShift Container Platform 4 runs on top of. This profile is applicable to OpenShift versions
4.6 and greater.
[...]
  name: ocp4-cis-node
  namespace: openshift-compliance
[...]
rules:
- ocp4-etcd-unique-ca
- ocp4-file-groupowner-cni-conf
- ocp4-file-groupowner-controller-manager-kubeconfig
- ocp4-file-groupowner-etcd-data-dir
- ocp4-file-groupowner-etcd-data-files
- ocp4-file-groupowner-etcd-member
- ocp4-file-groupowner-etcd-pki-cert-files
- ocp4-file-groupowner-ip-allocations
[...]</code></pre></div></div><div class="paragraph"><p>Like the profiles the different rules can be inspected:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get rules.compliance -n openshift-compliance  ocp4-file-groupowner-etcd-member
-o jsonpath='{"Title: "}{.title}{"\nDescription: \n"}{.description}'

# Output
Title: Verify Group Who Owns The etcd Member Pod Specification File
Description:
To properly set the group owner of /etc/kubernetes/static-pod-resources/etcd-pod-*/etcd-pod.yaml ,
run the command:

$ sudo chgrp root /etc/kubernetes/static-pod-resources/etcd-pod-*/etcd-pod.yaml</code></pre></div></div><div class="sect2"><h3 id="_profile_customization">Profile Customization</h3><div class="paragraph"><p>Sometimes is it required to modify (tailor) a profile to fit specific needs. With the <em>TailoredProfile</em> object it is possible to enable or disable rules.</p></div><div class="paragraph"><p>In this blog, I just want to share a quick example from the official documentaiton: <a href="https://docs.openshift.com/container-platform/4.7/security/compliance_operator/compliance-operator-tailor.html" class="bare">https://docs.openshift.com/container-platform/4.7/security/compliance_operator/compliance-operator-tailor.html</a></p></div><div class="paragraph"><p>The following TailoredProfile disables 2 rules and sets a value for another rule:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: compliance.openshift.io/v1alpha1
kind: TailoredProfile
metadata:
  name: nist-moderate-modified
spec:
  extends: rhcos4-moderate
  title: My modified NIST moderate profile
  disableRules:
  - name: rhcos4-file-permissions-node-config
    rationale: This breaks X application.
  - name: rhcos4-account-disable-post-pw-expiration
    rationale: No need to check this as it comes from the IdP
  setValues:
  - name: rhcos4-var-selinux-state
    rationale: Organizational requirements
    value: permissive</code></pre></div></div></div></div></div><div class="sect1"><h2 id="_working_with_scan_results">Working with scan results</h2><div class="sectionbody"><div class="paragraph"><p>Once a scan finished you probably want to see what the status of the scan is.</p></div><div class="paragraph"><p>As you sse above the cluster failed to be compliant.</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get compliancescan -n openshift-compliance

NAME                   PHASE   RESULT
ocp4-cis               DONE    NON-COMPLIANT
ocp4-cis-node-master   DONE    NON-COMPLIANT
ocp4-cis-node-worker   DONE    INCONSISTENT</code></pre></div></div><div class="sect2"><h3 id="_retrieving_results_via_oc_command">Retrieving results via oc command</h3><div class="paragraph"><p>List all results which can be remediated automatically:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get compliancecheckresults -l 'compliance.openshift.io/check-status=FAIL,compliance.openshift.io/automated-remediation' -n openshift-compliance
NAME                                             STATUS   SEVERITY
ocp4-cis-api-server-encryption-provider-cipher   FAIL     medium
ocp4-cis-api-server-encryption-provider-config   FAIL     medium</code></pre></div></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content">
Further information about remediation can be found at: <a href="https://docs.openshift.com/container-platform/4.7/security/compliance_operator/compliance-operator-remediation.html">Compliance Operator Remediation</a></td></tr></table></div><div class="paragraph"><p>List all results which cannot be remediated automatically and must be fixed manually instead:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get compliancecheckresults -l 'compliance.openshift.io/check-status=FAIL,!compliance.openshift.io/automated-remediation' -n openshift-compliance
NAME                                                                           STATUS   SEVERITY
ocp4-cis-audit-log-forwarding-enabled                                          FAIL     medium
ocp4-cis-file-permissions-proxy-kubeconfig                                     FAIL     medium
ocp4-cis-node-master-file-groupowner-ip-allocations                            FAIL     medium
ocp4-cis-node-master-file-groupowner-openshift-sdn-cniserver-config            FAIL     medium
ocp4-cis-node-master-file-owner-ip-allocations                                 FAIL     medium
ocp4-cis-node-master-file-owner-openshift-sdn-cniserver-config                 FAIL     medium
ocp4-cis-node-master-kubelet-configure-event-creation                          FAIL     medium
ocp4-cis-node-master-kubelet-configure-tls-cipher-suites                       FAIL     medium
ocp4-cis-node-master-kubelet-enable-protect-kernel-defaults                    FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-imagefs-available    FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-imagefs-inodesfree   FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-memory-available     FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-nodefs-available     FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-nodefs-inodesfree    FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-soft-imagefs-available    FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-soft-imagefs-inodesfree   FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-soft-memory-available     FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-soft-nodefs-available     FAIL     medium
ocp4-cis-node-master-kubelet-eviction-thresholds-set-soft-nodefs-inodesfree    FAIL     medium
ocp4-cis-node-worker-file-groupowner-ip-allocations                            FAIL     medium
ocp4-cis-node-worker-file-groupowner-openshift-sdn-cniserver-config            FAIL     medium
ocp4-cis-node-worker-file-owner-ip-allocations                                 FAIL     medium
ocp4-cis-node-worker-file-owner-openshift-sdn-cniserver-config                 FAIL     medium
ocp4-cis-node-worker-kubelet-configure-event-creation                          FAIL     medium
ocp4-cis-node-worker-kubelet-configure-tls-cipher-suites                       FAIL     medium
ocp4-cis-node-worker-kubelet-enable-protect-kernel-defaults                    FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-hard-imagefs-available    FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-hard-imagefs-inodesfree   FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-hard-memory-available     FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-hard-nodefs-available     FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-hard-nodefs-inodesfree    FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-soft-imagefs-available    FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-soft-imagefs-inodesfree   FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-soft-memory-available     FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-soft-nodefs-available     FAIL     medium
ocp4-cis-node-worker-kubelet-eviction-thresholds-set-soft-nodefs-inodesfree    FAIL     medium</code></pre></div></div></div><div class="sect2"><h3 id="_retrieving_raw_results">Retrieving RAW results</h3><div class="paragraph"><p>Let’s first retrieve the raw result of the scan. For each of the ComplianceScans a volume claim (PVC) is created to store he results. We can use a Pod to mount the volume to download the scan results.</p></div><div class="paragraph"><p>The following PVC have been created on our example:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc get pvc -n openshift-compliance

NAME                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE
ocp4-cis               Bound    pvc-cc026ae3-2f42-4e19-bc55-016c6dd31d22   1Gi        RWO            managed-nfs-storage   4h17m
ocp4-cis-node-master   Bound    pvc-3bd47c5e-2008-4759-9d53-ba41b568688d   1Gi        RWO            managed-nfs-storage   4h17m
ocp4-cis-node-worker   Bound    pvc-77200e5f-0f15-410c-a4ee-f2fb3e316f84   1Gi        RWO            managed-nfs-storage   4h17m</code></pre></div></div><div class="paragraph"><p>Now we can create a Pod which mounts all PVCs at once:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: "v1"
kind: Pod
metadata:
  name: pv-extract
  namespace: openshift-compliance
spec:
  containers:
    - name: pv-extract-pod
      image: registry.access.redhat.com/ubi8/ubi
      command: ["sleep", "3000"]
      volumeMounts: <i class="conum" data-value="1"></i><b>(1)</b>
      - mountPath: "/workers-scan-results"
        name: workers-scan-vol
      - mountPath: "/masters-scan-results"
        name: masters-scan-vol
      - mountPath: "/ocp4-scan-results"
        name: ocp4-scan-vol
  volumes: <i class="conum" data-value="2"></i><b>(2)</b>
    - name: workers-scan-vol
      persistentVolumeClaim:
        claimName: ocp4-cis-node-worker
    - name: masters-scan-vol
      persistentVolumeClaim:
        claimName: ocp4-cis-node-master
    - name: ocp4-scan-vol
      persistentVolumeClaim:
        claimName: ocp4-cis</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>mount paths</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>volumesclaims to mount</td></tr></table></div><div class="paragraph"><p>This creates a Pod with the PVCs mounted inside:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">sh-4.4# ls -la | grep scan
drwxrwxrwx.   3 root root 4096 Jul 20 05:20 master-scan-results
drwxrwxrwx.   3 root root 4096 Jul 20 05:20 ocp4-scan-results
drwxrwxrwx.   3 root root 4096 Jul 20 05:20 workers-scan-results</code></pre></div></div><div class="paragraph"><p>We can download the result-files to our local machine for further auditing. Therefore, we create the folder <em>scan_results</em> in which we copy everything:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">mkdir scan-results; cd scan-results

oc -n openshift-compliance cp pv-extract:ocp4-scan-results ocp4-scan-results/.
oc -n openshift-compliance cp pv-extract:workers-scan-results workers-scan-results/.
oc -n openshift-compliance cp pv-extract:masters-scan-results masters-scan-results/.</code></pre></div></div><div class="paragraph"><p>This will download several bzip2 archives for the appropriate scan result.</p></div><div class="paragraph"><p>Once done, you can delete the "download pod" using: <code>oc delete pod pv-extract -n openshift-compliance</code></p></div></div><div class="sect2"><h3 id="_work_wth_raw_results">Work wth RAW results</h3><div class="paragraph"><p>So above section described the download of the bzip2 files but what to do with it? First, you can import it into a tool which is able to read openScap reports. Or, secondly, you can use the <em>oscap</em> command to create a html output.</p></div><div class="paragraph"><p>We have downloaded the following files:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">./ocp4-scan-results/0/ocp4-cis-api-checks-pod.xml.bzip2

./masters-scan-results/0/ocp4-cis-node-master-master-0-pod.xml.bzip2
./masters-scan-results/0/ocp4-cis-node-master-master-2-pod.xml.bzip2
./masters-scan-results/0/ocp4-cis-node-master-master-1-pod.xml.bzip2

./workers-scan-results/0/ocp4-cis-node-worker-compute-0-pod.xml.bzip2
./workers-scan-results/0/ocp4-cis-node-worker-compute-1-pod.xml.bzip2
./workers-scan-results/0/ocp4-cis-node-worker-compute-3-pod.xml.bzip2
./workers-scan-results/0/ocp4-cis-node-worker-compute-2-pod.xml.bzip2</code></pre></div></div><div class="paragraph"><p>To create the html output (be sure that open-scap is installed on you host):</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">mkdir html
oscap xccdf generate report ocp4-scan-results/0/ocp4-cis-api-checks-pod.xml.bzip2 &gt;&gt; html/ocp4-cis-api-checks.html

oscap xccdf generate report masters-scan-results/0/ocp4-cis-node-master-master-0-pod.xml.bzip2 &gt;&gt; html/ocp4-cis-node-master-master-0.html
oscap xccdf generate report masters-scan-results/0/ocp4-cis-node-master-master-1-pod.xml.bzip2 &gt;&gt; html/ocp4-cis-node-master-master-1.html
oscap xccdf generate report masters-scan-results/0/ocp4-cis-node-master-master-2-pod.xml.bzip2 &gt;&gt; html/ocp4-cis-node-master-master-2.html

oscap xccdf generate report workers-scan-results/0/ocp4-cis-node-worker-compute-0-pod.xml.bzip2 &gt;&gt; html/ocp4-cis-node-worker-compute-0.html
...</code></pre></div></div><div class="paragraph"><p>The resulted html files are too big to be show here, but some snippets should give an overview:</p></div><div class="paragraph"><p>To view the html output as an example I have linked the html files:</p></div><div class="ulist"><ul><li><p><a href="https://blog.stderr.at/img/security/ocp4-cis-api-checks.html">OCP4 - CIS</a></p></li><li><p><a href="https://blog.stderr.at/img/security/ocp4-cis-node-master-master-0.html">Example Master Node Results</a></p></li><li><p><a href="https://blog.stderr.at/img/security/ocp4-cis-node-worker-compute-0.html">Example Worker Node Results</a></p></li></ul></div><div class="paragraph"><p> <br /></p></div><div class="paragraph"><p>Overall Scoring of the result:</p></div><div class="imageblock bordered"><div class="content"><img src="/img/security/compliance_scoring.png" alt="Install" width="940" /></div><div class="title">Figure 3. Scoring</div></div><div class="paragraph"><p>A list if passed or failed checks:</p></div><div class="imageblock bordered"><div class="content"><img src="/img/security/compliance_scan_results.png" alt="Scanresults" width="940" /></div><div class="title">Figure 4. Scan Result list</div></div><div class="paragraph"><p>Scan details with a link to the CIS Benchmark section and further explainations on how to fix the issue:</p></div><div class="imageblock bordered"><div class="content"><img src="/img/security/compliance_scan_details.png" alt="Details" width="940" /></div><div class="title">Figure 5. Scan details</div></div></div></div></div><div class="sect1"><h2 id="_performing_a_rescan">Performing a rescan</h2><div class="sectionbody"><div class="paragraph"><p>If it is necessary to run a rescan, the ComplianceScan object is simply annotated with:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc annotate compliancescans/&lt;scan_name&gt; compliance.openshift.io/rescan=</code></pre></div></div><div class="admonitionblock caution"><table><tr><td class="icon"><i class="fa icon-caution" title="Caution"></i></td><td class="content">
If <em>default-auto-apply</em> is enabled, remediation which changes MachineConfigs will trigger a cluster reboot.
</td></tr></table></div></div></div>
</div>

<div id="post-tags">
    <br/> 
    <b>Tags: </b>
    
    <a class="post-tags-class" href="/tags-output/security/">security</a>
    
    <a class="post-tags-class" href="/tags-output/OCP/">OCP</a>
    
    <a class="post-tags-class" href="/tags-output/compliance/">compliance</a>
    
    <a class="post-tags-class" href="/tags-output/Hardening/">Hardening</a>
    
    <a class="post-tags-class" href="/tags-output/OpenShift/">OpenShift</a>
    
</div>

<br/>

    <div id="prev-next">
        
        <a class="button" href="/posts-output/2021-02-27-understanding-block-devices/">&laquo; Understanding RWO block device handling in OpenShift</a>
        
        
        <a class="right button" href="/posts-output/2021-07-20-Compliance-Plugin-CLI/">oc compliance command line plugin &raquo;</a>
        
    </div>

    


</div>

  </div>
<hr/>
<div id="footercont" class="small clearfix">Copyright &copy; 2021 Toni Schmidbauer &amp; Thomas Jungbauer
    <p>Powered by <a href="http://cryogenweb.org">Cryogen</a> | Free Website Template by <a title="free website templates" href="http://www.downloadwebsitetemplates.co.uk" rel="noreferrer">Download Website Templates</a></p>

</div>
</div>

<!-- currently hardcoded -->
<div id="farright">
  <ul class="menu">
    Main Topics: 
      <li><a class="nospacing" href="/tags-output/Service%20Mesh/">ServiceMesh</a></li>
      <li><a class="nospacing" href="/tags-output/Tekton/">Tekton</a></li>
      <li><a class="nospacing" href="/tags-output/Ansible/">Ansible</a></li>
      <li><a class="nospacing" href="/tags-output/OpenShift/">OpenShift</a></li>
  </ul>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/clipboard.min.js" type="application/javascript"></script>
<script src="/js/clipboard.integration.js" type="application/javascript"></script>
<script src="/js/scripts.js" type="application/javascript"></script>

<script>window.onload = start;</script>




<script>
  function topFunction() {
    document.body.scrollTop = 0; // For Safari
    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
  } 
</script>

</body>
</html>
