<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"><!--<![endif]-->
<head>
    <meta name="google-site-verification" content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI" />
    <!-- Website Template designed by www.downloadwebsitetemplates.co.uk -->
    <!-- Modified to fit Cryogen.-->
    <meta charset="UTF-8">
    <title>Yet Another Useless Blog (YAUB): Openshift 4 and ServiceMesh 4 - Ingress with custom domain</title>
    
<meta name="keywords" content="DestinationRule,Loadbalancer,OCP,Canary,Grayscale,Mirror,kubectl,Istio,OpenShift,Service Mesh,oc">

<meta property="og:url" content="http://blog.stderr.at/posts-output/2020-03-31-Istio-Tutorial4/" />
<meta property="og:title" content="Openshift 4 and ServiceMesh 4 - Ingress with custom domain" />
<meta property="og:type" content="article" />

    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/ico/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/ico/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon-precomposed" sizes="128x128" href="/img/ico/apple-touch-icon-128x128.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/ico/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/ico/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/ico/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon-precomposed" href="/img/ico/apple-touch-icon-57x57.png">
    <link rel="shortcut icon" href="/img/ico/favicon.ico">
    <!--[if IE]><![endif]-->   
    <link href="/css/style.css" rel="stylesheet" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/tomorrow-night-eighties.min.css">
    <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/font-awesome-animation.min.css"> 

<style>
 .listingblock:hover .clipboard {
     display: block;
 }

 .clipboard {
     display: none;
     border: 0;
     font-size: .75em;
     text-transform: uppercase;
     font-weight: 500;
     padding: 6px;
     color: #999;
     position: absolute;
     top: .425rem;
     right: .5rem;
     background: transparent;
 }

 code + .clipboard {
     top: 2rem !important;
 }

 .clipboard:hover, .clipboard:focus, .clipboard:active {
     outline: 0;
     background-color: #eee9e6;
 }
</style>



</head>
<body>
<div id="left">

    <p id="logo">
        <a title="Yet Another Useless Blog (YAUB)" href="/">
            <span class="fa fa-cloud-upload faa-float animated"></span>
            <span class="text">YAUB</span>
            <span class="text small">Yet another Useless Blog</span>
        </a>
    </p>

    <div id="menucont" class="bodycontainer clearfix">
        <div class="menutitle">
            <p><span class="fa fa-reorder"></span><strong>Menu</strong></p>
        </div>
        <ul class="menu">
          <a class="left" title="Home" href="/">
            <li >Home</li>
          </a>

          <a class="left" title="Archives" href="/archives/">
            <li >Archives</li>
          </a>

            
            <a class="left" title="Tags" href="/tags/">
            <li >Tags</li>
            </a>
            
            
            
            <a class="left" href="/pages-output/Legal/">
            <li >
                Legal Disclosure
            </li>
            </a>
            
            <a class="left" title="RSS" href="/feed.xml">
            <li>RSS</li>
            </a>
        </ul>
    </div>

    <hr class="menuhr">
      <div id="menucont">
        <ul class="menu">
          <li>Recent Posts:</li>
          
            <a class="nospacing left" href="/posts-output/2020-04-03-Istio-Tutorial6/"><li class="smallpadding small">Openshift 4 and ServiceMesh 6 - Advanced Routing Example</li></a>
          
            <a class="nospacing left" href="/posts-output/2020-04-01-Istio-Tutorial5/"><li class="smallpadding small">Openshift 4 and ServiceMesh 5 - Routing Example</li></a>
          
            <a class="nospacing left" href="/posts-output/2020-04-01-oc-commands/"><li class="smallpadding small">Helpful oc / kubectl commands</li></a>
          
            <a class="nospacing left" href="/posts-output/2020-03-31-Istio-Tutorial4/"><li class="smallpadding small">Openshift 4 and ServiceMesh 4 - Ingress with custom domain</li></a>
          
            <a class="nospacing left" href="/posts-output/2020-03-30-Istio-Tutorial3/"><li class="smallpadding small">Openshift 4 and ServiceMesh 3 - Ingress Traffic</li></a>
          
        </ul>
      </div>
    <hr class="menuhr">
      <div id="menucont">
        <ul class="menu">
          <li>Links:</li>
          <a class="nospacing left" href="https://redhat.com" rel="external"><li class="smallpadding small">Red Hat</li></a>
          <a class="nospacing left" href="https://docs.openshift.com/" rel="external"><li class="smallpadding small">OpenShift Docs</li></a>
          <a class="nospacing left" href="https://github.com/stderrat/stderrat.github.io" rel="external"><li class="smallpadding small">Source</li></a>
            
        </ul>
      </div>
</div>

<div id="right" class="clearfix">
    
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <strong>31. März 2020</strong>
        
    </div>
    <h1>Openshift 4 and ServiceMesh 4 - Ingress with custom domain</h1>
</div>
<div>
    
    <div id="toc" class="toc"><div id="toctitle">Table of Contents</div><ul class="sectlevel1"><li><a href="#_modify_gateway_and_virtualservice">Modify Gateway and VirtualService</a></li><li><a href="#_optional_add_custom_domain_to_local_hosts_file">OPTIONAL: Add custom domain to local hosts file</a></li><li><a href="#_create_some_example_traffic">Create some example traffic</a></li></ul></div><!-- toc disabled --><div class="paragraph small"><p><em>Author: Thomas Jungbauer - Last Modified: 2020-04-06 08:53:43 +0200</em></p></div><div class="sect1"><h2 id="_modify_gateway_and_virtualservice">Modify Gateway and VirtualService</h2><div class="sectionbody"><div class="paragraph"><p><a href="/posts-output/2020-03-30-Istio-Tutorial3">Issue #3</a> explains how to get ingress traffic into the Service Mesh, by defining the <strong>Gateway</strong> and the <strong>VirtualService</strong>. We are currently using the default ingress route defined in the <em>istio_system</em> project.<br />
But what if a custom domain shall be used?<br />
In such case another route must be defined in the <em>istio-system</em> project and small configuration changes must be applied.
 <br /><br /></p></div><div class="olist arabic"><ol class="arabic"><li><p>First lets create a slightly modified <em>Gateway.yaml</em>:</p><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-gateway-exampleapp
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "hello-world.com" <i class="conum" data-value="1"></i><b>(1)</b></code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>add you custom domain here</td></tr></table></div><div class="paragraph"><p> <br />
The only difference is at the hosts which was changed from '*' to 'hello-world.com'</p></div></li><li><p>As second change, the VirtualService must be modified as well with the custom domain:</p><div class="paragraph"><p>VirtualService.yaml:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-gateway-exampleapp
spec:
  hosts:
  - "hello-world.com" <i class="conum" data-value="1"></i><b>(1)</b>
  gateways:
  - ingress-gateway-exampleapp
  http:
  - match:
    - uri:
        exact: /
    route:
    - destination:
        host: customer
        port:
          number: 8080</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>add you custom domain here</td></tr></table></div></li><li><p>Replace current objects in OpenShift:</p><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">oc replace -f Gateway.yaml -n tutorial
oc replace -f VirtualService.yaml -n tutorial</code></pre></div></div></li><li><p>Create a new route under the project <em>istio-system</em>:</p><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: hello-world.com <i class="conum" data-value="1"></i><b>(1)</b>
  namespace: istio-system <i class="conum" data-value="2"></i><b>(2)</b>
spec:
  host: hello-world.com <i class="conum" data-value="3"></i><b>(3)</b>
  to:
    kind: Service
    name: istio-ingressgateway <i class="conum" data-value="4"></i><b>(4)</b>
  port:
    targetPort: 8080</code></pre></div></div><div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>add you custom domain here</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>the route must be created at istio-system</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>add you custom domain here</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>this is the service as it was created by the operator</td></tr></table></div></li></ol></div></div></div><div class="sect1"><h2 id="_optional_add_custom_domain_to_local_hosts_file">OPTIONAL: Add custom domain to local hosts file</h2><div class="sectionbody"><div class="paragraph"><p>The custom domain <strong>hello-world.com</strong> must be resolvable somehow, pointing to the ingress router of OpenShift.
This can be done, by adding the domain into the local hosts file (with all limitations this brings with it)</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash"># Get IP address of:
oc -n istio-system get route istio-ingressgateway
echo "x.x.x.x hello-world.com" &gt;&gt; /etc/hosts</code></pre></div></div></div></div><div class="sect1"><h2 id="_create_some_example_traffic">Create some example traffic</h2><div class="sectionbody"><div class="paragraph"><p>We will reuse the script of <a href="posts-output/2020-03-30-Istio-Tutorial3">Issue #3</a> to simulate traffic.
Since we changed the domain, the connection will go to hello-world.com</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash">sh run-check.sh 1000 hello-world.com</code></pre></div></div><div class="paragraph"><p> <br /></p></div><div class="paragraph"><p>This will send 1000 requests to our application:</p></div><div class="listingblock hidecopy"><div class="content"><pre class="highlight"><code class="language-bash" data-lang="bash"># 0: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6626
# 1: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6627
# 2: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6628
# 3: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6629
# 4: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6630
# 5: customer =&gt; preference =&gt; recommendation v1 from 'f11b097f1dd0': 6631
...</code></pre></div></div></div></div>
</div>

<div id="post-tags">
    <br/> 
    <b>Tags: </b>
    
    <a href="/tags-output/OCP/">OCP</a>
    
    <a href="/tags-output/Istio/">Istio</a>
    
    <a href="/tags-output/OpenShift/">OpenShift</a>
    
    <a href="/tags-output/Service Mesh/">Service Mesh</a>
    
</div>

<br/>

    <div id="prev-next">
        
        <a class="button" href="/posts-output/2020-03-30-Istio-Tutorial3/">&laquo; Openshift 4 and ServiceMesh 3 - Ingress Traffic</a>
        
        
        <a class="right button" href="/posts-output/2020-04-01-oc-commands/">Helpful oc / kubectl commands &raquo;</a>
        
    </div>

    


</div>

<hr/>
<div id="footercont" class="small clearfix">Copyright &copy; 2020 Toni Schmidbauer &amp; Thomas Jungbauer
    <p>Powered by <a href="http://cryogenweb.org">Cryogen</a> | Free Website Template by <a title="free website templates" href="http://www.downloadwebsitetemplates.co.uk" rel="external">Download Website Templates</a></p>

</div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/clipboard.js" type="text/javascript"></script>
<script src="/js/clipboard.integration.js" type="text/javascript"></script>

<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
