<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Keycloak on TechBlog about OpenShift/Ansible/Satellite and much more</title><link>https://blog.stderr.at/tags/keycloak/</link><description>TechBlog about OpenShift/Ansible/Satellite and much more</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Toni Schmidbauer &amp; Thomas Jungbauer</copyright><lastBuildDate>Fri, 19 Sep 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.stderr.at/tags/keycloak/index.xml" rel="self" type="application/rss+xml"/><item><title>Advanced Cluster Security</title><link>https://blog.stderr.at/acs/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/acs/</guid><description/></item><item><title>Red Hat Quay Registry - Integrate Keycloak</title><link>https://blog.stderr.at/quay/2025-09-19-quay-integrate-keycloak/</link><pubDate>Fri, 19 Sep 2025 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/quay/2025-09-19-quay-integrate-keycloak/</guid><description>&lt;div class="paragraph">
&lt;p>This guide shows you how to configure Keycloak as an OpenID Connect (OIDC) provider for Red Hat Quay Registry. It covers what to configure in Keycloak, what to put into Quay’s config.yaml (or Operator config), how to verify the login flow, and how to switch your Quay initial/admin account (stored locally in Quay’s DB) to an admin user that authenticates via Keycloak.&lt;/p>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_prerequisites">Prerequisites&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Before starting this integration, ensure you have:&lt;/p>
&lt;/div>
&lt;div class="ulist">
&lt;ul>
&lt;li>
&lt;p>OpenShift cluster with admin access&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Red Hat Quay Registry 3.15+ installed (via Operator)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Red Hat build of Keycloak stable-v22+ installed and configured (via Operator)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Valid SSL certificates for both Quay and Keycloak&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Admin access to both Keycloak Admin Console and Quay configuration&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Basic understanding of OIDC/OAuth2 concepts&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
Here we are using the Quay Operator and the Keycloak Operator on OpenShift.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_quick_overview_what_happens">Quick overview (what happens)&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Create a Keycloak client for Quay (OIDC).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Configure Quay’s OIDC provider section in config.yaml to point to Keycloak (client id/secret, endpoints, scopes, claim names).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Restart Quay, test login via Keycloak. The first time an OIDC user logs in, Quay creates a local user record that is linked to the OIDC identity.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Promote that Quay user to superuser by adding their Quay username to SUPER_USERS (or use the UI/API).&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_keycloak_create_a_client_for_quay">Keycloak: create a client for Quay&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Steps in Keycloak Admin console:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Log in to the Keycloak Admin Console and select the realm you will use for Quay or create a new realm.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select that realm and go to clients&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Press &lt;strong>Create client&lt;/strong> to create and configure a new client for Quay. Not much must be configured here, but at least the following:&lt;/p>
&lt;div class="olist loweralpha">
&lt;ol class="loweralpha" type="a">
&lt;li>
&lt;p>Client type: OpenID Connect&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Client ID: quay-enterprise (The ID we will use in the Quay configuration as well)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Client authentication: ON&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Valid redirects URIs:&lt;/p>
&lt;div class="ulist">
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback" class="bare">https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>(Optional) &lt;a href="https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback/attach" class="bare">https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback/attach&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>(Optional) &lt;a href="https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback/cli" class="bare">https://&amp;lt;quay-hostname&amp;gt;/oauth2/&amp;lt;service-id&amp;gt;/callback/cli&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
The service-id is the parent key you’ll use in Quay config — e.g. keycloak.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="olist loweralpha">
&lt;ol class="loweralpha" type="a">
&lt;li>
&lt;p>Save the client.&lt;/p>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Go to Credentials and create or copy the &lt;strong>client secret&lt;/strong> you will use in Quay.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
&lt;strong>(Optional)&lt;/strong> If you intend to use groups/roles from Keycloak for Quay team synchronization, ensure your Keycloak users or groups are populated and that Keycloak includes group membership in tokens or exposes group claims (you may need to add a protocol mapper in the client to include groups or roles in the ID token or userinfo response). Refer to Keycloak docs for adding protocol mappers.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_keycloak_create_users_and_groups">Keycloak: create users and groups&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Go to Users and create a new user or use an existing one.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If you created a new user, set a password for them in the Credentials tab.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Go to Groups and create a new group or use an existing one.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You can assign users to that group.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_quay_add_oidc_configuration">Quay: add OIDC configuration&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Quay’s OIDC block is a nested object under &lt;strong>AUTHENTICATION_TYPE: OIDC&lt;/strong>. The parent key can be any name (e.g., KEYCLOAK_LOGIN_CONFIG) — Quay uses the parent key name to form the callback paths.&lt;/p>
&lt;/div>
&lt;div class="admonitionblock important">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-important" title="Important">&lt;/i>
&lt;/td>
&lt;td class="content">
The parent key name (before _LOGIN_CONFIG) must match the service-id used in Keycloak redirect URIs.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Example config.yaml snippet for Keycloak:&lt;/p>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
Using Quay Operator this configuration is stored as a secret in the namespace where Quay is installed.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">AUTHENTICATION_TYPE: OIDC &lt;i class="conum" data-value="1">&lt;/i>&lt;b>(1)&lt;/b>
KEYCLOAK_LOGIN_CONFIG: &lt;i class="conum" data-value="2">&lt;/i>&lt;b>(2)&lt;/b>
CLIENT_ID: quay-enterprise &lt;i class="conum" data-value="3">&lt;/i>&lt;b>(3)&lt;/b>
CLIENT_SECRET: &amp;lt;client-secret&amp;gt; &lt;i class="conum" data-value="4">&lt;/i>&lt;b>(4)&lt;/b>
LOGIN_SCOPES:
- openid
- email
- profile
- groups
OIDC_SERVER: https://&amp;lt;keycloak hostname&amp;gt;/realms/quay/ &lt;i class="conum" data-value="5">&lt;/i>&lt;b>(5)&lt;/b>
SERVICE_NAME: keycloak &lt;i class="conum" data-value="6">&lt;/i>&lt;b>(6)&lt;/b>
PREFERRED_USERNAME_CLAIM_NAME: preferred_username
VERIFIED_EMAIL_CLAIM_NAME: email
PREFERRED_GROUP_CLAIM_NAME: groups
OIDC_DISABLE_USER_ENDPOINT: false &lt;i class="conum" data-value="7">&lt;/i>&lt;b>(7)&lt;/b>&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="colist arabic">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td>&lt;i class="conum" data-value="1">&lt;/i>&lt;b>1&lt;/b>&lt;/td>
&lt;td>Set this parameter to &lt;strong>OIDC&lt;/strong>.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="2">&lt;/i>&lt;b>2&lt;/b>&lt;/td>
&lt;td>parent key name can be any string (use KEYCLOAK_LOGIN_CONFIG here). This is important, and the part in front of _LOGIN_CONFIG must match the service-id you used in Keycloak.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="3">&lt;/i>&lt;b>3&lt;/b>&lt;/td>
&lt;td>The client id you used in Keycloak.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="4">&lt;/i>&lt;b>4&lt;/b>&lt;/td>
&lt;td>The client secret you used in Keycloak.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="5">&lt;/i>&lt;b>5&lt;/b>&lt;/td>
&lt;td>The realm base URL (no trailing /protocol…​), e.g.:
&lt;a href="https://&amp;lt;keycloak_hostname&amp;gt;/realms/quay/" class="bare">https://&amp;lt;keycloak_hostname&amp;gt;/realms/quay/&lt;/a> — Quay will discover .well-known/openid-configuration endpoints automatically.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="6">&lt;/i>&lt;b>6&lt;/b>&lt;/td>
&lt;td>The service name you used in Keycloak.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="7">&lt;/i>&lt;b>7&lt;/b>&lt;/td>
&lt;td>Set this parameter to &lt;strong>false&lt;/strong> to allow Quay to fetch user information from Keycloak. If using Azure Entra ID set this to &lt;strong>true&lt;/strong>.&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Since we are using Quay Operator, the operator will pick up the changes automatically and restart Quay.
If you are using a standalone Quay installation, you need to restart Quay for the change to take effect. (Config is not hot-reloaded.)&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_testing_login">Testing Login&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Let’s do some tests to verify the configuration.
Above we have created some users and groups in Keycloak. Let’s try to log in with one of them.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Open your Quay UI ( &lt;a href="https://&amp;lt;quay_hostname&amp;gt;" class="bare">https://&amp;lt;quay_hostname&amp;gt;&lt;/a>; ) in a browser. On the login page you should see the external login option labelled Keycloak (or the SERVICE_NAME you set).&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/quay/images/quay-login-oidc.png?width=320" alt="quay login oidc"/>
&lt;/div>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic" start="2">
&lt;li>
&lt;p>Click the &amp;#34;Sign in with Keycloak&amp;#34; option. and you will be redirected to Keycloak’s login screen. Here you can authenticate with a Keycloak user.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/quay/images/quay-keycloak.png?width=320" alt="quay keycloak"/>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>After successful authentication, Keycloak redirects back to Quay and Quay creates a local user mapped to the OIDC claims (username, email). If you set USERNAME_CLAIM to preferred_username, look at the created Quay username in the UI under your user’s profile.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_make_the_keycloak_user_a_quay_admin">Make the Keycloak user a Quay admin&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>In Quay only one identity provider can be used at a time. If you previously set up a local admin account, you need to make a Keycloak user a Quay admin by adding their Quay username to SUPER_USERS where all administrators are listed.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>In the Quay configuration, you can define administrators using the SUPER_USERS array.&lt;/p>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
Make sure the Keycloak user has logged in once so Quay has created a local user record
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Edit the Quay configuration once more and add the Quay username (exact username created by Quay).&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>For example, let’s say we have created a user called &amp;#34;alice&amp;#34; in Keycloak. We need to add this user to the SUPER_USERS array.&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">SETUP_COMPLETE: true
SUPER_USERS:
- admin # existing local admin (optional)
- alice # alice is the Quay username created from Keycloak login&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>After restart, the Quay account alice will have superuser privileges (same as if created in the UI).&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_working_with_podman_on_cli">Working with Podman on CLI&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Now, as we changed the authentication method, we need to verify if we can push/pull images from/to the registry.
The command line tool of the choice is &lt;strong>podman&lt;/strong>.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>However, podman does not redirect to SSO login, so it needs a token to authenticate. We can generate a new token for a user in the Quay UI.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>In the Quay UI, go to the &lt;strong>Account Settings&lt;/strong> (upper right corner)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>In the settings section, under &lt;strong>Docker CLI and other Application Tokens&lt;/strong>, click on &lt;strong>Create Application Token&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Enter a name for the token&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select the newly created token and copy the podman login command (or any other command you need)&lt;/p>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/quay/images/quay-app-pass.png?width=320" alt="quay app pass"/>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>The command for podman will look like this:&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">podman login -u=&amp;#39;$app&amp;#39; -p=&amp;#39;&amp;lt;token&amp;gt;&amp;#39; &amp;lt;quay-url&amp;gt;
Login Succeeded!&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Now you can push/pull images from/to the registry.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_troubleshooting">Troubleshooting&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Common issues and their solutions:&lt;/p>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_redirect_uri_mismatch">Redirect URI Mismatch&lt;/h3>
&lt;div class="paragraph">
&lt;p>&lt;strong>Problem&lt;/strong>: Keycloak returns &amp;#34;Invalid redirect URI&amp;#34; error&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>&lt;strong>Solution&lt;/strong>: Ensure all three redirect URIs are configured in Keycloak client:&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code>https://&amp;lt;quay-hostname&amp;gt;/oauth2/keycloak/callback
https://&amp;lt;quay-hostname&amp;gt;/oauth2/keycloak/callback/attach
https://&amp;lt;quay-hostname&amp;gt;/oauth2/keycloak/callback/cli&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_username_mapping_issues">Username Mapping Issues&lt;/h3>
&lt;div class="paragraph">
&lt;p>&lt;strong>Problem&lt;/strong>: Quay creates unexpected usernames&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>&lt;strong>Solution&lt;/strong>:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Check which claim Keycloak sends: inspect ID token in browser dev tools&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Common claims: preferred_username, email, sub, name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Update PREFERRED_USERNAME_CLAIM_NAME in Quay config accordingly&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_ssl_certificate_issues">SSL Certificate Issues&lt;/h3>
&lt;div class="paragraph">
&lt;p>&lt;strong>Problem&lt;/strong>: Quay cannot reach Keycloak due to TLS verification errors&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>&lt;strong>Solutions&lt;/strong>:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Install your internal CA certificate in the Quay container&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Use publicly trusted certificates for both services&lt;/p>
&lt;/li>
&lt;li>
&lt;p>For testing only: disable SSL verification (not recommended for production)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_authentication_flow_failures">Authentication Flow Failures&lt;/h3>
&lt;div class="paragraph">
&lt;p>&lt;strong>Problem&lt;/strong>: Login redirects but fails to create user in Quay&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>&lt;strong>Debugging steps&lt;/strong>:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Check Quay logs: &lt;code>oc logs deployment/quay-app&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Verify OIDC discovery endpoint: &lt;code>&lt;a href="https://&amp;lt;keycloak&amp;gt;/realms/&amp;lt;realm&amp;gt;/.well-known/openid-configuration" class="bare">https://&amp;lt;keycloak&amp;gt;/realms/&amp;lt;realm&amp;gt;/.well-known/openid-configuration&lt;/a>&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Confirm client secret matches between Keycloak and Quay&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Test with curl: &lt;code>curl -k &lt;a href="https://&amp;lt;keycloak&amp;gt;/realms/&amp;lt;realm&amp;gt;/.well-known/openid-configuration" class="bare">https://&amp;lt;keycloak&amp;gt;/realms/&amp;lt;realm&amp;gt;/.well-known/openid-configuration&lt;/a>&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_conclusion">Conclusion&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Integrating Quay 3.15 with Keycloak via OIDC centralizes authentication, simplifies user management, and allows you to leverage enterprise identity features. The key steps are straightforward: create a Keycloak client with the correct redirect URIs, configure the corresponding OIDC block in Quay’s config.yaml.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>By switching the initial database-backed admin to an identity managed in Keycloak, you reduce the risk of “orphaned” local accounts and align Quay administration with your organization’s identity and access management strategy.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div></description></item><item><title>Advanced Cluster Security - Authentication</title><link>https://blog.stderr.at/acs/2021-12-11-acsauth/</link><pubDate>Sat, 11 Dec 2021 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/acs/2021-12-11-acsauth/</guid><description>&lt;div class="paragraph">
&lt;p>Red Hat Advanced Cluster Security (RHACS) Central is installed with one administrator user by default. Typically, customers request an integration with existing Identity Provider(s) (IDP). RHACS offers different options for such integration. In this article 2 IDPs will be configured as an example. First OpenShift Auth and second Red Hat Single Sign On (RHSSO) based on Keycloak&lt;/p>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_prerequisites">Prerequisites&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>OpenShift 4 Cluster&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Advanced Cluster Security v3.66+&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Red Hat SSO Operator installed&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="admonitionblock warning">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-warning" title="Warning">&lt;/i>
&lt;/td>
&lt;td class="content">
While RHSSO will be installed during this article, only default and example values are used. These are by no means examples for a production system.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_introduction">Introduction&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Advanced Cluster Security comes with several default roles, which can be assigned to users:&lt;/p>
&lt;/div>
&lt;table class="tableblock frame-all grid-all stretch">
&lt;colgroup>
&lt;col style="width: 33.3333%;"/>
&lt;col style="width: 66.6667%;"/>
&lt;/colgroup>
&lt;thead>
&lt;tr>
&lt;th class="tableblock halign-left valign-top">System role&lt;/th>
&lt;th class="tableblock halign-left valign-top">Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Admin&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">This role is targeted for administrators. Use it to provide read and write access to all resources.&lt;/p>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Analyst&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">This role is targeted for a user who cannot make any changes, but can view everything. Use it to provide read-only access for all resources.&lt;/p>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Continuous Integration&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">This role is targeted for CI (continuous integration) systems and includes the permission set required to enforce deployment policies.&lt;/p>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">None&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">This role has no read and write access to any resource. You can set this role as the minimum access role for all users.&lt;/p>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Sensor Creator&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Red Hat Advanced Cluster Security for Kubernetes uses this role to automate new cluster setups. It includes the permission set to create Sensors in secured clusters.&lt;/p>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">Scope Manager&lt;/p>&lt;/td>
&lt;td class="tableblock halign-left valign-top">&lt;p class="tableblock">This role includes the minimum permissions required to create and modify access scopes.&lt;/p>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
It is possible to create custom roles.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_configure_rhacs_authentication_openshift_auth">Configure RHACS Authentication: OpenShift Auth&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
It is assumed that RHACS is already installed and login to the Central UI is available.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Login to your RHACS and select “Platform Configuration” &amp;gt; “Access Control”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>From the drop down menu &lt;strong>Add auth provider&lt;/strong> select &lt;strong>OpenShift Auth&lt;/strong>&lt;/p>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-AuthProvider.png?width=940px" alt="ACS AuthProvider"/>
&lt;/div>
&lt;div class="title">Figure 1. ACS Auth Provider&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Enter a &lt;strong>Name&lt;/strong> for your provider and select a default role which is assigned to any user who can authenticate.&lt;/p>
&lt;div class="paragraph">
&lt;p>It is recommended to select the role &lt;strong>None&lt;/strong>, so new accounts will have no privileges in RHACS.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>With Rules you can assign roles to specific users, based on their userid, name, mail address or groups.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>For example the user with the name &lt;strong>poweruser&lt;/strong> gets the role &lt;strong>Admin&lt;/strong> assigned.&lt;/p>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_verify_authentication_with_openshift_auth">Verify Authentication with OpenShift Auth&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Logout from the Central UI and reload the browser.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select from the drop down &lt;strong>OpenShift Auth&lt;/strong>&lt;/p>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-LoginOpenShiftAuth.png?width=420px" alt="ACS LoginOpenShiftAuth"/>
&lt;/div>
&lt;div class="title">Figure 2. ACS Login&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Try to login with a valid OpenShift user.&lt;br/>
Depending on the Rules which have been defined during previous steps the appropriate permissions should be assigned.&lt;br/>
For example: If you login as user &lt;strong>poweruser&lt;/strong> the role &lt;strong>Admin&lt;/strong> is assigned.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;hr/>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_configure_red_hat_single_sign_on">Configure Red Hat Single Sign On&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>The following steps will create some basic example objects to an existing RHSSO or Keycloak to test the authentication at RHACS.
Skip to step #5 if you have Keycloak already up and running and would like to reuse an existing client.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The RHSSO operator (or Keycloak) is installed at the namespace &lt;strong>single-sign-on&lt;/strong>.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Create an instance of Keycloak&lt;/p>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">apiVersion: keycloak.org/v1alpha1
kind: Keycloak
metadata:
name: example-keycloak
namespace: single-sign-on
spec:
externalAccess:
enabled: true
instances: 1&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Create a Realm&lt;br/>
This will create a Realm called &lt;strong>Basic&lt;/strong>&lt;/p>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">apiVersion: keycloak.org/v1alpha1
kind: KeycloakRealm
metadata:
name: example-keycloakrealm
namespace: single-sign-on
spec:
instanceSelector:
matchLabels:
app: sso
realm:
displayName: Basic Realm
enabled: true
id: basic
realm: basic&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Login into Red Hat SSO&lt;br/>
Get the route to your RHSSO instance:&lt;/p>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">oc get route keycloak -n single-sign-on --template=&amp;#39;{{ .spec.host }}&amp;#39;
# keycloak-single-sign-on.apps.cluster-29t8z.29t8z.sandbox677.opentlc.com&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>and log into the Administration Interface.&lt;/p>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Extract the admin password for Keycloak&lt;/p>
&lt;div class="paragraph">
&lt;p>The secret name is build from &amp;#34;credential&amp;#34;&amp;lt;keycloak-instance-name&amp;gt;&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">oc extract secret/credential-example-keycloak -n single-sign-on --to=-
# ADMIN_PASSWORD
&amp;lt;you password&amp;gt;
# ADMIN_USERNAME
admin&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Be sure to select your Realm (&lt;strong>Basic&lt;/strong> in our case), goto &lt;strong>Clients&lt;/strong> and select a ClientID.&lt;/p>
&lt;div class="olist loweralpha">
&lt;ol class="loweralpha" type="a">
&lt;li>
&lt;p>In this example we select &lt;strong>account&lt;/strong>&lt;/p>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-SSOClientConfig.png?width=640px" alt="ACS SSOClientConfig"/>
&lt;/div>
&lt;div class="title">Figure 3. ACS Login&lt;/div>
&lt;/div>
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
Of course you can create or use any other Client.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Enable the option &lt;strong>Implicit Flow&lt;/strong>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Get the &lt;strong>Issuer URL&lt;/strong> from your realm. This is typically your:&lt;br/>
&lt;a href="https://&amp;lt;KEYCLOAK_URL&amp;gt;/auth/realms/&amp;lt;REALM_NAME&amp;gt;" class="bare">https://&amp;lt;KEYCLOAK_URL&amp;gt;/auth/realms/&amp;lt;REALM_NAME&amp;gt;&lt;/a>;&lt;/p>
&lt;div class="paragraph">
&lt;p>For Example:
&lt;a href="https://keycloak-single-sign-on.apps.cluster-29t8z.29t8z.sandbox677.opentlc.com/auth/realms/basic" class="bare">https://keycloak-single-sign-on.apps.cluster-29t8z.29t8z.sandbox677.opentlc.com/auth/realms/basic&lt;/a>&lt;/p>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_create_test_users">Create Test Users&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>In RHSSO create 2 user accounts to test the authentication later.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Goto &lt;strong>Users&lt;/strong> and create the users:&lt;/p>
&lt;div class="olist loweralpha">
&lt;ol class="loweralpha" type="a">
&lt;li>
&lt;p>User: acsadmin&lt;/p>
&lt;div class="paragraph">
&lt;p>First Name: acsadmin&lt;/p>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>User: user1&lt;/p>
&lt;div class="paragraph">
&lt;p>First Name: user 1&lt;/p>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="paragraph">
&lt;p>&lt;strong>You can set any other values for these users. However, be sure to set a password for both, after they have been created.&lt;/strong>&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_configure_rhacs_authentication_rhsso">Configure RHACS Authentication: RHSSO&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="admonitionblock note">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-note" title="Note">&lt;/i>
&lt;/td>
&lt;td class="content">
It is assumed that RSACS is already installed and login to the Central UI is available.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Login to your RHACS and select “Platform Configuration” &amp;gt; “Access Control”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>From the drop down menu &lt;strong>Add auth provider&lt;/strong> select &lt;strong>OpenID Connect&lt;/strong>&lt;/p>
&lt;div class="olist loweralpha">
&lt;ol class="loweralpha" type="a">
&lt;li>
&lt;p>Enter a “Name” for your provider i.e. “Single Sign On”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Leave the “Callback Mode” to the “Auto-Select” setting&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Enter your Issuer URL&lt;/p>
&lt;/li>
&lt;li>
&lt;p>As Client ID enter &lt;strong>account&lt;/strong> (or the ClientID you would like to use)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Leave the Client Secret empty and select the checkbox &lt;strong>Do not use Client Secret&lt;/strong> which is good enough for our tests.&lt;/p>
&lt;div class="paragraph">
&lt;p>Remember the two callback URL from the blue box. They must be configured in Keycloak.&lt;/p>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Select a default role which is assigned to any user who can authenticate.&lt;/p>
&lt;div class="paragraph">
&lt;p>It is recommended to select the role &lt;strong>None&lt;/strong>, so new accounts will have no privileges in RHACS.&lt;/p>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>With Rules you can assign roles to specific users, based on their userid, name, mail address or groups.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>For example the user with the name &lt;strong>acsadmin&lt;/strong> (which have been created previously in our RHSSO) gets the role &lt;strong>Admin&lt;/strong> assigned.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The final settings are depict in the following image:&lt;/p>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-OpenIDConfig.png?width=640px" alt="ACS OpenIDConfig"/>
&lt;/div>
&lt;div class="title">Figure 4. ACS Login&lt;/div>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_continue_rhsso_configuration">Continue RHSSO Configuration&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>What is left to do is the configuration of redirect URLs. These URLs are shown in the ACS Authentication Provider configuration (see blue field in the image above)&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Log back into RHSSO and select “Clients” &amp;gt; “account”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Into &lt;strong>Valid Redirect URLs&lt;/strong> enter the two URLs which you saved from the blue box in the RHACS configuration.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_troubleshoot_test_login">Troubleshoot: Test Login&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>In RHACS you can test the login to you SSO.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Goto &amp;#34;Platform Configuration&amp;#34; &amp;gt; &amp;#34;Access Control&amp;#34;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Click the button &amp;#34;Test login&amp;#34;&lt;/p>
&lt;div class="paragraph">
&lt;p>A popup will appear which asks you to enter SSO credentials. The connection to RHSSO will be validated:&lt;/p>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-TestSSOAuth.png?width=420px" alt="ACS TestSSOAuth"/>
&lt;/div>
&lt;div class="title">Figure 5. ACS Test SSO&lt;/div>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_verify_authentication_with_openshift_auth_2">Verify Authentication with OpenShift Auth&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Logout from the Central UI and reload the browser.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select from the drop down &lt;strong>Single Sign On&lt;/strong>&lt;/p>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/acs/images/ACS-LoginSSOAuth.png?width=420px" alt="ACS LoginSSOAuth"/>
&lt;/div>
&lt;div class="title">Figure 6. ACS Login SSO&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>Try to login with a valid SSO user.&lt;br/>
Depending on the Rules which have been defined during previous steps the appropriate permissions should be assigned.&lt;br/>
For example: If you login as user &lt;strong>acsadmin&lt;/strong> the role &lt;strong>Admin&lt;/strong> is assigned.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div></description></item></channel></rss>