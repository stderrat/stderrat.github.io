<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Cluster Update on TechBlog about OpenShift/Ansible/Satellite and much more</title><link>https://blog.stderr.at/tags/cluster-update/</link><description>TechBlog about OpenShift/Ansible/Satellite and much more</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Toni Schmidbauer &amp; Thomas Jungbauer</copyright><lastBuildDate>Fri, 07 Jun 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.stderr.at/tags/cluster-update/index.xml" rel="self" type="application/rss+xml"/><item><title>Update Cluster Version using GitOps approach</title><link>https://blog.stderr.at/gitopscollection/2024-06-07-update-cluster-version-with-gitops/</link><pubDate>Fri, 07 Jun 2024 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/gitopscollection/2024-06-07-update-cluster-version-with-gitops/</guid><description>&lt;div class="paragraph">
&lt;p>During a GitOps journey at one point, the question arises, how to update a cluster? Nowadays it is very easy to update a cluster using CLI or WebUI, so why bother with GitOps in that case? The reason is simple: Using GitOps you can be sure that all clusters are updated to the correct, required version and the version of each cluster is also managed in Git.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>All you need is the &lt;strong>channel&lt;/strong> you want to use and the desired cluster &lt;strong>version&lt;/strong>. Optionally, you can define the exact image SHA. This might be required when you are operating in a restricted environment.&lt;/p>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_overview">Overview&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Since OpenShift 4 it is very easy to update a cluster. It can either be done using the Web UI &lt;strong>Administration → Cluster Settings&lt;/strong> or via the command line using the command &lt;code>oc adm upgrade&lt;/code>.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>There are 2 main configurations for an upgrade:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>&lt;strong>channel&lt;/strong>: This declares the update strategy tied to versions of OpenShift.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The &lt;strong>desired version&lt;/strong>: This is the target version the cluster should be updated to.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;div class="paragraph">
&lt;p>To get the current clusterversion you can use the following command:&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">❯ oc get clusterversion
NAME VERSION AVAILABLE PROGRESSING SINCE STATUS
version 4.14.1 True False 4m38s Cluster version is 4.14.1&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Here we can see that the version is currently &lt;strong>4.14.1&lt;/strong> and no upgrade is currently progressing.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Now we want to update to the latest possible version.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_where_to_find_the_available_updates">Where to find the available updates?&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Before you start the update, you will need to fetch the possible available updates.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>This information can be gathered with the command &lt;code>oc adm upgrade&lt;/code> or &lt;code>oc get clusterversion/version -o yaml&lt;/code>.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The output will look like the following:&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">Cluster version is 4.14.1
Upstream is unset, so the cluster will use an appropriate default.
Channel: stable-4.14 (available channels: candidate-4.14, eus-4.14, fast-4.14, stable-4.14, candidate-4.15, fast-4.15, stable-4.15) &lt;i class="conum" data-value="1">&lt;/i>&lt;b>(1)&lt;/b>
Recommended updates: &lt;i class="conum" data-value="2">&lt;/i>&lt;b>(2)&lt;/b>
VERSION IMAGE
4.14.27 quay.io/openshift-release-dev/ocp-release@sha256:4d30b359aa6600a89ed49ce6a9a5fdab54092bcb821a25480fdfbc47e66af9ec
4.14.26 quay.io/openshift-release-dev/ocp-release@sha256:4fe7d4ccf4d967a309f83118f1a380a656a733d7fcee1dbaf4d51752a6372890
[...]&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="colist arabic">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td>&lt;i class="conum" data-value="1">&lt;/i>&lt;b>1&lt;/b>&lt;/td>
&lt;td>Current Channel and available channels&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;i class="conum" data-value="2">&lt;/i>&lt;b>2&lt;/b>&lt;/td>
&lt;td>List of available updates&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The command describes the current channel (stable-4.14) and a list of possible updates.
(The list is much longer).&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The latest available version is &lt;strong>4.14.27&lt;/strong> and the list of possible channels is all the 4.14 channels, but also 4.15 channels. This means we could change the channel here as well.&lt;/p>
&lt;/div>
&lt;div class="admonitionblock caution">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-caution" title="Caution">&lt;/i>
&lt;/td>
&lt;td class="content">
It is your responsibility to find the &lt;strong>correct and supported upgrade paths&lt;/strong>. Not all upgrades to any version are supported. Also, do not rely on consecutive path numbers, some versions were never available.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_channels">Channels&lt;/h3>
&lt;div class="paragraph">
&lt;p>Channels help users to define the timing and level of support for their environment. The following channels typically exist:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>&lt;strong>fast&lt;/strong>: This channel is fully supported but not yet fully tested and can be used to quickly update to the latest GA release. For example, when a certain bug is triggered in the current version.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>stable&lt;/strong>: This is the latest stable version. Versions here are added after enough data points have been collected and therefore have some delay.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>candidate&lt;/strong>: This channel offers &lt;strong>unsupported&lt;/strong> early access to specific versions.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>eus&lt;/strong>: All even-numbered versions offer an Externed Update Support (EUS) channel. They allow EUS-to-EUS updates and have a longer support phase.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_helm_chart_update_clusterversion">Helm Chart - update-clusterversion&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>Now we want to update the version to the latest of the current channel &lt;strong>4.14.27&lt;/strong> and change the channel to &lt;strong>stable-4.15&lt;/strong>.
The Helm Chart &lt;a href="https://github.com/tjungbauer/helm-charts/tree/main/charts/update-clusterversion" target="_blank" rel="noopener">update-clusterversion&lt;/a> has been created to help with a cluster update.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>It will modify the clusterversion resource.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The required values are quite simple:&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-yaml" data-lang="yaml">channel: stable-4.15
desiredVersion: 4.14.27
image: &amp;#39;&amp;#39;&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="admonitionblock caution">
&lt;table>
&lt;tbody>&lt;tr>
&lt;td class="icon">
&lt;i class="fa icon-caution" title="Caution">&lt;/i>
&lt;/td>
&lt;td class="content">
Be sure that you choose the correct and available updates.
&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/div>
&lt;div class="paragraph">
&lt;p>This is everything we need. As soon as this is synchronized into the cluster, the update process will be started by the cluster.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_gitops_synchronization">GitOps Synchronization&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>When we verify the current version in the OpenShift UI, we will see the possibility of an upgrade:&lt;/p>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/gitopscollection/images/clusterversion.png?width=720px" alt="Cluster before the update process starts"/>
&lt;/div>
&lt;div class="title">Figure 1. Cluster before the update process starts&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>In OpenShift GitOps we have the Application to start the update process:&lt;/p>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/gitopscollection/images/clusterversion-sync.png?width=720px" alt="Syncing new version"/>
&lt;/div>
&lt;div class="title">Figure 2. Syncing new version&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>After a few seconds OpenShift will start with the update:&lt;/p>
&lt;/div>
&lt;div class="imageblock">
&lt;div class="content">
&lt;img src="https://blog.stderr.at/gitopscollection/images/clusterversion-update-progressing.png?width=720px" alt="Progressing Cluster Update"/>
&lt;/div>
&lt;div class="title">Figure 3. Progressing Cluster Update&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>This can also be verified via the command line&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">❯ oc get clusterversion
NAME VERSION AVAILABLE PROGRESSING SINCE STATUS
version 4.14.1 True True 95s Working towards 4.14.27: 116 of 860 done (13% complete), waiting on etcd, kube-apiserver&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Eventually, the cluster update process finishes successfully. We are now on version &lt;strong>4.14.27&lt;/strong> and using the channel &lt;strong>stable-4.15&lt;/strong>.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>We can see that the next upgrade with be to version 4.15.15. This means we can directly upgrade to this version. This is possible because we switched the channel to stable-4.15.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Other channels, like candidate-4.15 might offer different, but not recommended, versions.&lt;/p>
&lt;/div>
&lt;div class="listingblock">
&lt;div class="content">
&lt;pre class="highlight">&lt;code class="language-bash" data-lang="bash">❯ oc adm upgrade
Cluster version is 4.14.27
Upstream is unset, so the cluster will use an appropriate default.
Channel: stable-4.15 (available channels: candidate-4.14, candidate-4.15, eus-4.14, fast-4.14, fast-4.15, stable-4.14, stable-4.15)
Recommended updates:
VERSION IMAGE
4.15.15 quay.io/openshift-release-dev/ocp-release@sha256:bb1182cd9001d6811dea8c5823235c17b9a316cce3bb13c51325250c14b46787&lt;/code>&lt;/pre>
&lt;/div>
&lt;/div>
&lt;div class="sect2">
&lt;h3 id="_what_about_the_sha_for_the_image">What about the SHA for the image?&lt;/h3>
&lt;div class="paragraph">
&lt;p>The SHA for the image field in the ClusterVersion resource is required in certain scenarios to provide a precise reference to the container image that represents the OpenShift version you want to update to.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Such scenarios could be for example:&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>Offline or Restricted Networks
In environments where clusters are running in offline or restricted network conditions, specifying the exact image SHA ensures that the cluster updates to a specific, known image that has been pre-pulled and is available within the network.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Precise Version Control
Using the SHA ensures that the exact image version is used for the update, providing a higher level of precision and control.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Custom or Private Registries
If you are using custom or private container registries, specifying the image SHA can help avoid ambiguities and ensure that the correct image is pulled from the correct registry.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Specific Compliance or Security Requirements
Some regulations might require precise specification of container images, including SHAs, to ensure traceability and verifiability of the software components being deployed.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="sect1">
&lt;h2 id="_conclusion">Conclusion&lt;/h2>
&lt;div class="sectionbody">
&lt;div class="paragraph">
&lt;p>With this very simple method, it is easy to manage the version of multiple clusters via GitOps. Especially, where there is a bigger cluster fleet it will become essential to ensure which cluster has which version.
Disconnected environments can also use the &lt;strong>image&lt;/strong> setting to specify the exact SHA of an available update.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>The current Helm Chart is very small and limited. It was created to quickly show the main use case: a simple and straightforward cluster upgrade.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Other possible options that might be required in the future. If you find anything missing, please let me know.&lt;/p>
&lt;/div>
&lt;div class="paragraph">
&lt;p>Please note, to always verify which version and channel is available and always consult the official documentation before an upgrade to find the latest release notes.&lt;/p>
&lt;/div>
&lt;div class="olist arabic">
&lt;ol class="arabic">
&lt;li>
&lt;p>References: &lt;a href="https://docs.openshift.com/container-platform/4.15/updating/understanding_updates/intro-to-updates.html" target="_blank" rel="noopener">Updating Clusters&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div></description></item></channel></rss>