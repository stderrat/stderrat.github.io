<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Runtime Security on TechBlog about OpenShift/Ansible/Satellite and much more</title><link>https://blog.stderr.at/openshift-platform/security/runtime-security/</link><description>TechBlog about OpenShift/Ansible/Satellite and much more</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Toni Schmidbauer &amp; Thomas Jungbauer</copyright><atom:link href="https://blog.stderr.at/openshift-platform/security/runtime-security/index.xml" rel="self" type="application/rss+xml"/><item><title>Running Falco on OpenShift 4.12</title><link>https://blog.stderr.at/openshift-platform/security/runtime-security/2023-11-26-running-falco/</link><pubDate>Sun, 26 Nov 2023 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/openshift-platform/security/runtime-security/2023-11-26-running-falco/</guid><description>&lt;p&gt;
As mentioned in our &lt;a href="https://blog.stderr.at/openshift/2023-10-23-openshift-falco/"&gt;previous post&lt;/a&gt; about &lt;a href="https://falco.org/"&gt;Falco&lt;/a&gt;, Falco is a security
tool to monitor kernel events like system calls or Kubernetes audit
logs to provide real-time alerts.&lt;/p&gt;
&lt;p&gt;
In this post I&amp;#39;ll show to customize Falco for a specific use case.
We would like to monitor the following events:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An interactive shell is opened in a container&lt;/li&gt;
&lt;li&gt;Log all commands executed in an interactive shell in a container&lt;/li&gt;
&lt;li&gt;Log read and writes to files within an interactive shell inside a container&lt;/li&gt;
&lt;li&gt;Log commands execute via `kubectl/oc exec` which leverage the
&lt;code&gt;pod/exec&lt;/code&gt; K8s endpoint&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;
The rules we created for those kind of events are available &lt;a href="https://raw.githubusercontent.com/tosmi-gitops/openshift-gitops/main/components/apps/falco/overlays/custom-rules/falco-extra-rules.yaml"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div id="outline-container-headline-1" class="outline-2"&gt;
&lt;h2 id="headline-1"&gt;
Deploying custom rules and disabling the default ruleset
&lt;/h2&gt;
&lt;div id="outline-text-headline-1" class="outline-text-2"&gt;
&lt;p&gt;
Falco comes with a quite elaborate ruleset for creating security
relevant events. But for our use case we just want to deploy a
specific set of rules (see the list above).&lt;/p&gt;
&lt;p&gt;
As we are deploying Falco via &lt;a href="https://github.com/falcosecurity/charts"&gt;Helm&lt;/a&gt;, we use the following values for
`rules_files`:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falco&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;rules_file&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;/etc/falco/extra-rules.d&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;/etc/falco/rules.d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
This instructs Falco to only load rules from the directories mentioned
above.&lt;/p&gt;
&lt;p&gt;
We use a &lt;span style="text-decoration: underline;"&gt;Kustomize&lt;/span&gt; &lt;code&gt;configMapGenerator&lt;/code&gt; to create a Kubernetes &lt;code&gt;ConfigMap&lt;/code&gt;
from our custom rules file:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;configMapGenerator&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-extra-rules&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;options&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;disableNameSuffixHash&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;files&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;falco-extra-rules.yaml&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
The complete &lt;span style="text-decoration: underline;"&gt;Kustomize&lt;/span&gt; configuration is &lt;a href="https://raw.githubusercontent.com/tosmi-gitops/openshift-gitops/main/components/apps/falco/overlays/custom-rules/kustomization.yaml"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;
Furthermore we instruct Falco to mount our custom rule &lt;code&gt;ConfigMap&lt;/code&gt;
created above in the Helm values file:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;mounts&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;volumes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-extra-rules-volume&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;optional&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;configMap&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-extra-rules&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;volumeMounts&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f92672"&gt;mountPath&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;/etc/falco/extra-rules.d&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-extra-rules-volume&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
The complete Helm values files is available &lt;a href="https://raw.githubusercontent.com/tosmi-gitops/openshift-gitops/main/components/apps/falco/base/values.yaml"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-2" class="outline-2"&gt;
&lt;h2 id="headline-2"&gt;
Disable automatic rule updates
&lt;/h2&gt;
&lt;div id="outline-text-headline-2" class="outline-text-2"&gt;
&lt;p&gt;
Falco updates all rules when it starts (via an &lt;span style="text-decoration: underline;"&gt;initContainer&lt;/span&gt;) and also
updates those rules on a regular basis. We would also like to disable
this behavior:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falcoctl&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;artifact&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;install&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;follow&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-3" class="outline-2"&gt;
&lt;h2 id="headline-3"&gt;
Create events for &lt;span style="text-decoration: underline;"&gt;kubectl/oc exec&lt;/span&gt;
&lt;/h2&gt;
&lt;div id="outline-text-headline-3" class="outline-text-2"&gt;
&lt;p&gt;
One problem problem is monitoring pod exec events. Using Falcos eBPF
monitoring capabilities we found no way to limit those events to pod
exec&amp;#39;s. This might be because the Falco rule language is new to us
and maybe there is a way to use eBPF filtering. Just let us know if
you find a solution!&lt;/p&gt;
&lt;p&gt;
But we came up with a different way of capturing pod/exec events:&lt;/p&gt;
&lt;p&gt;
Falco also allows monitoring Kubernetes audit events, logged by the
&lt;code&gt;kube-apiserver&lt;/code&gt;. Every time you hit the &lt;code&gt;pod/exec&lt;/code&gt; endpoint, K8s logs the
following event in the audit log:&lt;/p&gt;
&lt;div class="src src-json"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-json" data-lang="json"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;{&lt;span style="color:#f92672"&gt;&amp;#34;kind&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;Event&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;apiVersion&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;audit.k8s.io/v1&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;level&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;Metadata&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;auditID&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;5c19c1d0-00a7-4af5-a236-5345b5963581&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;stage&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;ResponseComplete&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;requestURI&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;/api/v1/namespaces/falco/pods/falco-8mqj7/exec?command=cat\u0026command=%2Fetc%2Ffalco%2Fextra-rules.d%2Ffalco-extra-rules.yaml\u0026container=falco\u0026stderr=true\u0026stdout=true&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;verb&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;create&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;user&amp;#34;&lt;/span&gt;:{&lt;span style="color:#f92672"&gt;&amp;#34;username&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;root&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;uid&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;d82ec74a-75e3-4798-a084-4b766dcea5ef&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;groups&amp;#34;&lt;/span&gt;:[&lt;span style="color:#e6db74"&gt;&amp;#34;cluster-admins&amp;#34;&lt;/span&gt;,&lt;span style="color:#e6db74"&gt;&amp;#34;system:authenticated:oauth&amp;#34;&lt;/span&gt;,&lt;span style="color:#e6db74"&gt;&amp;#34;system:authenticated&amp;#34;&lt;/span&gt;],&lt;span style="color:#f92672"&gt;&amp;#34;extra&amp;#34;&lt;/span&gt;:{&lt;span style="color:#f92672"&gt;&amp;#34;scopes.authorization.openshift.io&amp;#34;&lt;/span&gt;:[&lt;span style="color:#e6db74"&gt;&amp;#34;user:full&amp;#34;&lt;/span&gt;]}},&lt;span style="color:#f92672"&gt;&amp;#34;sourceIPs&amp;#34;&lt;/span&gt;:[&lt;span style="color:#e6db74"&gt;&amp;#34;10.0.32.220&amp;#34;&lt;/span&gt;],&lt;span style="color:#f92672"&gt;&amp;#34;userAgent&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;oc/4.13.0 (linux/amd64) kubernetes/92b1a3d&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;objectRef&amp;#34;&lt;/span&gt;:{&lt;span style="color:#f92672"&gt;&amp;#34;resource&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;pods&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;namespace&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;falco&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;falco-8mqj7&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;apiVersion&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;v1&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;subresource&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;exec&amp;#34;&lt;/span&gt;},&lt;span style="color:#f92672"&gt;&amp;#34;responseStatus&amp;#34;&lt;/span&gt;:{&lt;span style="color:#f92672"&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;:{},&lt;span style="color:#f92672"&gt;&amp;#34;code&amp;#34;&lt;/span&gt;:&lt;span style="color:#ae81ff"&gt;101&lt;/span&gt;},&lt;span style="color:#f92672"&gt;&amp;#34;requestReceivedTimestamp&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;2023-11-13T17:23:16.999602Z&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;stageTimestamp&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;2023-11-13T17:23:17.231121Z&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;annotations&amp;#34;&lt;/span&gt;:{&lt;span style="color:#f92672"&gt;&amp;#34;authorization.k8s.io/decision&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;allow&amp;#34;&lt;/span&gt;,&lt;span style="color:#f92672"&gt;&amp;#34;authorization.k8s.io/reason&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;RBAC: allowed by ClusterRoleBinding \&amp;#34;root-cluster-admin\&amp;#34; of ClusterRole \&amp;#34;cluster-admin\&amp;#34; to User \&amp;#34;root\&amp;#34;&amp;#34;&lt;/span&gt;}}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
As you can hopefully see, the command executed is available in the
&lt;span style="text-decoration: underline;"&gt;requestURI&lt;/span&gt; field.&lt;/p&gt;
&lt;p&gt;
So we enabled the &lt;span style="text-decoration: underline;"&gt;k8saudit&lt;/span&gt; Falco plugin and created an additional rule
for those kind of events.&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falco&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;plugins&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;k8saudit&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;library_path&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;libk8saudit.so&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;init_config&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# maxEventSize: 262144&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# webhookMaxBatchSize: 12582912&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# sslCertificate: /etc/falco/falco.pem&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# open_params: &amp;#34;http://:9765/k8s-audit&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;open_params&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;/host/var/log/kube-apiserver/audit.log&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;json&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;library_path&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;libjson.so&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;init_config&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-4" class="outline-2"&gt;
&lt;h2 id="headline-4"&gt;
Implementing event routing
&lt;/h2&gt;
&lt;div id="outline-text-headline-4" class="outline-text-2"&gt;
&lt;p&gt;
We had an additional requirement to route events based on the following rules:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Events that &lt;strong&gt;do not&lt;/strong&gt; contain sensitive data (like usernames) should go
to a specific Kafka topic&lt;/li&gt;
&lt;li&gt;Events that &lt;strong&gt;do&lt;/strong&gt; contain sensitive data (like usernames) should be
routed to another Kafka topic&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Our first thought was to leverage Falcosidekick&amp;#39;s &lt;a href="https://github.com/falcosecurity/falcosidekick/blob/2.28.0/config_example.yaml#L279"&gt;minimumpriority&lt;/a&gt;
field for routing. Events with sensitive data would get a higher
priority. But the sink with a lower &lt;span style="text-decoration: underline;"&gt;minimumpriority&lt;/span&gt; would get events
with higher priority as well, which means events with sensitive data.&lt;/p&gt;
&lt;p&gt;
Furthermore as far as we know Falco currently only supports one Kafka
configuration (we need two for two topics).&lt;/p&gt;
&lt;p&gt;
At this point in time we are not aware of a possibility to implement
this with Falco or Falcosidekick directly.&lt;/p&gt;
&lt;p&gt;
There are some discussions upstream on implementing such a feature:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/falcosecurity/falcosidekick/issues/161"&gt;https://github.com/falcosecurity/falcosidekick/issues/161&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/falcosecurity/falcosidekick/issues/161#issuecomment-747714289"&gt;https://github.com/falcosecurity/falcosidekick/issues/161#issuecomment-747714289&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/falcosecurity/falcosidekick/issues/224"&gt;https://github.com/falcosecurity/falcosidekick/issues/224&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Our current idea is to use &lt;a href="https://vector.dev/"&gt;Vector&lt;/a&gt; for event routing. We will try to
implement the following pipeline:&lt;/p&gt;
&lt;p&gt;
&lt;img src="https://blog.stderr.at/openshift/images/falco/falco-pipeline.png" alt="/openshift/images/falco/falco-pipeline.png" title="/openshift/images/falco/falco-pipeline.png" /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-5" class="outline-2"&gt;
&lt;h2 id="headline-5"&gt;
Tips and Tricks
&lt;/h2&gt;
&lt;div id="outline-text-headline-5" class="outline-text-2"&gt;
&lt;div id="outline-container-headline-6" class="outline-3"&gt;
&lt;h3 id="headline-6"&gt;
Monitor Redis disk usage
&lt;/h3&gt;
&lt;div id="outline-text-headline-6" class="outline-text-3"&gt;
&lt;p&gt;
One small hint when using &lt;code&gt;falcosidekick-ui&lt;/code&gt; to debug/monitor events. It
happened to us that the Redis volume was full and suddenly we couldn&amp;#39;t
see new events in the UI.&lt;/p&gt;
&lt;p&gt;
We stopped the UI and Redis pods, removed the PVC and just ran our kustomization
again, to recreate the PVC and the pods.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-7" class="outline-3"&gt;
&lt;h3 id="headline-7"&gt;
Monitor &lt;span style="text-decoration: underline;"&gt;falco&lt;/span&gt; pod logs when changing rules
&lt;/h3&gt;
&lt;div id="outline-text-headline-7" class="outline-text-3"&gt;
&lt;p&gt;
It&amp;#39;s always wise to monitor one Falco pod for errors when deploying
new rules, for example at one point we hit the following error:&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;{&amp;#34;hostname&amp;#34;:&amp;#34;falco-2hlkm&amp;#34;,&amp;#34;output&amp;#34;:&amp;#34;Falco internal: hot restart failure: /etc/falco/extra-rules.d/falco-extra-rules.yaml: Invalid\n1 Errors:\nIn rules content: (/etc/falco/extra-rules.d/falco-extra-rules.yaml:0:0)\n rule &amp;#39;Terminal shell in container&amp;#39;: (/etc/falco/extra-rules.d/falco-extra-rules.yaml:25:2)\n condition expression: (\&amp;#34;spawned_process a...\&amp;#34;:26:71)\n------\n...ocess and container and shell_procs and proc.tty != 0 and container_entrypoint\n ^\n------\nLOAD_ERR_VALIDATE (Error validating rule/macro/list/exception objects): Undefined macro &amp;#39;container_entrypoint&amp;#39; used in filter.\n&amp;#34;,&amp;#34;output_fields&amp;#34;:{},&amp;#34;priority&amp;#34;:&amp;#34;Critical&amp;#34;,&amp;#34;rule&amp;#34;:&amp;#34;Falco internal: hot restart failure&amp;#34;,&amp;#34;source&amp;#34;:&amp;#34;internal&amp;#34;,&amp;#34;time&amp;#34;:&amp;#34;2023-11-13T11:47:14.639547735Z&amp;#34;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Falco is quite resilient when it comes to errors in rules files and
provides useful hints on what might be wrong:&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Undefined macro &amp;#39;container_entrypoint&amp;#39; used in filter&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
So we just added the missing macro and all was swell again.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</description></item><item><title>Setting up Falco on OpenShift 4.12</title><link>https://blog.stderr.at/openshift-platform/security/runtime-security/2023-10-23-openshift-falco/</link><pubDate>Mon, 23 Oct 2023 00:00:00 +0000</pubDate><guid>https://blog.stderr.at/openshift-platform/security/runtime-security/2023-10-23-openshift-falco/</guid><description>&lt;p&gt;
&lt;a href="https://falco.org/"&gt;Falco&lt;/a&gt; is a security tool to monitor kernel events like system calls to
provide real-time alerts. In this post I&amp;#39;ll document the steps taken
to get Open Source &lt;a href="https://falco.org/"&gt;Falco&lt;/a&gt; running on an OpenShift 4.12 cluster.&lt;/p&gt;
&lt;p&gt;
&lt;a href="https://blog.stderr.at/openshift/2023-10-23-openshift-falco/#headline-4"&gt;UPDATE&lt;/a&gt;: Use the &lt;code&gt;falco-driver-loader-legacy&lt;/code&gt; image for OpenShift 4.12 deployments.&lt;/p&gt;
&lt;div id="outline-container-headline-1" class="outline-2"&gt;
&lt;h2 id="headline-1"&gt;
First Try
&lt;/h2&gt;
&lt;div id="outline-text-headline-1" class="outline-text-2"&gt;
&lt;p&gt;
We will use the &lt;a href="https://falcosecurity.github.io/charts"&gt;Falco Helm chart&lt;/a&gt; version 3.8.0 for our first try of setting up Falco on our OpenShift cluster.&lt;/p&gt;
&lt;p&gt;
This is our values file:&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;driver:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; kind: ebpf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; json_output: true
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; json_include_output_property: true
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log_syslog: false
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log_level: info
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falcosidekick:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; enabled: true
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; webui:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; enabled: true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
We would like to use the eBPF driver to monitor kernel events, enable
falco sidekick, which is used to route events and the falco sidekick
UI for easier testing.&lt;/p&gt;
&lt;p&gt;
Because of reasons we leverage kustomize to render the helm chart. The
final kustomize config is &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/tree/main/components/apps/falco/base"&gt;here&lt;/a&gt; (after fixing all problems mentioned
below).&lt;/p&gt;
&lt;p&gt;
So after deploying the chart via ArgoCD (another story), we have the following pods:&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get pods -n falco
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY STATUS RESTARTS AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-4cc8j 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;95s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m31s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-bx87j 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;75s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m29s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-ds9w6 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;99s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m30s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick-ui-redis-0 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 4m28s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-gxznz 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;14s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m30s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-vtnk5 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;98s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m29s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-wbn2k 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;80s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 4m29s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
hm, not so good. Seems like some &lt;code&gt;initContainers&lt;/code&gt; are failing.&lt;/p&gt;
&lt;p&gt;
Let&amp;#39;s check the &lt;code&gt;falco-driver-loader&lt;/code&gt; initContainer:&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Setting up /usr/src links from host
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt;: falco version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;0.36.1, driver version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;6.0.1+driver, arch&lt;span style="color:#f92672"&gt;=&lt;/span&gt;x86_64, kernel release&lt;span style="color:#f92672"&gt;=&lt;/span&gt;4.18.0-372.73.1.el8_6.x86_64, kernel version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader with: driver&lt;span style="color:#f92672"&gt;=&lt;/span&gt;bpf, compile&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes, download&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Mounting debugfs
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mount: /sys/kernel/debug: permission denied.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dmesg&lt;span style="color:#f92672"&gt;(&lt;/span&gt;1&lt;span style="color:#f92672"&gt;)&lt;/span&gt; may have more information after failed mount system call.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Filename &lt;span style="color:#e6db74"&gt;&amp;#39;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&amp;#39;&lt;/span&gt; is composed of:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - driver name: falco
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - target identifier: rhcos
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel release: 4.18.0-372.73.1.el8_6.x86_64
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel version: &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to download a prebuilt eBPF probe from https://download.falco.org/driver/6.0.1%2Bdriver/x86_64/falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl: &lt;span style="color:#f92672"&gt;(&lt;/span&gt;22&lt;span style="color:#f92672"&gt;)&lt;/span&gt; The requested URL returned error: &lt;span style="color:#ae81ff"&gt;404&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Unable to find a prebuilt falco eBPF probe
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to compile the eBPF probe &lt;span style="color:#f92672"&gt;(&lt;/span&gt;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;expr: syntax error: unexpected argument &lt;span style="color:#e6db74"&gt;&amp;#39;1&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make&lt;span style="color:#f92672"&gt;[&lt;/span&gt;1&lt;span style="color:#f92672"&gt;]&lt;/span&gt;: *** /lib/modules/4.18.0-372.73.1.el8_6.x86_64/build: No such file or directory. Stop.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make: *** &lt;span style="color:#f92672"&gt;[&lt;/span&gt;Makefile:38: all&lt;span style="color:#f92672"&gt;]&lt;/span&gt; Error &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mv: cannot stat &lt;span style="color:#e6db74"&gt;&amp;#39;/usr/src/falco-6.0.1+driver/bpf/probe.o&amp;#39;&lt;/span&gt;: No such file or directory
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Unable to load the falco eBPF probe&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Seems to be an issue with a missing directory &lt;span style="text-decoration: underline;"&gt;/lib/modules/4.18.0-372.73.1.el8_6.x86_64/build&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;
And we told the helm chart to enable &lt;code&gt;falco-sidekick&lt;/code&gt; and
&lt;code&gt;falco-sidekick-ui&lt;/code&gt;, but where are they?&lt;/p&gt;
&lt;p&gt;
Let&amp;#39;s check the events with &lt;code&gt;oc get events&lt;/code&gt; as well, and what do we see?&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;8s Warning FailedCreate replicaset/falco-falcosidekick-7cfbbbf89f Error creating: pods &lt;span style="color:#e6db74"&gt;&amp;#34;falco-falcosidekick-7cfbbbf89f-&amp;#34;&lt;/span&gt; is forbidden: unable to validate against any security context constraint: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;provider &lt;span style="color:#e6db74"&gt;&amp;#34;anyuid&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider restricted-v2: .spec.securityContext.fsGroup: Invalid value: &lt;span style="color:#f92672"&gt;[]&lt;/span&gt;int64&lt;span style="color:#f92672"&gt;{&lt;/span&gt;1234&lt;span style="color:#f92672"&gt;}&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;1234&lt;/span&gt; is not an allowed group, provider restricted-v2: .containers&lt;span style="color:#f92672"&gt;[&lt;/span&gt;0&lt;span style="color:#f92672"&gt;]&lt;/span&gt;.runAsUser: Invalid value: 1234: must be in the ranges: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1000730000, 1000739999&lt;span style="color:#f92672"&gt;]&lt;/span&gt;, provider &lt;span style="color:#e6db74"&gt;&amp;#34;restricted&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;nonroot-v2&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;nonroot&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostmount-anyuid&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;machine-api-termination-handler&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostnetwork-v2&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostnetwork&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostaccess&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;falco&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;node-exporter&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;privileged&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount&lt;span style="color:#f92672"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;6s Warning FailedCreate replicaset/falco-falcosidekick-ui-76885bd484 Error creating: pods &lt;span style="color:#e6db74"&gt;&amp;#34;falco-falcosidekick-ui-76885bd484-&amp;#34;&lt;/span&gt; is forbidden: unable to validate against any security context constraint: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;provider &lt;span style="color:#e6db74"&gt;&amp;#34;anyuid&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider restricted-v2: .spec.securityContext.fsGroup: Invalid value: &lt;span style="color:#f92672"&gt;[]&lt;/span&gt;int64&lt;span style="color:#f92672"&gt;{&lt;/span&gt;1234&lt;span style="color:#f92672"&gt;}&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;1234&lt;/span&gt; is not an allowed group, provider restricted-v2: .containers&lt;span style="color:#f92672"&gt;[&lt;/span&gt;0&lt;span style="color:#f92672"&gt;]&lt;/span&gt;.runAsUser: Invalid value: 1234: must be in the ranges: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1000730000, 1000739999&lt;span style="color:#f92672"&gt;]&lt;/span&gt;, provider &lt;span style="color:#e6db74"&gt;&amp;#34;restricted&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;nonroot-v2&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;nonroot&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostmount-anyuid&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;machine-api-termination-handler&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostnetwork-v2&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostnetwork&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;hostaccess&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;falco&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;node-exporter&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount, provider &lt;span style="color:#e6db74"&gt;&amp;#34;privileged&amp;#34;&lt;/span&gt;: Forbidden: not usable by user or serviceaccount&lt;span style="color:#f92672"&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Looks like a problem with OpenShifts Security Context constraints (SCC&amp;#39;s).&lt;/p&gt;
&lt;div id="outline-container-headline-2" class="outline-3"&gt;
&lt;h3 id="headline-2"&gt;
Summary of problems
&lt;/h3&gt;
&lt;div id="outline-text-headline-2" class="outline-text-3"&gt;
&lt;ul&gt;
&lt;li&gt;The falco &lt;code&gt;DaemonSet&lt;/code&gt; fails to start pods because there is an issue with a missing directory&lt;/li&gt;
&lt;li&gt;Falco Sidekick and Falco Sidekick UI fails to start because of
Security Context Constraint (SCC) issues&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-3" class="outline-2"&gt;
&lt;h2 id="headline-3"&gt;
Fixing the Falco daemonset
&lt;/h2&gt;
&lt;div id="outline-text-headline-3" class="outline-text-2"&gt;
&lt;p&gt;
Falco tries to download a pre-compiled eBPF probe, fails and then
tries to compile that probe for our host OS kernel. This fails with the message:&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make&lt;span style="color:#f92672"&gt;[&lt;/span&gt;1&lt;span style="color:#f92672"&gt;]&lt;/span&gt;: *** /lib/modules/4.18.0-372.73.1.el8_6.x86_64/build: No such file or directory. Stop.&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
As far as we know there are no kernel sources installed on RHCOS nodes
in OpenShift. After a little bit of searching the interweb we found
the following issue comment on Github:&lt;/p&gt;
&lt;p&gt;
&lt;a href="https://github.com/falcosecurity/falco/issues/1505#issuecomment-754745960"&gt;OpenShift under vsphere: Download failed, consider compiling your own falco module and loading it or getting in touch with the Falco community&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;
So we need to enable the &lt;code&gt;kernel-devel&lt;/code&gt; extension, the official docs are
&lt;a href="https://docs.openshift.com/container-platform/4.12/post_installation_configuration/machine-configuration-tasks.html#rhcos-add-extensions_post-install-machine-configuration-tasks"&gt;here&lt;/a&gt;. It does not mention &lt;code&gt;kernel-devel&lt;/code&gt;, but there&amp;#39;s a &lt;a href="https://access.redhat.com/solutions/6972423"&gt;knowledge base
article&lt;/a&gt; mentioning &lt;code&gt;kernel-devel&lt;/code&gt;, so let&amp;#39;s give it a try.&lt;/p&gt;
&lt;p&gt;
We deploy two &lt;code&gt;MachineConfigs&lt;/code&gt;, one for &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/blob/main/components/apps/falco/base/worker-machineconfig.yaml"&gt;worker&lt;/a&gt; and one for &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/blob/main/components/apps/falco/base/master-machineconfig.yaml"&gt;master&lt;/a&gt; nodes
to rollout the extension, the worker configuration looks like this:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;apiVersion&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;machineconfiguration.openshift.io/v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;kind&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;MachineConfig&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;metadata&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;labels&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;machineconfiguration.openshift.io/role&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;worker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;99&lt;/span&gt;-&lt;span style="color:#ae81ff"&gt;worker-kernel-devel-extensions&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;spec&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;extensions&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;kernel-devel&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
See also our Kustomize configuration &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/blob/main/components/apps/falco/base/kustomization.yaml"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;
As soon as we apply our &lt;code&gt;MachineConfigs&lt;/code&gt;, OpenShift starts the rollout via MaschineConfigPool&amp;#39;s:&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get mcp
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME CONFIG UPDATED UPDATING DEGRADED MACHINECOUNT READYMACHINECOUNT UPDATEDMACHINECOUNT DEGRADEDMACHINECOUNT AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;master rendered-master-ce464ff45cc049fce3e8a63e36a4ee9e False True False 3 0 0 0 13d
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;worker rendered-worker-a0f8f0d915ef01ba4a1ab3047b6c863d False True False 3 0 0 0 13d&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
When the rollout is done, let&amp;#39;s restart all Falco &lt;code&gt;DaemonSet&lt;/code&gt; pods:&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc delete pods -l app.kubernetes.io/name&lt;span style="color:#f92672"&gt;=&lt;/span&gt;falco&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
And check the status:&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get pods
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY STATUS RESTARTS AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-5wfnk 0/2 Init:Error &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;3s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 7s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-66fxw 0/2 Init:0/2 &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;2s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 6s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-6fbc7 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;2s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 8s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-8h8n4 0/2 Init:0/2 &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;2s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 6s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick-ui-redis-0 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 18m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-nhld2 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;2s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 6s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-xqv4b 0/2 Init:CrashLoopBackOff &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;3s ago&lt;span style="color:#f92672"&gt;)&lt;/span&gt; 8s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
still, the &lt;code&gt;initContainers&lt;/code&gt; fail. Lets check the log again&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc logs -c falco-driver-loader falco-5wfnk
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Setting up /usr/src links from host
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt;: falco version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;0.36.1, driver version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;6.0.1+driver, arch&lt;span style="color:#f92672"&gt;=&lt;/span&gt;x86_64, kernel release&lt;span style="color:#f92672"&gt;=&lt;/span&gt;4.18.0-372.73.1.el8_6.x86_64, kernel version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader with: driver&lt;span style="color:#f92672"&gt;=&lt;/span&gt;bpf, compile&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes, download&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Mounting debugfs
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mount: /sys/kernel/debug: permission denied.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dmesg&lt;span style="color:#f92672"&gt;(&lt;/span&gt;1&lt;span style="color:#f92672"&gt;)&lt;/span&gt; may have more information after failed mount system call.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Filename &lt;span style="color:#e6db74"&gt;&amp;#39;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&amp;#39;&lt;/span&gt; is composed of:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - driver name: falco
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - target identifier: rhcos
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel release: 4.18.0-372.73.1.el8_6.x86_64
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel version: &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to download a prebuilt eBPF probe from https://download.falco.org/driver/6.0.1%2Bdriver/x86_64/falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl: &lt;span style="color:#f92672"&gt;(&lt;/span&gt;22&lt;span style="color:#f92672"&gt;)&lt;/span&gt; The requested URL returned error: &lt;span style="color:#ae81ff"&gt;404&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Unable to find a prebuilt falco eBPF probe
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to compile the eBPF probe &lt;span style="color:#f92672"&gt;(&lt;/span&gt;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Makefile:1005: *** &lt;span style="color:#e6db74"&gt;&amp;#34;Cannot generate ORC metadata for CONFIG_UNWINDER_ORC=y, please install libelf-dev, libelf-devel or elfutils-libelf-devel&amp;#34;&lt;/span&gt;. Stop.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make: *** &lt;span style="color:#f92672"&gt;[&lt;/span&gt;Makefile:38: all&lt;span style="color:#f92672"&gt;]&lt;/span&gt; Error &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mv: cannot stat &lt;span style="color:#e6db74"&gt;&amp;#39;/usr/src/falco-6.0.1+driver/bpf/probe.o&amp;#39;&lt;/span&gt;: No such file or directory
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Unable to load the falco eBPF probe&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
So this time we get another error, the culprit is the following line&lt;/p&gt;
&lt;div class="src src-bash"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Makefile:1005: *** &lt;span style="color:#e6db74"&gt;&amp;#34;Cannot generate ORC metadata for CONFIG_UNWINDER_ORC=y, please install libelf-dev, libelf-devel or elfutils-libelf-devel&amp;#34;&lt;/span&gt;. Stop.&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Back to searching the interweb only reveals an old &lt;a href="https://github.com/falcosecurity/falco/issues/376"&gt;issue&lt;/a&gt;, that should
be fixed already.&lt;/p&gt;
&lt;p&gt;
So as a quick hack we &lt;a href="https://github.com/tosmi/playground/blob/master/openshift/falco/custom-falco-driver-loader/Dockerfile"&gt;modified&lt;/a&gt; the &lt;code&gt;falco-driver-loader&lt;/code&gt; image to
contain &lt;code&gt;libelf-dev&lt;/code&gt; and pushed to image to &lt;a href="https://quay.io/repository/tosmi/falco-driver-loader?tab=tags"&gt;quay&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;
We then modified our falco helm configuration to use the updated image:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;driver&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;kind&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;ebpf&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;loader&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;initContainer&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;image&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;registry&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;quay.io&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;repository&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;tosmi/falco-driver-loader&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;tag&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;0.36.1&lt;/span&gt;-&lt;span style="color:#ae81ff"&gt;libelf-dev&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falco&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;json_output&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;json_include_output_property&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;log_syslog&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;log_level&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;info&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falcosidekick&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;webui&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Note the updated &lt;code&gt;diver.loader.initContainer&lt;/code&gt; section.&lt;/p&gt;
&lt;p&gt;
Let&amp;#39;s check the our pods again:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get pods
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY STATUS RESTARTS AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-2ssgx 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 66s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-5hqgg 1/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 66s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-82kq9 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 65s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-99zxw 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 65s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick-test-connection 0/1 Error &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 67s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick-ui-redis-0 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 31m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-slx5k 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 65s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-tzm8d 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 65s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Success! This time the &lt;code&gt;DaemonSet&lt;/code&gt; pods started successfully. Just note
that you have to be patient. The first start took about 1-2 minutes to
complete.&lt;/p&gt;
&lt;p&gt;
Let&amp;#39;s check the logs of one &lt;code&gt;DaemonSet&lt;/code&gt; pod just to sure:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;oc logs -c falco-driver-loader falco-2ssgx
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Setting up /usr/src links from host
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt;: falco version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;0.36.1, driver version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;6.0.1+driver, arch&lt;span style="color:#f92672"&gt;=&lt;/span&gt;x86_64, kernel release&lt;span style="color:#f92672"&gt;=&lt;/span&gt;4.18.0-372.73.1.el8_6.x86_64, kernel version&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Running falco-driver-loader with: driver&lt;span style="color:#f92672"&gt;=&lt;/span&gt;bpf, compile&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes, download&lt;span style="color:#f92672"&gt;=&lt;/span&gt;yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Mounting debugfs
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mount: /sys/kernel/debug: permission denied.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dmesg&lt;span style="color:#f92672"&gt;(&lt;/span&gt;1&lt;span style="color:#f92672"&gt;)&lt;/span&gt; may have more information after failed mount system call.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Filename &lt;span style="color:#e6db74"&gt;&amp;#39;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&amp;#39;&lt;/span&gt; is composed of:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - driver name: falco
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - target identifier: rhcos
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel release: 4.18.0-372.73.1.el8_6.x86_64
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - kernel version: &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to download a prebuilt eBPF probe from https://download.falco.org/driver/6.0.1%2Bdriver/x86_64/falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl: &lt;span style="color:#f92672"&gt;(&lt;/span&gt;22&lt;span style="color:#f92672"&gt;)&lt;/span&gt; The requested URL returned error: &lt;span style="color:#ae81ff"&gt;404&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Unable to find a prebuilt falco eBPF probe
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Trying to compile the eBPF probe &lt;span style="color:#f92672"&gt;(&lt;/span&gt;falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* eBPF probe located in /root/.falco/6.0.1+driver/x86_64/falco_rhcos_4.18.0-372.73.1.el8_6.x86_64_1.o
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Success: eBPF probe symlinked to /root/.falco/falco-bpf.o&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Especially the line&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;* Success: eBPF probe symlinked to /root/.falco/falco-bpf.o&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
looks promising. So up to the next problem, getting falco-sidekick and falco-sidekick-ui running.&lt;/p&gt;
&lt;p&gt;
We also &lt;a href="https://github.com/falcosecurity/falco/issues/2884"&gt;opened a bug&lt;/a&gt; report upstream to get feedback from the
developers on this issue.&lt;/p&gt;
&lt;div id="outline-container-headline-4" class="outline-3"&gt;
&lt;h3 id="headline-4"&gt;
UPDATE
&lt;/h3&gt;
&lt;div id="outline-text-headline-4" class="outline-text-3"&gt;
&lt;p&gt;
&lt;a href="https://github.com/Andreagit97"&gt;Andreagit97&lt;/a&gt; was so nice mentioning in the issue above that
actually there is an image with libelf-dev available,
&lt;a href="https://hub.docker.com/r/falcosecurity/falco-driver-loader-legacy"&gt;falco-driver-loader-legacy&lt;/a&gt;. We can confirm that this image fixes the
problem mentioned above.&lt;/p&gt;
&lt;p&gt;
So this is our final falco helm chart values.yaml:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;driver&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;kind&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;ebpf&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;loader&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;initContainer&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;image&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;repository&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falcosecurity/falco-driver-loader-legacy&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falco&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;json_output&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;json_include_output_property&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;log_syslog&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;log_level&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;info&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;falcosidekick&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;webui&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;enabled&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-5" class="outline-2"&gt;
&lt;h2 id="headline-5"&gt;
Fixing falco-sidekick and falco-sidekick-ui
&lt;/h2&gt;
&lt;div id="outline-text-headline-5" class="outline-text-2"&gt;
&lt;p&gt;
Remember pod startup actually failed because of the following event (check with &lt;code&gt;oc get events&lt;/code&gt;):&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;.spec.securityContext.fsGroup: Invalid value: []int64{1234}: 1234 is not an allowed group&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
It seems the sidekick pods want to run with a specific UID. The
default OpenShift Security Context Constraint (SCC) &lt;code&gt;restricted&lt;/code&gt;
prohibits this.&lt;/p&gt;
&lt;p&gt;
Lets confirm our suspicion:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get deploy -o jsonpath&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;{.spec.template.spec.securityContext}{&amp;#34;\n&amp;#34;}&amp;#39;&lt;/span&gt; falco-falcosidekick
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;fsGroup&amp;#34;&lt;/span&gt;:1234,&lt;span style="color:#e6db74"&gt;&amp;#34;runAsUser&amp;#34;&lt;/span&gt;:1234&lt;span style="color:#f92672"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get deploy -o jsonpath&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;{.spec.template.spec.securityContext}{&amp;#34;\n&amp;#34;}&amp;#39;&lt;/span&gt; falco-falcosidekick-ui
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;fsGroup&amp;#34;&lt;/span&gt;:1234,&lt;span style="color:#e6db74"&gt;&amp;#34;runAsUser&amp;#34;&lt;/span&gt;:1234&lt;span style="color:#f92672"&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Bingo! &lt;code&gt;securityContext&lt;/code&gt; is set to 1234 for both deployments. There is
another SCC that we could leverage, &lt;code&gt;nonroot&lt;/code&gt;, which basically allows any
UID expect 0. We just need to get the &lt;code&gt;ServiceAccount&lt;/code&gt; that
falco-sidekick and falco-sidekick-ui are actually using:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get deploy -o jsonpath&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;{.spec.template.spec.serviceAccount}{&amp;#34;\n&amp;#34;}&amp;#39;&lt;/span&gt; falco-falcosidekick
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get deploy -o jsonpath&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;{.spec.template.spec.serviceAccount}{&amp;#34;\n&amp;#34;}&amp;#39;&lt;/span&gt; falco-falcosidekick-ui
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;falco-falcosidekick-ui&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
So falco-sidekick uses &lt;code&gt;falco-sidekick&lt;/code&gt; as &lt;code&gt;ServiceAccount&lt;/code&gt; and falco-sidekick-ui &lt;code&gt;falco-sidekick-ui&lt;/code&gt;. Lets
grant both &lt;code&gt;ServiceAccounts&lt;/code&gt; access to the &lt;code&gt;nonroot&lt;/code&gt; SCC.&lt;/p&gt;
&lt;div class="src src-text"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kind: ClusterRoleBinding
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; name: falco-falcosidekick-scc:nonroot
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;roleRef:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; apiGroup: rbac.authorization.k8s.io
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; kind: ClusterRole
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; name: system:openshift:scc:nonroot
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;subjects:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;- kind: ServiceAccount
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; name: falco-falcosidekick
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; namespace: falco
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;- kind: ServiceAccount
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; name: falco-falcosidekick-ui
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; namespace: falco&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
We&amp;#39;ve already added this &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/blob/main/components/apps/falco/base/falcosidekick-any-uid-scc.yaml"&gt;file&lt;/a&gt; to our &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/blob/main/components/apps/falco/base/falcosidekick-any-uid-scc.yaml#L19"&gt;Kustomize&lt;/a&gt; configuration.&lt;/p&gt;
&lt;p&gt;
Let&amp;#39;s trigger a redeployment by deleting the &lt;code&gt;ReplicaSets&lt;/code&gt; of both deployments, they will be re-created automatically:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc delete rs -l app.kubernetes.io/name&lt;span style="color:#f92672"&gt;=&lt;/span&gt;falcosidekick
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc delete rs -l app.kubernetes.io/name&lt;span style="color:#f92672"&gt;=&lt;/span&gt;falcosidekick-ui&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
Finally let&amp;#39;s confirm everything is up and running:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc get deploy,ds,pods
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/falco-falcosidekick 2/2 &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; 5d
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/falco-falcosidekick-ui 2/2 &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; 5d
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;daemonset.apps/falco &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt; &amp;lt;none&amp;gt; 6d2h
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY STATUS RESTARTS AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-2ssgx 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-5hqgg 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-82kq9 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-99zxw 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-falcosidekick-7cfbbbf89f-qxwxs 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 118s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-falcosidekick-7cfbbbf89f-rz5lj 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 118s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-falcosidekick-ui-76885bd484-p7lqm 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 2m18s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-falcosidekick-ui-76885bd484-sfgh4 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 2m18s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-falcosidekick-ui-redis-0 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 51m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-slx5k 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/falco-tzm8d 2/2 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 21m&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id="outline-container-headline-6" class="outline-2"&gt;
&lt;h2 id="headline-6"&gt;
Testing Falco
&lt;/h2&gt;
&lt;div id="outline-text-headline-6" class="outline-text-2"&gt;
&lt;p&gt;
Now that everything seems to be running, lets do a quick test. First
we will try to access the Falco Sidekick user interface.&lt;/p&gt;
&lt;p&gt;
Falco will not deploy a route for the UI automatically, instead we&amp;#39;ve
created a &lt;a href="https://github.com/tosmi-gitops/openshift-gitops/tree/main/components/apps/falco/overlays/sidekick-ui-route"&gt;Kustomize overlay&lt;/a&gt; with a custom route:&lt;/p&gt;
&lt;div class="src src-yaml"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;apiVersion&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;route.openshift.io/v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;kind&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;Route&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;metadata&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-falcosidekick-ui&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;namespace&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;spec&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;host&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falcosidekick-ui.apps.hub.aws.tntinfra.net&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;port&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;targetPort&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;http&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;tls&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;termination&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;edge&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;to&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;kind&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;Service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;name&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;falco-falcosidekick-ui&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;wildcardPolicy&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;None&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
After deploying the &lt;code&gt;Route&lt;/code&gt; we can access the Falco UI with the hostname
specified in the route object. The default username seems to be
&lt;span style="text-decoration: underline;"&gt;admin/admin&lt;/span&gt; which is kind of strange for a security tool, maybe that&amp;#39;s
the reason Falco does not expose the UI per default.&lt;/p&gt;
&lt;p&gt;
&lt;img src="https://blog.stderr.at/openshift/images/falco/falco-ui.png" alt="/openshift/images/falco/falco-ui.png" title="/openshift/images/falco/falco-ui.png" /&gt;&lt;/p&gt;
&lt;div id="outline-container-headline-7" class="outline-3"&gt;
&lt;h3 id="headline-7"&gt;
Creating an event
&lt;/h3&gt;
&lt;div id="outline-text-headline-7" class="outline-text-3"&gt;
&lt;p&gt;
As a last test let&amp;#39;s try to trigger an event. We open a shell to one
of the falco &lt;code&gt;DaemonSet&lt;/code&gt; pods and execute a suspicious command:&lt;/p&gt;
&lt;div class="src src-shell"&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ oc rsh falco-2ssgx
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Defaulted container &lt;span style="color:#e6db74"&gt;&amp;#34;falco&amp;#34;&lt;/span&gt; out of: falco, falcoctl-artifact-follow, falco-driver-loader &lt;span style="color:#f92672"&gt;(&lt;/span&gt;init&lt;span style="color:#f92672"&gt;)&lt;/span&gt;, falcoctl-artif# cat /etc/shadow
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;root:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;daemon:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sys:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sync:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;games:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;man:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;lp:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mail:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;news:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;uucp:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;proxy:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;www-data:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;backup:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;list:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;irc:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;_apt:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;nobody:*:19639:0:99999:7:::
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;#&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
and we can see an event with priority &lt;strong&gt;Warning&lt;/strong&gt; in the Falco ui.&lt;/p&gt;
&lt;p&gt;
&lt;img src="https://blog.stderr.at/openshift/images/falco/falco-cat-etc-shadow.png" alt="/openshift/images/falco/falco-cat-etc-shadow.png" title="/openshift/images/falco/falco-cat-etc-shadow.png" /&gt;&lt;/p&gt;
&lt;p&gt;
That&amp;#39;s it, seems like Falco is successfully running on OpenShift 4.12.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</description></item></channel></rss>