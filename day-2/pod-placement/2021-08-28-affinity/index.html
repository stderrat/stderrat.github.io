<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI">
<meta charset=utf-8>
<meta name=color-scheme content="dark light">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.87.0">
<meta name=description content="Placeing Pods Using the Affinity rules">
<meta name=author content="Toni Schmidbauer & Thomas Jungbauer">
<link rel=icon href=/images/favicon.ico type=image/png>
<link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png>
<link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png>
<link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png>
<link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png>
<link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png>
<link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png>
<link rel="shortcut icon" href=/images/favicon.ico>
<link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png>
<link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<title>Pod Affinity/Anti-Affinity :: TechBlog about OpenShift/Ansible/Satellite and much more</title>
<link rel=manifest href=/manifest.json>
<meta name=theme-color content="#317EFB">
<link href=/css/nucleus.min.css?1638261404 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1638261404 rel=stylesheet>
<link href=/css/font-awesome-animation.min.css?1638261404 rel=stylesheet>
<link href=/css/hybrid.css?1638261404 rel=stylesheet>
<link href=/css/featherlight.min.css?1638261404 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1638261404 rel=stylesheet>
<link href=/css/auto-complete.css?1638261404 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1638261404 rel=stylesheet>
<link href=/css/theme.min.css?1638261404 rel=stylesheet>
<link href=/css/hugo-theme.css?1638261404 rel=stylesheet>
<link href=/css/theme-yaub.css?1638261404 rel=stylesheet>
<script src=/js/jquery-3.6.0.min.js?1638261404></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
</head>
<body data-url=/day-2/pod-placement/2021-08-28-affinity/>
<button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/>
<p class="fa fa-cloud-upload-alt faa-float animated"></p>
<span class=text>YAUB</span>
<p class=logoarea><span class="text small">Yet another Useless Blog</span></p>
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1638261404></script>
<script type=text/javascript src=/js/auto-complete.js?1638261404></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script>
<script type=text/javascript src=/js/search.js?1638261405></script>
</div>
<div class=togglemode>
<button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button>
</div>
<section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Home</a>
</li>
</ul>
</section>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/openshift/ title=OpenShift class=dd-item>
<a href=/openshift/>
OpenShift
</a>
<ul>
<li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item>
<a href=/openshift/2021-09-25-sealed_secrets/>
Secure your secrets with Sealed Secrets
</a>
</li>
<li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item>
<a href=/openshift/2021-02-27-understanding-block-devices/>
Understanding RWO block device handling in OpenShift
</a>
</li>
<li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item>
<a href=/openshift/2021-01-27-writingoperatoransible/>
Writing Operator using Ansible
</a>
</li>
<li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item>
<a href=/openshift/2020-12-10-thanos-vs-thanos/>
Thanos Querier vs Thanos Querier
</a>
</li>
<li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item>
<a href=/openshift/2020-08-06-argocd/>
GitOps - Argo CD
</a>
</li>
<li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item>
<a href=/openshift/2020-04-16-tekton/>
OpenShift Pipelines - Tekton Introduction
</a>
</li>
<li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item>
<a href=/openshift/2020-04-01-oc-commands/>
Helpful oc / kubectl commands
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/ title="OpenShift Day-2" class="dd-item
parent">
<a href=/day-2/>
OpenShift Day-2
</a>
<ul>
<li data-nav-id=/day-2/etcd/ title=etcd class=dd-item>
<a href=/day-2/etcd/>
etcd
</a>
<ul>
<li data-nav-id=/day-2/etcd/2021-11-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item>
<a href=/day-2/etcd/2021-11-29-automatedetcdbackup/>
Automated ETCD Backup
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item>
<a href=/day-2/labels_environmets/>
Labels & Environments
</a>
<ul>
<li data-nav-id=/day-2/labels_environmets/2021-11-12-creatingenvironment/ title="Working with Environments" class=dd-item>
<a href=/day-2/labels_environmets/2021-11-12-creatingenvironment/>
Working with Environments
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class="dd-item
parent">
<a href=/day-2/pod-placement/>
Pod Placement
</a>
<ul>
<li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item>
<a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>
Introduction
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-29-node-affinity/>
Node Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item>
<a href=/day-2/pod-placement/2021-08-27-podplacement/>
NodeSelector
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class="dd-item active">
<a href=/day-2/pod-placement/2021-08-28-affinity/>
Pod Affinity/Anti-Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item>
<a href=/day-2/pod-placement/2021-08-30-taints/>
Taints and Tolerations
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item>
<a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>
Topology Spread Constraints
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item>
<a href=/day-2/pod-placement/2021-09-01-descheduler/>
Using Descheduler
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/compliance/ title=Compliance class=dd-item>
<a href=/compliance/>
Compliance
</a>
<ul>
<li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item>
<a href=/compliance/2021/07/oc-compliance-command-line-plugin/>
oc compliance command line plugin
</a>
</li>
<li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item>
<a href=/compliance/2021/07/compliance-operator/>
Compliance Operator
</a>
</li>
</ul>
</li>
<li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item>
<a href=/service-mesh/>
Service Mesh
</a>
<ul>
<li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item>
<a href=/service-mesh/2020/05/enable-automatic-route-creation/>
Enable Automatic Route Creation
</a>
</li>
<li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item>
<a href=/service-mesh/2020/05/authorization-rbac/>
Authorization (RBAC)
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item>
<a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>
Deploy Example Bookinfo Application
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item>
<a href=/service-mesh/2020/04/service-mesh-1.1-released/>
Service Mesh 1.1 released
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item>
<a href=/service-mesh/2020/04/authentication-jwt/>
Authentication JWT
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item>
<a href=/service-mesh/2020/04/mutual-tls-authentication/>
Mutual TLS Authentication
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item>
<a href=/service-mesh/2020/04/fault-injection/>
Fault Injection
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item>
<a href=/service-mesh/2020/04/limit-egress/external-traffic/>
Limit Egress/External Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/advanced-routing-example/>
Advanced Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/routing-example/>
Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item>
<a href=/service-mesh/2020/03/ingress-with-custom-domain/>
Ingress with custom domain
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item>
<a href=/service-mesh/2020/03/ingress-traffic/>
Ingress Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item>
<a href=/service-mesh/2020/03/deploy-microservices/>
Deploy Microservices
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item>
<a href=/service-mesh/2020/03/installation/>
Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/general/ title=General class=dd-item>
<a href=/general/>
General
</a>
<ul>
<li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item>
<a href=/general/2020/05/basic-usage-of-git/>
Basic usage of git
</a>
</li>
<li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item>
<a href=/general/2020/04/red-hat-satellite-cheat-sheet/>
Red Hat Satellite Cheat Sheet
</a>
</li>
</ul>
</li>
<li data-nav-id=/ansible/ title=Ansible class=dd-item>
<a href=/ansible/>
Ansible
</a>
<ul>
<li data-nav-id=/ansible/2021/10/automation-controller-ad-ldap-authentication/ title="Automation Controller ad LDAP Authentication" class=dd-item>
<a href=/ansible/2021/10/automation-controller-ad-ldap-authentication/>
Automation Controller ad LDAP Authentication
</a>
</li>
<li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item>
<a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>
Ansible Tower and downloading collections
</a>
</li>
<li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item>
<a href=/ansible/2020/04/ansible-azure-resource-manager-example/>
Ansible - Azure Resource Manager Example
</a>
</li>
<li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item>
<a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>
DO410 Ansible and Ansible Tower training notes
</a>
</li>
</ul>
</li>
<li data-nav-id=/azure/ title=Azure class=dd-item>
<a href=/azure/>
Azure
</a>
<ul>
<li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item>
<a href=/azure/2021-10-29-private-aro/>
Stumbling into Azure Part II: Setting up a private ARO cluster
</a>
</li>
<li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item>
<a href=/azure/2021-10-17-s2s-vpn/>
Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing
</a>
</li>
</ul>
</li>
<li data-nav-id=/quay/ title=Quay class=dd-item>
<a href=/quay/>
Quay
</a>
<ul>
<li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item>
<a href=/quay/2021-09-07-quay-upgrade-3.4/>
Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator
</a>
</li>
<li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item>
<a href=/quay/2020-05-13-quay-tutorial1/>
Red Hat Quay Registry - Overview and Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/archive/ title=Archive class=dd-item>
<a href=/archive/>
Archive
</a>
</li>
<li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item>
<a href=/legaldisclosure/>
Legal Disclosure
</a>
</li>
<li data-nav-id=/rss/ title="RSS Feeds" class=dd-item>
<a href=/rss/>
RSS Feeds
</a>
</li>
</ul>
<section id=shortcuts>
<h3 class=shortcut-title>More</h3>
<ul>
<li>
<a class=padding href=https://blog.stderr.at/tags><i class="fas fa-tags"></i> Tags</a>
</li>
<li>
<a class=padding href=https://blog.stderr.at/categories><i class="far fa-bookmark"></i> Catagories</a>
</li>
<li>
<a class=padding href=https://www.redhat.com><i class="fab fa-redhat"></i> Red Hat</a>
</li>
</ul>
</section>
<section id=footer>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<aside id=toc-field class="hidden lg:block tableOfContentContainer">
<header id=TableOfContentsHeader>What's on this Page</header>
<nav id=TableOfContents>
<ul>
<li><a href=#_pod_placement_series>Pod Placement Series</a></li>
<li><a href=#_pod_affinity_and_anti_affinity>Pod Affinity and Anti-Affinity</a></li>
<li><a href=#_using_affinityanti_affinity>Using Affinity/Anti-Affinity</a>
<ul>
<li><a href=#_preparing_node_labels>Preparing node labels</a></li>
<li><a href=#_configure_pod_affinity_rule>Configure pod affinity rule</a></li>
<li><a href=#_configure_pod_anti_affinity_rule>Configure pod anti-affinity rule</a></li>
</ul>
</li>
<li><a href=#_combining_required_and_preferred_affinities>Combining required and preferred affinities</a>
<ul>
<li><a href=#_topologykey>topologyKey</a></li>
</ul>
</li>
<li><a href=#_cleanup>Cleanup</a></li>
<li><a href=#_summary>Summary</a></li>
</ul>
</nav>
<div id=navigation>
<a class=nav-prev href=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector> <i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</aside>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/> <span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span> > <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/day-2/> <span itemprop=name>OpenShift Day-2</span><meta itemprop=position content="2"></a></span> > <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/day-2/pod-placement/> <span itemprop=name>Pod Placement</span><meta itemprop=position content="3"></a></span> > Pod Affinity/Anti-Affinity
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#_pod_placement_series>Pod Placement Series</a></li>
<li><a href=#_pod_affinity_and_anti_affinity>Pod Affinity and Anti-Affinity</a></li>
<li><a href=#_using_affinityanti_affinity>Using Affinity/Anti-Affinity</a>
<ul>
<li><a href=#_preparing_node_labels>Preparing node labels</a></li>
<li><a href=#_configure_pod_affinity_rule>Configure pod affinity rule</a></li>
<li><a href=#_configure_pod_anti_affinity_rule>Configure pod anti-affinity rule</a></li>
</ul>
</li>
<li><a href=#_combining_required_and_preferred_affinities>Combining required and preferred affinities</a>
<ul>
<li><a href=#_topologykey>topologyKey</a></li>
</ul>
</li>
<li><a href=#_cleanup>Cleanup</a></li>
<li><a href=#_summary>Summary</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
<div class=tags>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/day-2>Day-2</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/pod-placement>Pod Placement</a>
<a class=tag-link href=/tags/affinity>Affinity</a>
<a class=tag-link href=/tags/anti-affinity>Anti-Affinity</a>
</div>
</div>
<div id=body-inner>
<h1>
Pod Affinity/Anti-Affinity
</h1>
<p class=tracked>
<time class="f6 mv4 dib tracked" datetime=2021-08-26T00:00:00Z>
<strong>August 26, 2021</strong>
</time>
- By:
Thomas Jungbauer
( Lastmod: 2021-09-03 )
</p>
<div class=paragraph>
<p>While noteSelector provides a very easy way to control where a pod shall be scheduled, the affinity/anti-affinity feature, expands this configuration with more expressive rules like logical AND operators, constraints against labels on other pods or soft rules instead of hard requirements.</p>
</div>
<div class=paragraph>
<p>The feature comes with two types:</p>
</div>
<div class=ulist>
<ul>
<li>
<p>pod affinity/anti-affinity - allows constrains against other pod labels rather than node labels.</p>
</li>
<li>
<p>node affinity - allows pods to specify a group of nodes they can be placed on</p>
</li>
</ul>
</div>
<div class=sect1>
<h2 id=_pod_placement_series>Pod Placement Series</h2>
<div class=sectionbody>
<div class=paragraph>
<p>Please check out other ways of pod placements:</p>
</div>
<div class=paragraph>
<div class=expand>
<div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})">
<i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>
<a>Expand me...</a>
</span>
</div>
<div class=expand-content style=display:none>
<div class="olist arabic">
<ol class=arabic>
<li>
<p><a href=/openshift/day-2/pod-placement-nodeselector/>NodeSelector</a></p>
</li>
<li>
<p><a href=/openshift/day-2/pod-placement-pod-affinity/>Pod Affinity and Anti Affinity</a></p>
</li>
<li>
<p><a href=/openshift/day-2/pod-placement-node-affinity/>Node Affinity</a></p>
</li>
<li>
<p><a href=/openshift/day-2/pod-placement-taints-and-tolerations>Taints and Tolerations</a></p>
</li>
<li>
<p><a href=/openshift/day-2/pod-placement-topology-spread-constraints/>Topology Spread Constraints</a></p>
</li>
<li>
<p><a href=/openshift/day-2/descheduler/>Descheduler</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_pod_affinity_and_anti_affinity>Pod Affinity and Anti-Affinity</h2>
<div class=sectionbody>
<div class=paragraph>
<p><strong>Affinity</strong> and <strong>Anti-Affinity</strong> controls the nodes on which a pod should (or should not) be scheduled <em>based on labels on Pods that are already scheduled on the node</em>. This is a different approach than nodeSelector, since it does not directly take the node labels into account. That said, one example for such setup would be: You have dedicated nodes for developement and production workload and you have to be sure that pods of dev or prod applications do not run on the same node.</p>
</div>
<div class=paragraph>
<p>Affinity and Anti-Affinity are shortly defined as:</p>
</div>
<div class=ulist>
<ul>
<li>
<p>Pod affinity - tells scheduler to put a new pod onto the same node as other pods (selection is done using label selectors)</p>
<div class=paragraph>
<p>For example:</p>
</div>
<div class=ulist>
<ul>
<li>
<p>I want to run where this other labelled pod is already running (Pods from same service shall be running on same node.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Pod Anti-Affinity - prevents the scheduler to place a new pod onto the same nodes with pods with the same labels</p>
<div class=paragraph>
<p>For example:</p>
</div>
<div class=ulist>
<ul>
<li>
<p>I definitely do not want to start a pod where this other pod with the defined label is running (to prevent that all Pods of same service are running in the same availability zone.)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-warning" title=Warning></i>
</td>
<td class=content>
<div class=paragraph>
<p>As described in the official <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity target=_blank rel=noopener>Kubernetes documention</a> two things should be considered:</p>
</div>
<div class="olist arabic">
<ol class=arabic>
<li>
<p>The affinity feature requires processing which can slow down the cluster. Therefore, it is not recommended for cluster with more than 100 nodes.</p>
</li>
<li>
<p>The feature requires that all nodes are consistently labelled (<code>topologyKey</code>). Unintended behaviour might happen if labels are missing.</p>
</li>
</ol>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_using_affinityanti_affinity>Using Affinity/Anti-Affinity</h2>
<div class=sectionbody>
<div class=paragraph>
<p>Currently two types of pod affinity/anti-affinity are known:</p>
</div>
<div class=ulist>
<ul>
<li>
<p><strong>requiredDuringSchedulingIgnoreDuringExecuption</strong> (short <em>required</em>) - a hard requirement which must be met before a pod can be scheduled</p>
</li>
<li>
<p><strong>preferredDuringSchedulingIgnoredDuringExecution</strong> (short <em>preferred</em>) - a soft requirement the scheduler <strong>tries</strong> to meet, but does not guarantee it</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
Both types can be defined in the same specification. In such case the node must first meet the required rule and then attempt based on best effort to meet the preferred rule.
</td>
</tr>
</tbody></table>
</div>
<div class=sect2>
<h3 id=_preparing_node_labels>Preparing node labels</h3>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
Remember the prerequisites explained in the . <a href=/openshift/day-2/pod-placement-pod-affinity/>Pod Placement - Introduction</a>. We have 4 compute nodes and an example web application up and running.
</td>
</tr>
</tbody></table>
</div>
<div class=paragraph>
<p>Before we start with affinity rules we need to label all nodes. Let’s create 2 zones (east and west) for our compute nodes using the well-known label <code>topology.kubernetes.io/zone</code></p>
</div>
<div class=imageblock>
<div class=content>
<img src=/Day-2/images/affinity-kubernetes.zones.png alt="Node Zones">
</div>
<div class=title>Figure 1. Node Zones</div>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc label nodes compute-0 compute-1 topology.kubernetes.io/zone=east

oc label nodes compute-2 compute-3 topology.kubernetes.io/zone=west</code></pre>
</div>
</div>
</div>
<div class=sect2>
<h3 id=_configure_pod_affinity_rule>Configure pod affinity rule</h3>
<div class=paragraph>
<p>In our example we have one database pod and multiple web application pods. Let’s image we would like to always run these pods in the same zone.</p>
</div>
<div class=paragraph>
<p><strong>The pod affinity defines that a pod can be scheduled onto a node ONLY if that node is in the same zone as at least one already-running pod with a certain label.</strong></p>
</div>
<div class=paragraph>
<p>This means we must first label the postgres pod accordingly. Let’s labels the pod with <code>security=zone1</code></p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc patch dc postgresql -n podtesting --type=&#39;json&#39; -p=&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/spec/template/metadata/labels/security&#34;, &#34;value&#34;: &#34;zone1&#34; }]&#39;</code></pre>
</div>
</div>
<div class=paragraph>
<p>After a while the postgres pod is restarted on one of the 4 compute nodes (since we did not specify in which zone this single pod shall be started) - here compute-1 (zone == east):</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc get pods -n podtesting -o wide | grep Running
postgresql-5-6v5h6              1/1     Running       0          119s   10.129.2.24    compute-1   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class=paragraph>
<p>As a second step, the deployment configuration of the web application must be modified. Remember, we want to run web application pods only on nodes located in the same zone as the postgres pods. In our example this would be either compute-0 or compute-1.</p>
</div>
<div class=paragraph>
<p>Modify the config accordingly:</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>kind: DeploymentConfig
apiVersion: apps.openshift.io/v1
[...]
  namespace: podtesting
spec:
[...]
  template:
[...]
    spec:
[...]
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: security <i class=conum data-value=1></i><b>(1)</b>
                    operator: In <i class=conum data-value=2></i><b>(2)</b>
                    values:
                      - zone1 <i class=conum data-value=3></i><b>(3)</b>
              topologyKey: topology.kubernetes.io/zone <i class=conum data-value=4></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>The key of the label of a pod which is already running on that node is "security"</td>
</tr>
<tr>
<td><i class=conum data-value=2></i><b>2</b></td>
<td>As operator "In" is used the postgres pod must have a matching key (security) containing the value (zone1). Other options like "NotIn", "DoesNotExist" or "Exact" are available as well</td>
</tr>
<tr>
<td><i class=conum data-value=3></i><b>3</b></td>
<td>The value must be "zone1"</td>
</tr>
<tr>
<td><i class=conum data-value=4></i><b>4</b></td>
<td>As topology the topology.kubernetes.io/zone is used. The application can be deployed on nodes with the same label</td>
</tr>
</tbody></table>
</div>
<div class=paragraph>
<p>Setting this (and maybe scaling the replicas up a little bit) will start all frontend pods either on compute-0 or on compute-1.</p>
</div>
<div class=paragraph>
<p><strong>In other words: On nodes of the same zone, where the postgres pod with the label security=zone1 is running.</strong></p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>oc get pods -n podtesting -o wide | grep Running
django-psql-example-13-4w6qd    1/1     Running     0          67s     10.128.2.58    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-655dj    1/1     Running     0          67s     10.129.2.28    compute-1   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-9d4pj    1/1     Running     0          67s     10.129.2.27    compute-1   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-bdwhb    1/1     Running     0          67s     10.128.2.61    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-d4jrw    1/1     Running     0          67s     10.128.2.57    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-dm9qk    1/1     Running     0          67s     10.128.2.60    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-ktmfm    1/1     Running     0          67s     10.129.2.25    compute-1   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-ldm56    1/1     Running     0          77s     10.128.2.55    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-mh2f5    1/1     Running     0          67s     10.129.2.29    compute-1   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-qfkhq    1/1     Running     0          67s     10.129.2.26    compute-1   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-v88qv    1/1     Running     0          67s     10.128.2.56    compute-0   &lt;none&gt;           &lt;none&gt;
django-psql-example-13-vfgf4    1/1     Running     0          67s     10.128.2.59    compute-0   &lt;none&gt;           &lt;none&gt;
postgresql-5-6v5h6              1/1     Running     0          3m18s   10.129.2.24    compute-1   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class=sect2>
<h3 id=_configure_pod_anti_affinity_rule>Configure pod anti-affinity rule</h3>
<div class=paragraph>
<p>For now the database pod and the web application pod are running on nodes of the same zone. However, somebody is asking us to configure it vice versa: the web application should not run in the same zone as postgresql.</p>
</div>
<div class=paragraph>
<p>Here we can use the Anti-Affinity feature.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class=icon>
<i class="fa icon-note" title=Note></i>
</td>
<td class=content>
As an alternative, it would also be possible to change the operator in the affinity rule from "In" to "NotIn"
</td>
</tr>
</tbody></table>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>kind: DeploymentConfig
apiVersion: apps.openshift.io/v1
[...]
  namespace: podtesting
spec:
[...]
  template:
[...]
    spec:
[...]
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: security <i class=conum data-value=1></i><b>(1)</b>
                    operator: In <i class=conum data-value=2></i><b>(2)</b>
                    values:
                      - zone1 <i class=conum data-value=3></i><b>(3)</b>
              topologyKey: topology.kubernetes.io/zone <i class=conum data-value=4></i><b>(4)</b></code></pre>
</div>
</div>
<div class=paragraph>
<p>This will force the web application pods to run only on "west" zone nodes.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-bash data-lang=bash>django-psql-example-16-4n9h5    1/1     Running     0          40s     10.131.1.53    compute-3   &lt;none&gt;           &lt;none&gt;
django-psql-example-16-blf8b    1/1     Running     0          29s     10.130.2.63    compute-2   &lt;none&gt;           &lt;none&gt;
django-psql-example-16-f9plb    1/1     Running     0          29s     10.130.2.64    compute-2   &lt;none&gt;           &lt;none&gt;
django-psql-example-16-tm5rm    1/1     Running     0          28s     10.131.1.55    compute-3   &lt;none&gt;           &lt;none&gt;
django-psql-example-16-x8lbh    1/1     Running     0          29s     10.131.1.54    compute-3   &lt;none&gt;           &lt;none&gt;
django-psql-example-16-zb5fg    1/1     Running     0          28s     10.130.2.65    compute-2   &lt;none&gt;           &lt;none&gt;
postgresql-5-6v5h6              1/1     Running     0          18m     10.129.2.24    compute-1   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_combining_required_and_preferred_affinities>Combining required and preferred affinities</h2>
<div class=sectionbody>
<div class=paragraph>
<p>It is possible to combine requiredDuringSchedulingIgnoredDuringExecution and preferredDuringSchedulingIgnoredDuringExecution. In such case the required affinity MUST be met, while the preferred affinity is tried to be met. The following examples combines these two types in an affinity and anti-affinity specification.</p>
</div>
<div class=paragraph>
<p>The <code>podAffinity</code> block defines the same as above: schedule the pod on a node of the same zone, where a pod with the label <code>security=zone1</code> is running.
The <code>podAntiAffinity</code> defines that the pod should not be started on a node if that node has a pod running with the label <code>security=zone2</code>. However, the scheduler might decide to do so as long the <code>podAffinity</code> rule is met.</p>
</div>
<div class=listingblock>
<div class=content>
<pre class=highlight><code class=language-yaml data-lang=yaml>spec:
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: security
            operator: In
            values:
            - zone1
        topologyKey: topology.kubernetes.io/zone
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100 <i class=conum data-value=1></i><b>(1)</b>
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: security
              operator: In
              values:
              - zone2
          topologyKey: topology.kubernetes.io/zone</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class=conum data-value=1></i><b>1</b></td>
<td>The <code>weight</code> field is used by the scheduler to create a scoring. The higher the scoring the more preferred is that node.</td>
</tr>
</tbody></table>
</div>
<div class=sect2>
<h3 id=_topologykey>topologyKey</h3>
<div class=paragraph>
<p>It is important to understand the <code>topologyKey</code> setting. This is the key for the node label. If an affinity rule is met, Kubernetes will try to find suitable nodes which are labelled with the topologyKey. All nodes must be labelled consistently, otherwise unintended behaviour might occur.</p>
</div>
<div class=paragraph>
<p>As described in the Kubernetes documentation at <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity target=_blank rel=noopener>Pod Affinity and Anit-Affinity</a>, the topologyKey has some constraints:</p>
</div>
<div class=paragraph>
<p><em>Quote Kubernetes:</em></p>
</div>
<div class="olist arabic">
<ol class=arabic>
<li>
<p><em>For pod affinity, empty <code>topologyKey</code> is not allowed in both <code>requiredDuringSchedulingIgnoredDuringExecution</code> and <code>preferredDuringSchedulingIgnoredDuringExecution</code>.</em></p>
</li>
<li>
<p><em>For pod anti-affinity, empty <code>topologyKey</code> is also not allowed in both <code>requiredDuringSchedulingIgnoredDuringExecution</code> and <code>preferredDuringSchedulingIgnoredDuringExecution</code>.</em></p>
</li>
<li>
<p><em>For <code>requiredDuringSchedulingIgnoredDuringExecution</code> pod anti-affinity, the admission controller <code>LimitPodHardAntiAffinityTopology</code> was introduced to limit <code>topologyKey</code> to <code>kubernetes.io/hostname</code>. If you want to make it available for custom topologies, you may modify the admission controller, or disable it.</em></p>
</li>
<li>
<p><em>Except for the above cases, the <code>topologyKey</code> can be any legally label-key.</em></p>
</li>
</ol>
</div>
<div class=paragraph>
<p><em>End of quote</em></p>
</div>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_cleanup>Cleanup</h2>
<div class=sectionbody>
<div class=paragraph>
<p>As cleanup simply remove the affinity specification from the DeploymentConf. The node labels can stay as they are since they do not hurt.</p>
</div>
</div>
</div>
<div class=sect1>
<h2 id=_summary>Summary</h2>
<div class=sectionbody>
<div class=paragraph>
<p>This concludes the quick overview of the pod affinity. The next chapter will discuss <a href=/openshift/day-2/pod-placement-node-affinity/>Node Affinity</a> rules, which allows affinity based on node specifications.</p>
</div>
</div>
</div>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation-bottom>
<a class="nav-prev btn btn-default" href=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector> <i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous: </span> NodeSelector</a>
<a class="nav-next btn btn-default" href=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Taints and Tolerations</a>
</div>
<div class=copyright>
<p>Copyright &copy; 2020 - 2021 Toni Schmidbauer & Thomas Jungbauer</p>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1638261414></script>
<script src=/js/perfect-scrollbar.min.js?1638261414></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1638261414></script>
<script src=/js/jquery.sticky.js?1638261414></script>
<script src=/js/featherlight.min.js?1638261414></script>
<script src=/js/highlight.pack.js?1638261414></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1638261414></script>
<script src=/js/learn.js?1638261414></script>
<script src=/js/hugo-learn.js?1638261414></script>
<script src=/js/yaub.js?1638261414></script>
<script>window.addEventListener('DOMContentLoaded',()=>{const a=new IntersectionObserver(a=>{a.forEach(a=>{const b=a.target.getAttribute('id');a.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${b}"]`).parentElement.classList.add('active'))})});document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach(b=>{a.observe(b)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll('aside nav li').forEach(a=>{a.classList.remove('active')})}</script>
<script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script>
<script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script>
<script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){var a;prefersDarkScheme.matches?(document.body.classList.toggle("light-theme"),a=document.body.classList.contains("light-theme")?"light":"dark"):(document.body.classList.toggle("dark-theme"),a=document.body.classList.contains("dark-theme")?"dark":"light"),localStorage.setItem("theme",a)})</script>
</body>
</html>