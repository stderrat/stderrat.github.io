<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="A basic introduction into block device usage"><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Understanding RWO block device handling in OpenShift :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1660894718 rel=stylesheet><link href=/css/fontawesome-all.min.css?1660894718 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1660894718 rel=stylesheet><link href=/css/hybrid.css?1660894718 rel=stylesheet><link href=/css/featherlight.min.css?1660894718 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1660894718 rel=stylesheet><link href=/css/auto-complete.css?1660894718 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1660894718 rel=stylesheet><link href=/css/theme.min.css?1660894718 rel=stylesheet><link href=/css/hugo-theme.css?1660894718 rel=stylesheet><link href=/css/theme-yaub.css?1660894718 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1660894718></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/openshift/2021-02-27-understanding-block-devices/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1660894718></script>
<script type=text/javascript src=/js/auto-complete.js?1660894718></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1660894718></script></div><div class=togglemode><button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class="dd-item
parent"><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2022-08-16-hashicorp-vault/ title="Secrets Management - Vault on OpenShift" class=dd-item><a href=/openshift/2022-08-16-hashicorp-vault/>Secrets Management - Vault on OpenShift</a></li><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class="dd-item active"><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2021-11-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2021-11-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2021-11-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2021-11-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/archive/ title=Archive class=dd-item><a href=/archive/>Archive</a></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://blog.stderr.at/tags><i class='fas fa-tags'></i> Tags</a></li><li><a class=padding href=https://blog.stderr.at/categories><i class='far fa-bookmark'></i> Catagories</a></li><li><a class=padding href=https://charts.stderr.at/><i class='fas fa-book'></i> Helm Charts</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_test_setup>Test setup</a><ul><li><a href=#_step_1_creating_a_new_namespaceproject>Step 1: Creating a new namespace/project</a></li><li><a href=#_step_2_defining_a_block_pvc>Step 2: Defining a block PVC</a></li></ul></li></ul></nav><div id=navigation><a class=nav-prev href=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets"><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/openshift/><span itemprop=name>OpenShift</span><meta itemprop=position content="2"></a></span>> Understanding RWO block device handling in OpenShift</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_test_setup>Test setup</a><ul><li><a href=#_step_1_creating_a_new_namespaceproject>Step 1: Creating a new namespace/project</a></li><li><a href=#_step_2_defining_a_block_pvc>Step 2: Defining a block PVC</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/storage>Storage</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/block-devices>Block devices</a></div></div><div id=body-inner><h1>Understanding RWO block device handling in OpenShift</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2021-02-27T00:00:00Z><strong>February 27, 2021</strong></time>
- By:
Toni Schmidbauer
( Lastmod: 2021-08-14 )</p><div class=paragraph><p>In this blog post we would like to explore OpenShift / Kubernetes
block device handling. We try to answer the following questions:</p></div><div class=ulist><ul><li><p>What happens if multiple pods try to access the same block device?</p></li><li><p>What happens if we scale a deployment using block devices to more than one replica?</p></li></ul></div><div class=paragraph><p>And finally we want to give a short, high level overview about how the
container storage interface (CSI) actually works.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>A block device provides Read-Write-Once (RWO) storage. This
basically means a local file system mounted by a single node. Do not
confuse this with a cluster (CephFS, GlusterFS) or network file system
(NFS). These file systems provide Read-Write-Many (RWX) storage
mountable on more than one node.</td></tr></tbody></table></div><div class=sect1><h2 id=_test_setup>Test setup</h2><div class=sectionbody><div class=paragraph><p>For running our tests we need the following resources</p></div><div class=ulist><ul><li><p>A new namespace/project for running our tests</p></li><li><p>A persistent volume claim (PVC) to be mounted in our test pods</p></li><li><p>Two pods definitions for mounting the PVC</p></li></ul></div><div class=sect2><h3 id=_step_1_creating_a_new_namespaceproject>Step 1: Creating a new namespace/project</h3><div class=paragraph><p>To run our test cases we created a new project with OpenShift</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc new-project blockdevices</code></pre></div></div></div><div class=sect2><h3 id=_step_2_defining_a_block_pvc>Step 2: Defining a block PVC</h3><div class=paragraph><p>Our cluster is running the rook operator (<a href=https://rook.io class=bare>https://rook.io</a>) and provides a ceph-block
storage class for creating block devices:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc get sc
NAME                 PROVISIONER                    RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
ceph-block           rook-ceph.rbd.csi.ceph.com     Delete          Immediate              false                  4d14h</code></pre></div></div><div class=paragraph><p>Let’s take a look a the details of the storage class:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>$ oc get sc -o yaml ceph-block
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-block
parameters:
  clusterID: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/fstype: ext4 <i class=conum data-value=1></i><b>(1)</b>
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  imageFeatures: layering
  imageFormat: &#34;2&#34;
  pool: blockpool
provisioner: rook-ceph.rbd.csi.ceph.com
reclaimPolicy: Delete
volumeBindingMode: Immediate</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>So whenever we create a PVC using this storage class the Ceph
provisioner will also create an EXT4 file system on the block device.</td></tr></tbody></table></div><div class=paragraph><p>To test block device handling we create the following persistent volume claim (PVC):</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: block-claim
spec:
  accessModes:
    - ReadWriteOnce <i class=conum data-value=1></i><b>(1)</b>
  resources:
    requests:
      storage: 1Gi
  storageClassName: ceph-block</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>The access mode is set to ReadWriteOnce (RWO), as block devices</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc create -f pvc.yaml</code></pre></div></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc get pvc
NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
block-claim   Bound    pvc-bd68be5d-c312-4c31-86a8-63a0c22de844   1Gi        RWO            ceph-block     91s</code></pre></div></div><div class=paragraph><p>To test our shiny new block device we are going to use the following three pod definitions:</p></div><div class=listingblock><div class=title>block-pod-a</div><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Pod
metadata:
  labels:
    run: block-pod-a
  name: block-pod-a
spec:
  containers:
  - image: registry.redhat.io/ubi8/ubi:8.3
    name: block-pod-a
    command:
      - sh
      - -c
      - &#39;df -h /block &amp;&amp; findmnt /block &amp;&amp; sleep infinity&#39;
    volumeMounts:
    - name: blockdevice
      mountPath: /block
  volumes:
  - name: blockdevice
    persistentVolumeClaim:
      claimName: block-claim</code></pre></div></div><div class=listingblock><div class=title>block-pod-b</div><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Pod
metadata:
  labels:
    run: block-pod-b
  name: block-pod-b
spec:
  affinity:
    podAntiAffinity: <i class=conum data-value=1></i><b>(1)</b>
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: run
                operator: In
                values:
                  - block-pod-a
          topologyKey: kubernetes.io/hostname
  containers:
  - image: registry.redhat.io/ubi8/ubi:8.3
    name: block-pod-b
    command:
      - sh
      - -c
      - &#39;df -h /block &amp;&amp; findmnt /block &amp;&amp; sleep infinity&#39;
    volumeMounts:
    - name: blockdevice
      mountPath: /block
  volumes:
  - name: blockdevice
    persistentVolumeClaim:
      claimName: block-claim</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>We use an <em>AntiAffinity</em> rule for making sure that <em>block-pod-b</em> runs
on a <strong>different</strong> node than <em>block-pod-a</em>.</td></tr></tbody></table></div><div class=listingblock><div class=title>block-pod-c</div><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Pod
metadata:
  labels:
    run: block-pod-c
  name: block-pod-c
spec:
  affinity:
    podAffinity: <i class=conum data-value=1></i><b>(1)</b>
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: run
              operator: In
              values:
              - block-pod-a
          topologyKey: kubernetes.io/hostname
  containers:
  - image: registry.redhat.io/ubi8/ubi:8.3
    name: block-pod-c
    command:
      - sh
      - -c
      - &#39;df -h /block &amp;&amp; findmnt /block &amp;&amp; sleep infinity&#39;
    volumeMounts:
    - name: blockdevice
      mountPath: /block
  volumes:
  - name: blockdevice
    persistentVolumeClaim:
      claimName: block-claim</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>We use an <em>Affinity</em> rule for making sure that <em>block-pod-c</em> runs
on the <strong>same</strong> node as <em>block-pod-a</em>.</td></tr></tbody></table></div><div class=paragraph><p>In our first test we want to make sure that both pods are running on
separate cluster nodes. So we create <em>block-pod-a</em> and <em>block-pod-b</em>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc create -f block-pod-a.yml
$ oc create -f block-pod-b.yml</code></pre></div></div><div class=paragraph><p>After a few seconds we can check the state of our pods:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc get pods -o wide
NAME          READY   STATUS              RESTARTS   AGE   IP           NODE                    NOMINATED NODE   READINESS GATES
block-pod-a   1/1     Running             0          46s   10.130.6.4   infra02.lan.stderr.at   &lt;none&gt;           &lt;none&gt;
block-pod-b   0/1     ContainerCreating   0          16s   &lt;none&gt;       infra01                 &lt;none&gt;           &lt;none&gt;</code></pre></div></div><div class=paragraph><p>Hm, block-pod-b is in the state <em>ContainerCreating</em>, let’s check the
events. Also note that it is running on another node (infra01) then
<em>block-pod-a</em> (infra02).</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>10s         Warning   FailedAttachVolume       pod/block-pod-b                     Multi-Attach error for volume &#34;pvc-bd68be5d-c312-4c31-86a8-63a0c22de844&#34; Volume is already used by pod(s) block-pod-a</code></pre></div></div><div class=paragraph><p>Ah, so because of our block device with RWO access mode and
<em>block-pod-b</em> running on separate cluster node, OpenShift or K8s can’t
attach the volume to our <em>block-pod-b</em>.</p></div><div class=paragraph><p>But let’s try another test and let’s create a third pod <em>block-pod-c</em>
that should run on the same node as <em>block-pod-a</em>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc create -f block-pod-c.yml</code></pre></div></div><div class=paragraph><p>Now let’s check the status of <em>block-pod-c</em>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>$ oc get pods -o wide
NAME          READY   STATUS              RESTARTS   AGE     IP           NODE                    NOMINATED NODE   READINESS GATES
block-pod-a   1/1     Running             0          6m49s   10.130.6.4   infra02.lan.stderr.at   &lt;none&gt;           &lt;none&gt;
block-pod-b   0/1     ContainerCreating   0          6m19s   &lt;none&gt;       infra01                 &lt;none&gt;           &lt;none&gt;
block-pod-c   1/1     Running             0          14s     10.130.6.5   infra02.lan.stderr.at   &lt;none&gt;           &lt;none&gt;</code></pre></div></div><div class=paragraph><p>Oh, <em>block-pod-c</em> is running on node <em>infra02</em> and mounted the RWO volume. Let’s check the events for <em>block-pod-c</em>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>3m6s        Normal    Scheduled                pod/block-pod-c   Successfully assigned blockdevices/block-pod-c to infra02.lan.stderr.at
2m54s       Normal    AddedInterface           pod/block-pod-c   Add eth0 [10.130.6.5/23]
2m54s       Normal    Pulled                   pod/block-pod-c   Container image &#34;registry.redhat.io/ubi8/ubi:8.3&#34; already present on machine
2m54s       Normal    Created                  pod/block-pod-c   Created container block-pod-c
2m54s       Normal    Started                  pod/block-pod-c   Started container block-pod-c</code></pre></div></div><div class=paragraph><p>When we compare this with the events for <em>block-pod-a</em>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>9m41s       Normal    Scheduled                pod/block-pod-a   Successfully assigned blockdevices/block-pod-a to infra02.lan.stderr.at
9m41s       Normal    SuccessfulAttachVolume   pod/block-pod-a   AttachVolume.Attach succeeded for volume &#34;pvc-bd68be5d-c312-4c31-86a8-63a0c22de844&#34;
9m34s       Normal    AddedInterface           pod/block-pod-a   Add eth0 [10.130.6.4/23]
9m34s       Normal    Pulled                   pod/block-pod-a   Container image &#34;registry.access.redhat.com/ubi8/ubi:8.3&#34; already present on machine
9m34s       Normal    Created                  pod/block-pod-a   Created container block-pod-a
9m34s       Normal    Started                  pod/block-pod-a   Started container block-pod-a</code></pre></div></div><div class=paragraph><p>So the <em>AttachVolume.Attach</em> message is missing in the events for
<em>block-pod-c</em>. Because the volume is already attached to the node,
interesting.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Even with RWO block device volumes it is possible to use the
same volume in multiple pods <strong>if</strong> the pods a running on the <strong>same</strong> node.</td></tr></tbody></table></div><div class=paragraph><p>I was not aware of this possibility and always had the believe with an
RWO block device only one pod can access the volume. That’s the
problem with believing :-)</p></div><div class=paragraph><p>Thanks or reading this far.</p></div></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets"><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> Secure your secrets with Sealed Secrets</a>
<a class="nav-next btn btn-default" href=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Writing Operator using Ansible</a></div><div class=copyright><p>Copyright &copy; 2020 - 2022 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1660894722></script>
<script src=/js/perfect-scrollbar.min.js?1660894722></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1660894722></script>
<script src=/js/jquery.sticky.js?1660894722></script>
<script src=/js/featherlight.min.js?1660894722></script>
<script src=/js/highlight.pack.js?1660894722></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1660894722></script>
<script src=/js/learn.js?1660894722></script>
<script src=/js/hugo-learn.js?1660894722></script>
<script src=/js/yaub.js?1660894722></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script><script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){if(prefersDarkScheme.matches){document.body.classList.toggle("light-theme");var e=document.body.classList.contains("light-theme")?"light":"dark"}else document.body.classList.toggle("dark-theme"),e=document.body.classList.contains("dark-theme")?"dark":"light";localStorage.setItem("theme",e)})</script></body></html>