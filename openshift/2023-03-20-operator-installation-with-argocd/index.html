<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="Openshift 4.x - Using Argo CD to deploy Operators"><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Operator installation with Argo CD :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1679499279 rel=stylesheet><link href=/css/fontawesome-all.min.css?1679499279 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1679499279 rel=stylesheet><link href=/css/hybrid.css?1679499279 rel=stylesheet><link href=/css/featherlight.min.css?1679499279 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1679499279 rel=stylesheet><link href=/css/auto-complete.css?1679499279 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1679499279 rel=stylesheet><link href=/css/theme.min.css?1679499279 rel=stylesheet><link href=/css/hugo-theme.css?1679499279 rel=stylesheet><link href=/css/theme-yaub.css?1679499279 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1679499279></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/openshift/2023-03-20-operator-installation-with-argocd/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1679499279></script>
<script type=text/javascript src=/js/auto-complete.js?1679499279></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1679499279></script></div><div class=togglemode><button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class="dd-item
parent"><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2023-03-20-operator-installation-with-argocd/ title="Operator installation with Argo CD" class="dd-item active"><a href=/openshift/2023-03-20-operator-installation-with-argocd/>Operator installation with Argo CD</a></li><li data-nav-id=/openshift/2023-16-02-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" class=dd-item><a href=/openshift/2023-16-02-ssl-certificate-management/>SSL Certificate Management for OpenShift on AWS</a></li><li data-nav-id=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD" class=dd-item><a href=/openshift/2022-11-04-argocd-and-serversideapply/>Using ServerSideApply with ArgoCD</a></li><li data-nav-id=/openshift/2022-08-16-hashicorp-vault/ title="Secrets Management - Vault on OpenShift" class=dd-item><a href=/openshift/2022-08-16-hashicorp-vault/>Secrets Management - Vault on OpenShift</a></li><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2022-01-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2022-01-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2022-01-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2022-01-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/archive/ title=Archive class=dd-item><a href=/archive/>Archive</a></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://blog.stderr.at/tags><i class='fas fa-tags'></i> Tags</a></li><li><a class=padding href=https://blog.stderr.at/categories><i class='far fa-bookmark'></i> Catagories</a></li><li><a class=padding href=https://charts.stderr.at/><i class='fas fa-book'></i> Helm Charts</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_tldr>TL;DR</a></li><li><a href=#_the_idea>The Idea</a></li><li><a href=#_the_problem>The Problem</a></li><li><a href=#_my_solution>My Solution</a></li><li><a href=#source_1>Let’s see this in Action</a><ul><li><a href=#_argo_cd_application>Argo CD Application</a></li><li><a href=#_helm_chart_configuration>Helm Chart Configuration</a></li><li><a href=#_synchronizing_argo_cd>Synchronizing Argo CD</a></li></ul></li></ul></nav><div id=navigation><a class=nav-prev href=/openshift/ title=OpenShift><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/openshift/2023-16-02-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/openshift/><span itemprop=name>OpenShift</span><meta itemprop=position content="2"></a></span>> Operator installation with Argo CD</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_tldr>TL;DR</a></li><li><a href=#_the_idea>The Idea</a></li><li><a href=#_the_problem>The Problem</a></li><li><a href=#_my_solution>My Solution</a></li><li><a href=#source_1>Let’s see this in Action</a><ul><li><a href=#_argo_cd_application>Argo CD Application</a></li><li><a href=#_helm_chart_configuration>Helm Chart Configuration</a></li><li><a href=#_synchronizing_argo_cd>Synchronizing Argo CD</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/oc>oc</a>
<a class=tag-link href=/tags/operator>operator</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/gitops>GitOps</a>
<a class=tag-link href=/tags/argo-cd>Argo CD</a></div></div><div id=body-inner><h1>Operator installation with Argo CD</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2023-03-20T00:00:00Z><strong>March 20, 2023</strong></time>
- By:
Thomas Jungbauer & Toni Schmidbauer
( Lastmod: 2023-03-22 )</p><div class=paragraph><p>GitOps for application deployment and cluster configuration is a must-have I am trying to convince every customer to follow from the very beginning when starting the Kubernetes journey. For me, as more on the infrastructure side of things, I am more focused on the configuration of an environment.
Meaning, configuring a cluster, installing an operator etc.</p></div><div class=paragraph><p>In this article, I would like to share how I deal with cluster configuration when certain Kubernetes objects are dependent on each other and how to use Kubernetes but also Argo CD features to resolve these dependencies.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This article assumes that you have the <strong>openshift-gitops</strong> Operator, which provides Argo CD, already installed, and configured. If you are new to GitOps check out this article: <a href=http://localhost:52942/openshift/2020-08-06-argocd/>Argo CD</a></td></tr></tbody></table></div><div class=sect1><h2 id=_tldr>TL;DR</h2><div class=sectionbody><div class=paragraph><p>If you want to jump directly to the technical fun part, go here: <a href=#source_1>Let’s start</a>.</p></div></div></div><div class=sect1><h2 id=_the_idea>The Idea</h2><div class=sectionbody><div class=paragraph><p>Everything should be seen as a code. Everything should be possible to be deployed in a repeatable way. With a GitOps approach, everything is stored naturally in Git and from there a GitOps agent validates and synchronizes changes to one or more clusters.</p></div><div class=paragraph><p>When it comes to OpenShift, Red Hat supports Argo CD using the Operator <strong>openshift-gitops</strong>. This gives you everything you need to deploy an Argo CD instance. The only thing you need to take care of is a Git repository, no matter if it is GitHub, Gitlab, Bitbucket etc.</p></div></div></div><div class=sect1><h2 id=_the_problem>The Problem</h2><div class=sectionbody><div class=paragraph><p>Storing everything in Git provides you with an easy way to configure your cluster.</p></div><div class=paragraph><p>However, sometimes Kubernetes objects depend on each other. This is especially true when you would like to install and configure Operators, where the configuration, based on a Customer Resource Definition (CRD), can only happen after the Operator has been installed and is ready.</p></div><div class=paragraph><p>Why is that? Well, when you want to deploy an Operator, you will store a “Subscription object” in Git. Argo CD will take this object and applies it to the cluster. However, for an Operator, the creation of the Subscription object is just the first step. A lot of other steps are required until the Operator gets ready. Unfortunately, Argo CD cannot verify if the installation is successful. All it sees is that the Subscription object has been created and then it immediately tries to deploy the CRD. The CRD which is not yet available on the system because the Operator is still installing it.</p></div><div class=paragraph><p>Even if you use Argo CD features like Sync waves it would wait until the Operator is successfully installed because for Argo CD the “success” is the creation of the Subscription object.</p></div><div class=paragraph><p>Subsequently, the Argo CD synchronisation process will fail.
You could now try to automatically “Retry” the sync or use multiple Argo CD applications that you execute one after each other, but I was not fully happy with that and tried a different approach.</p></div></div></div><div class=sect1><h2 id=_my_solution>My Solution</h2><div class=sectionbody><div class=paragraph><p>Let’s say I would like to deploy and configure the <strong>Compliance Operator</strong>. The steps would be:</p></div><div class="olist arabic"><ol class=arabic><li><p>Install the Operator.</p></li><li><p>Wait until the Operator is ready.</p></li><li><p>Configure Operator specific CRDs.</p></li></ol></div><div class=paragraph><p>This “Wait until the Operator is ready” is the tricky party for Argo CD. What I have done is the following:</p></div><div class="olist arabic"><ol class=arabic><li><p>Install the Operator, this is the first step and is done during Sync Wave 0.</p></li><li><p>Create a Kubernetes Job that verifies the status of the Operator. This Job additionally requires a ServiceAccount and a role with a binding. The configured Sync Wave is 1. Moreover, I use a <strong>Hook</strong> (another Argo CD feature) with the deletion policy “HookSucceeded”. This makes sure that the Job, ServiceAccount, Role and RoleBinding are removed after the status has been verified.
The verification is successful as soon as the Operator status says “Succeeded”. In fact, all the Job does is to execute some oc commands. For example,</p><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc get clusterserviceversion openshift-gitops-operator.v1.8.0 -n openshift-gitops -o jsonpath={.status.phase}

Succeeded</code></pre></div></div></li><li><p>Finally, during the next Sync Wave (2+) the CRD can be deployed. In this case, I deploy the object <strong>ScanSettingBinding</strong>.</p></li></ol></div><div class=paragraph><p>In Argo CD everything is correctly synchronized, and the Operator and its configuration are in place.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>If you are new to the compliance operator, I recommend the following article: <a href=https://blog.stderr.at/compliance/2021/07/compliance-operator/>Compliance Operator</a></td></tr></tbody></table></div><div class=paragraph><p>I use this approach for every Operator that I would like to install and configure at the same time. For example, I do the same for Advanced Cluster Security or Management where I use the Job to verify if everything is ready before I let Argo CD continue.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>More information about Sync Waves and Hooks can be found in the official Argo CD documentation: <a href=https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/>Sync Phases and Waves</a></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=source_1>Let’s see this in Action</h2><div class=sectionbody><div class=paragraph><p><strong>Prerequisites</strong></p></div><div class="olist arabic"><ol class=arabic><li><p>OpenShift cluster 4.x</p></li><li><p>openshift-gitops is installed and ready to be used.</p></li><li><p>Access to GitHub (or to your own Repository)</p></li></ol></div><div class=paragraph><p>I will be using my Helm Chart repository at <a href=https://charts.stderr.at/ class=bare>https://charts.stderr.at/</a> and from there the charts:</p></div><div class="olist arabic"><ol class=arabic><li><p>compliance-operator-full-stack</p><div class="olist loweralpha"><ol class=loweralpha type=a><li><p>helper-operator (sub chart): Responsible to install the Operators.</p></li><li><p>helper-status-checker (sub chart): Responsible to check the status of the Operator.</p></li></ol></div></li></ol></div><div class=paragraph><p><strong>Why do I use Helm charts?</strong>
There is no specific reason for that. I started with Helm for the cluster configuration and now it has evolved with a separate Chart repository and sub-charts and so on.</p></div><div class=sect2><h3 id=_argo_cd_application>Argo CD Application</h3><div class=paragraph><p>In Argo CD I have the following Application:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: in-cluster-install-compliance-scans
  namespace: openshift-gitops
spec:
  destination:
    namespace: default
    server: &#39;https://kubernetes.default.svc&#39; <i class=conum data-value=1></i><b>(1)</b>
  info:
    - name: Description
      value: Deploy and configure the Compliance Scan Operator
  project: in-cluster
  source:
    path: charts/compliance-operator-full-stack <i class=conum data-value=2></i><b>(2)</b>
    repoURL: &#39;https://github.com/tjungbauer/helm-charts&#39;
    targetRevision: main</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Installing on the local cluster where Argo CD is installed.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Git configuration, including path and revision.</td></tr></tbody></table></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Actually, this Application is created out of an ApplicationSet, but I did not want to make it too complex :)</td></tr></tbody></table></div><div class=paragraph><p>The Application would like to synchronize the objects:</p></div><div class="olist arabic"><ol class=arabic><li><p>Subscription</p></li><li><p>OperatorGroup</p></li><li><p>Namespace (openshift-compliance)</p></li><li><p>ScanSettingBinding</p></li></ol></div><div class=imageblock><div class=content><img src=/OpenShift/images/argocd2/argocd-operator-installation.png alt="Installing Compliance Operator"></div><div class=title>Figure 1. Argo CD: Installing Compliance Operator</div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><strong>Where are the objects we need for the Job?</strong> Since they are only available during the Sync-Hook they will not show up here. In fact, they will only show up during the time they are alive and will disappear again after the status of the operator has been verified.</td></tr></tbody></table></div></div><div class=sect2><h3 id=_helm_chart_configuration>Helm Chart Configuration</h3><div class=paragraph><p>The <a href=https://github.com/tjungbauer/helm-charts/tree/main/charts/compliance-operator-full-stack>Helm Chart</a> gets its configuration from a values file. You can verify the whole file on GitHub.</p></div><div class=paragraph><p>The important pieces here are that some variables are handed over to the appropriate Sub Charts.</p></div><div class=sect3><h4 id=_operator_configuration>Operator Configuration</h4><div class=paragraph><p>This part is handed over to the Chart “<strong>helper-operator</strong>”.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>helper-operator:
  operators:
    compliance-operator:
      enabled: true
      syncwave: &#39;0&#39;
      namespace:
        name: openshift-compliance
        create: true
      subscription:
        channel: release-0.1
        approval: Automatic
        operatorName: compliance-operator
        source: redhat-operators
        sourceNamespace: openshift-marketplace
      operatorgroup:
        create: true
        notownnamespace: true</code></pre></div></div><div class=paragraph><p>It is executed during Sync Wave 0 and defines if a Namespace (openshift-compliance) shall be created (true) and the specification of the Operator which you need to know upfront:</p></div><div class="olist arabic"><ol class=arabic><li><p><strong>channel</strong>: Defines which channel shall be used. Some operators offer different channels.</p></li><li><p><strong>approval</strong>: Either Automatic or Manuel … defines if the Operator shall be updated automatically or requires and approval.</p></li><li><p><strong>operatorName</strong>: the actual name of the Operator (compliance-operator)</p></li><li><p><strong>source</strong>: Where does this Operator come from (redhat-operator)</p></li><li><p><strong>sourceNamespace</strong>: In this case openshift-marketplace</p></li></ol></div><div class=paragraph><p>You can fetch these values by looking at the Packagemanifest:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc get packagemanifest compliance-operator -o yaml</code></pre></div></div></div><div class=sect3><h4 id=_status_checker_configuration>Status Checker Configuration</h4><div class=paragraph><p>This part is handed over to the Sub-Chart "<strong>helper-status-checker</strong>"". The main values here are the operatorName and the namespace where the Operator is installed.</p></div><div class=paragraph><p>What is not visible here is the Sync Wave, which is per default set to 1 inside the Helm Chart. If you need to overwrite it, it can be configured in this section as well.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>helper-status-checker:
  enabled: true <i class=conum data-value=1></i><b>(1)</b>

  # use the value of the currentCSV (packagemanifest) but WITHOUT the version !!
  operatorName: compliance-operator <i class=conum data-value=2></i><b>(2)</b>

  # where operator is installed
  namespace:
    name: openshift-compliance <i class=conum data-value=3></i><b>(3)</b>

  serviceAccount:
    create: true
    name: &#34;sa-compliance&#34; <i class=conum data-value=4></i><b>(4)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Is the status checker enabled or is it not.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>The name of the operator as it is reported by the value currentCSV inside the packageManifest</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>The namespace where the Operator has been installed.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>The name of the ServiceAccount that is created temporarily.</td></tr></tbody></table></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>The operatorName is sometimes different than the Operator name required for helper-operator chart. Here it seems the value of the currentCSV must be used but without the version number. (The Job will look up the version itself)</td></tr></tbody></table></div></div><div class=sect3><h4 id=_operator_crd_configuration>Operator CRD configuration</h4><div class=paragraph><p>The final section of the values file manages the configuration for the Operator itself. This section does not use a Sub Chart. Instead, the variables are used in the Main-Chart. In this example, the <strong>ScanSettingBinding</strong> will be configured during Sync Wave 3, which is all we need to basic functionality.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>compliance:
  scansettingbinding:
    enabled: true
    syncwave: &#39;3&#39; <i class=conum data-value=1></i><b>(1)</b>
    profiles: <i class=conum data-value=2></i><b>(2)</b>
      - name: ocp4-cis-node
      - name: ocp4-cis
    scansetting: default</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Define the Sync Wave. This value must be higher than the Sync Wave of the <strong>helper-status-checker</strong></td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>ScanSettingBinding configuration. Two profiles are used in this example.</td></tr></tbody></table></div></div></div><div class=sect2><h3 id=_synchronizing_argo_cd>Synchronizing Argo CD</h3><div class="olist arabic"><ol class=arabic><li><p>Basic Application in Argo CD before it is synced:</p><div class=imageblock><div class=content><img src="/OpenShift/images/argocd2/argocd-operator-installation.png?width=480" alt="argocd operator installation"></div><div class=title>Figure 2. Argo CD: Application</div></div></li><li><p>Sync Wave 0: Synchronization has started. Namespace and Subscription are deployed.</p><div class=imageblock><div class=content><img src="/OpenShift/images/argocd2/argocd-starting-operator-installation.png?width=480" alt="argocd starting operator installation"></div><div class=title>Figure 3. Argo CD: Synchronization is started (Sync Wave 0)</div></div></li><li><p>Sync Wave 1: Status Checker Job has started and tries to verify the Operator.</p><div class=imageblock><div class=content><img src="/OpenShift/images/argocd2/argocd-starting-job.png?width=480" alt="argocd starting job"></div><div class=title>Figure 4. Argo CD: Status Checker Job started (Sync Wave 1)</div></div></li><li><p>The Log output of the Operator. You can see that the status switches from Pending, to Installing to Succeeded.</p><div class=imageblock><div class=content><img src="/OpenShift/images/argocd2/argocd-status-checker-log.png?width=480" alt="argocd status checker log"></div><div class=title>Figure 5. Argo CD: Log of the Status Checker Pod</div></div></li><li><p>After Sync Wave 3 the whole Application has been synchronized and the Checker Job has been removed.</p><div class=imageblock><div class=content><img src="/OpenShift/images/argocd2/argocd-operator-installed.png?width=480" alt="argocd operator installed"></div><div class=title>Figure 6. Argo CD: Compliance Operator is fully deployed</div></div></li></ol></div></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/openshift/ title=OpenShift><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> OpenShift</a>
<a class="nav-next btn btn-default" href=/openshift/2023-16-02-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> SSL Certificate Management for OpenShift on AWS</a></div><div class=copyright><p>Copyright &copy; 2020 - 2023 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1679499284></script>
<script src=/js/perfect-scrollbar.min.js?1679499284></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1679499284></script>
<script src=/js/jquery.sticky.js?1679499284></script>
<script src=/js/featherlight.min.js?1679499284></script>
<script src=/js/highlight.pack.js?1679499284></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1679499284></script>
<script src=/js/learn.js?1679499284></script>
<script src=/js/hugo-learn.js?1679499284></script>
<script src=/js/yaub.js?1679499284></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script><script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){if(prefersDarkScheme.matches){document.body.classList.toggle("light-theme");var e=document.body.classList.contains("light-theme")?"light":"dark"}else document.body.classList.toggle("dark-theme"),e=document.body.classList.contains("dark-theme")?"dark":"light";localStorage.setItem("theme",e)})</script></body></html>