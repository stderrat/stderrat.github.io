<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="Using GitOps approach to install and configure Quay Enterprise"><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><meta name=keywords content="OpenShift,OCP,GitOps,Argo CD,Quay"><link rel=canonical href=https://blog.stderr.at/openshift/2023-11-03-quay-deployment-with-gitops/><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Quay Deployment and Configuration using GitOps :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1699896386 rel=stylesheet><link href=/css/fontawesome-all.min.css?1699896386 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1699896386 rel=stylesheet><link href=/css/hybrid.css?1699896386 rel=stylesheet><link href=/css/featherlight.min.css?1699896386 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1699896386 rel=stylesheet><link href=/css/auto-complete.css?1699896386 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1699896386 rel=stylesheet><link href=/css/theme.min.css?1699896386 rel=stylesheet><link href=/css/hugo-theme.css?1699896386 rel=stylesheet><link href=/css/theme-yaub.css?1699896386 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1699896386></script>
<script src=/js/jquery.waypoints.min.js?1699896386></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/openshift/2023-11-03-quay-deployment-with-gitops/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<span class=read-progress></span><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1699896386></script>
<script type=text/javascript src=/js/auto-complete.js?1699896386></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1699896386></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class="dd-item
parent"><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2023-11-03-quay-deployment-with-gitops/ title="Quay Deployment and Configuration using GitOps" class="dd-item active"><a href=/openshift/2023-11-03-quay-deployment-with-gitops/>Quay Deployment and Configuration using GitOps</a></li><li data-nav-id=/openshift/2023-10-23-openshift-falco/ title="Setting up Falco on OpenShift 4.12" class=dd-item><a href=/openshift/2023-10-23-openshift-falco/>Setting up Falco on OpenShift 4.12</a></li><li data-nav-id=/openshift/2023-10-18-force-machineconfig-rollout/ title="How to force a MachineConfig rollout" class=dd-item><a href=/openshift/2023-10-18-force-machineconfig-rollout/>How to force a MachineConfig rollout</a></li><li data-nav-id=/openshift/2023-03-20-operator-installation-with-argocd/ title="Operator installation with Argo CD" class=dd-item><a href=/openshift/2023-03-20-operator-installation-with-argocd/>Operator installation with Argo CD</a></li><li data-nav-id=/openshift/2023-02-16-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" class=dd-item><a href=/openshift/2023-02-16-ssl-certificate-management/>SSL Certificate Management for OpenShift on AWS</a></li><li data-nav-id=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD" class=dd-item><a href=/openshift/2022-11-04-argocd-and-serversideapply/>Using ServerSideApply with ArgoCD</a></li><li data-nav-id=/openshift/2022-08-16-hashicorp-vault/ title="Secrets Management - Vault on OpenShift" class=dd-item><a href=/openshift/2022-08-16-hashicorp-vault/>Secrets Management - Vault on OpenShift</a></li><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2022-01-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2022-01-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2022-01-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2022-01-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/securesupplychain/ title="Secure Supply Chain" class=dd-item><a href=/securesupplychain/>Secure Supply Chain</a><ul><li data-nav-id=/securesupplychain/2023-06-15-securesupplychain-intro/ title="Introduction to a Secure Supply Chain" class=dd-item><a href=/securesupplychain/2023-06-15-securesupplychain-intro/>Introduction to a Secure Supply Chain</a></li><li data-nav-id=/securesupplychain/2023-06-16-securesupplychain-step1/ title="Step 1 - Listen to Events" class=dd-item><a href=/securesupplychain/2023-06-16-securesupplychain-step1/>Step 1 - Listen to Events</a></li><li data-nav-id=/securesupplychain/2023-06-17-securesupplychain-step2/ title="Step 2 - Pipelines" class=dd-item><a href=/securesupplychain/2023-06-17-securesupplychain-step2/>Step 2 - Pipelines</a></li><li data-nav-id=/securesupplychain/2023-06-18-securesupplychain-step3/ title="Step 3 - SonarQube" class=dd-item><a href=/securesupplychain/2023-06-18-securesupplychain-step3/>Step 3 - SonarQube</a></li><li data-nav-id=/securesupplychain/2023-06-19-securesupplychain-step4/ title="Step 4 - Verify Git Commit" class=dd-item><a href=/securesupplychain/2023-06-19-securesupplychain-step4/>Step 4 - Verify Git Commit</a></li><li data-nav-id=/securesupplychain/2023-06-20-securesupplychain-step5/ title="Step 5 - Build and Sign Image" class=dd-item><a href=/securesupplychain/2023-06-20-securesupplychain-step5/>Step 5 - Build and Sign Image</a></li><li data-nav-id=/securesupplychain/2023-06-21-securesupplychain-step6/ title="Step 6 - Scanning with ACS" class=dd-item><a href=/securesupplychain/2023-06-21-securesupplychain-step6/>Step 6 - Scanning with ACS</a></li><li data-nav-id=/securesupplychain/2023-06-22-securesupplychain-step7/ title="Step 7 - Generating a SBOM" class=dd-item><a href=/securesupplychain/2023-06-22-securesupplychain-step7/>Step 7 - Generating a SBOM</a></li><li data-nav-id=/securesupplychain/2023-06-23-securesupplychain-step8/ title="Step 8 - Updating Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-23-securesupplychain-step8/>Step 8 - Updating Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-24-securesupplychain-step9/ title="Step 9 - Linting Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-24-securesupplychain-step9/>Step 9 - Linting Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-25-securesupplychain-step10/ title="Step 10 - The Example Application" class=dd-item><a href=/securesupplychain/2023-06-25-securesupplychain-step10/>Step 10 - The Example Application</a></li><li data-nav-id=/securesupplychain/2023-06-26-securesupplychain-step11/ title="Step 11 - ACS Deployment Check" class=dd-item><a href=/securesupplychain/2023-06-26-securesupplychain-step11/>Step 11 - ACS Deployment Check</a></li><li data-nav-id=/securesupplychain/2023-06-27-securesupplychain-step12/ title="Step 12 - Verify TLog Signature" class=dd-item><a href=/securesupplychain/2023-06-27-securesupplychain-step12/>Step 12 - Verify TLog Signature</a></li><li data-nav-id=/securesupplychain/2023-06-28-securesupplychain-step13/ title="Step 13 - Bring it to Production" class=dd-item><a href=/securesupplychain/2023-06-28-securesupplychain-step13/>Step 13 - Bring it to Production</a></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://blog.stderr.at/tags><i class='fas fa-tags'></i> Tags</a></li><li><a class=padding href=https://blog.stderr.at/categories><i class='far fa-bookmark'></i> Catagories</a></li><li><a class=padding href=https://blog.stderr.at/archive><i class='fas fa-box'></i> Archive</a></li><li><a class=padding href=https://charts.stderr.at/><i class='fas fa-book'></i> Helm Charts</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body class=post-content><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_what_about_quay_configuration>What about Quay configuration?</a></li><li><a href=#_the_solution>The solution?</a></li><li><a href=#_let_us_see_that_in_action>Let us see that in action</a><ul><li><a href=#_prerequisites>Prerequisites</a></li></ul></li><li><a href=#_deployment_workflow>Deployment Workflow</a></li><li><a href=#_configuration>Configuration</a></li><li><a href=#_deploy_it>Deploy it</a></li><li><a href=#_quay_is_alive>Quay is Alive</a></li><li><a href=#_is_that_all_kind_of_summary>Is that All - Kind of Summary?</a></li></ul></nav><div id=navigation><a class=nav-prev href=/openshift/ title=OpenShift><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/openshift/2023-10-23-openshift-falco/ title="Setting up Falco on OpenShift 4.12" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/openshift/><span itemprop=name>OpenShift</span><meta itemprop=position content="2"></a></span>> Quay Deployment and Configuration using GitOps</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_what_about_quay_configuration>What about Quay configuration?</a></li><li><a href=#_the_solution>The solution?</a></li><li><a href=#_let_us_see_that_in_action>Let us see that in action</a><ul><li><a href=#_prerequisites>Prerequisites</a></li></ul></li><li><a href=#_deployment_workflow>Deployment Workflow</a></li><li><a href=#_configuration>Configuration</a></li><li><a href=#_deploy_it>Deploy it</a></li><li><a href=#_quay_is_alive>Quay is Alive</a></li><li><a href=#_is_that_all_kind_of_summary>Is that All - Kind of Summary?</a></li></ul></nav></div></div><div class=social><a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f" class="facebook no-highlight" aria-label="share on Facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-facebook" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a href="https://twitter.com/intent/tweet?hashtags=codingnconcepts&url=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f&text=Quay%20Deployment%20and%20Configuration%20using%20GitOps" class="twitter no-highlight" aria-label="share on Twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg></div></div></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f&source=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f&title=Quay%20Deployment%20and%20Configuration%20using%20GitOps&summary=Quay%20Deployment%20and%20Configuration%20using%20GitOps" class="linkedin no-highlight" aria-label="share on Linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg></div></div></a><a href="whatsapp://send?text=Quay%20Deployment%20and%20Configuration%20using%20GitOps%2c%20by%20TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more%0aUsing%20GitOps%20approach%20to%20install%20and%20configure%20Quay%20Enterprise%0a%0ahttps%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f%0a" class="whatsapp no-highlight" aria-label="share on Whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-whatsapp" width="24" height="24" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a href="mailto:?subject=TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more - Quay%20Deployment%20and%20Configuration%20using%20GitOps.&body=Quay%20Deployment%20and%20Configuration%20using%20GitOps%2c%20by%20TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more%0aUsing%20GitOps%20approach%20to%20install%20and%20configure%20Quay%20Enterprise%0a%0ahttps%3a%2f%2fblog.stderr.at%2fopenshift%2f2023-11-03-quay-deployment-with-gitops%2f%0a" class="email no-highlight" aria-label="share on Email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg></div></div></a></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/gitops>GitOps</a>
<a class=tag-link href=/tags/argo-cd>Argo CD</a>
<a class=tag-link href=/tags/quay>Quay</a></div></div><div id=body-inner><h1>Quay Deployment and Configuration using GitOps</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2023-11-03T00:00:00Z><strong>November 3, 2023</strong></time>
- By:
Thomas Jungbauer
( Lastmod: 2023-11-03 ) - <span class=readtime><strong>4 min read</strong></span></p><div class=paragraph><p>Installing and configuring Quay Enterprise using a GitOps approach is not as easy as it sounds.
On the one hand, the operator is deployed easily, on the other hand, the configuration of Quay is quite tough to do in a declarative way and syntax rules must be strictly followed.</p></div><div class=paragraph><p>In this article, I am trying to explain how I solved this issue by using a Kubernetes Job and a Helm Chart.</p></div><div class=sect1><h2 id=_what_about_quay_configuration>What about Quay configuration?</h2><div class=sectionbody><div class=paragraph><p>Quay Enterprise is using a (quite big) Secrets object that defines tons of settings for the registry. The syntax must strictly be followed.
For example, a Boolean must be <code>true</code> or <code>false</code>. Quay ignores if a string like <strong>"true"</strong> or <strong>"false"</strong> is provided.</p></div><div class=paragraph><p>This alone is already a hassle since working with Booleans in Helm is not as easy as you might think.</p></div><div class=paragraph><p>The Secret combines <strong>non-sensitive data</strong> (like <em>DEFAULT_TAG_EXPIRATION</em>) with <strong>sensitive data</strong> (like settings for the Object Store)</p></div><div class=paragraph><p>If there is any error in the configuration file, or if the Operator is configured to manage a specific component, but finds settings for this component in the Secret, the deployment will fail.</p></div></div></div><div class=sect1><h2 id=_the_solution>The solution?</h2><div class=sectionbody><div class=paragraph><p>I thought for a long time about how to solve this issue. One solution might be to create the whole Secret upfront and simply provide it
during the deployment. This works and I have done this previously, but I wanted to generate the Secret during the deployment.</p></div><div class=paragraph><p>Therefore, I am now trying to create a ConfigMap that holds a complete skeleton of the required Secret. This ConfigMap is used by a
Kubernetes Job, which reads the required sensitive information out of other existing Secrets (such as S3 information) and generates a
quay-secret by replacing the required fields.</p></div><div class=paragraph><p>Is this the perfect and optimal way to do that? Probably not, however, it works :)</p></div></div></div><div class=sect1><h2 id=_let_us_see_that_in_action>Let us see that in action</h2><div class=sectionbody><div class=sect2><h3 id=_prerequisites>Prerequisites</h3><div class=paragraph><p>First, we have some prerequisites.</p></div><div class="olist arabic"><ol class=arabic><li><p>Quay is very …​ very hungry for resources. Quay application pods require 8 CPU and 16GB Memory per pod and per default…​ and it tries to spin up 2 pods. The
same goes for Clair and so on. Therefore, I will configure Quay to only use 1 replica for these services.</p></li><li><p>Quay requires node roles <code>infra</code>. I am not sure if this is new or if I never saw that, but the nodeSelector, which it seems you cannot
configure, is looking for the label infra. Therefore, the nodes that should host Quay must have the label: <code>node-role.kubernetes.io/infra: ''</code></p></li><li><p>Currently, I am using a <code>BucketClaim</code> object to create an S3-bucket
and once created I read the required information of the bucket to
replace the settings in the generated Quay configuration accordingly.
The BucketClaim object comes from the <strong>OpenShift Data Foundation</strong>. I
installed the <strong>Multicloud Object Gateway</strong> only, which allows me to
provide Object Storage (S3). (Very useful to test other solutions too,
like OpenShift Logging or Network Observability)</p></li></ol></div><div class=paragraph><p>Meeting these requirements, allows us to deploy Quay. But first some theory.</p></div></div></div></div><div class=sect1><h2 id=_deployment_workflow>Deployment Workflow</h2><div class=sectionbody><div class=paragraph><p>The workflow of the deployment is as the following image demonstrates</p></div><div class=imageblock><div class=content><img src=/OpenShift/images/quay-setup/quay-synwaves.png alt="Argo CD Syncwaves"></div><div class=title>Figure 1. Argo CD: Syncwaves</div></div><div class="olist arabic"><ol class=arabic><li><p>Everything starts with the Helm Chart <a href=https://github.com/tjungbauer/openshift-cluster-bootstrap/tree/main/clusters/management-cluster/setup-quay>setup-quay</a>. This Chart itself provides the logic to create an S3-bucket, a Job to generate the configuration and the creation of a Secret, that provides the initial administrator credential.</p></li><li><p><strong>setup-quay</strong> has multiple dependencies to other Helm charts, that can be found at my <a href=https://charts.stderr.at>Helm repository</a>:</p><div class="olist loweralpha"><ol class=loweralpha type=a><li><p><a href=https://github.com/tjungbauer/helm-charts/tree/main/charts/quay-registry-setup>quay-registry-setup</a></p></li><li><p><a href=https://github.com/tjungbauer/helm-charts/tree/main/charts/helper-operator>helper-operator</a></p></li><li><p><a href=https://github.com/tjungbauer/helm-charts/tree/main/charts/helper-status-checker>helper-status-checker</a></p></li></ol></div></li></ol></div></div></div><div class=sect1><h2 id=_configuration>Configuration</h2><div class=sectionbody><div class=paragraph><p>All values for the Helm Charts can be found in the <a href=https://github.com/tjungbauer/openshift-cluster-bootstrap/blob/main/clusters/management-cluster/setup-quay/values.yaml>values file</a></p></div><div class=paragraph><p>Since sub-charts are used the file is divided into 4 blocks:</p></div><div class="olist arabic"><ol class=arabic><li><p>helper-operator: Here the sub-chart helper-operator is configured. All settings here are bypassed to the subchart. It defines the required settings to deploy the operator.</p></li><li><p>helper-status-checker: Here settings for the status-checker Job are defined.</p></li><li><p>quay-registry-setup: This defines the actual configuration of the QuayEnterprise object. It will spin up the Quay instance. Some components are set to "false" or "replica == 1" to minimize the required resources in my lab. For a production environment, additional replicas or components might be required.</p></li><li><p>quay: These are the actual values for the configuration. It defines the bucketClaim as well as settings for the Quay configuration that might be overwritten.</p></li></ol></div></div></div><div class=sect1><h2 id=_deploy_it>Deploy it</h2><div class=sectionbody><div class=paragraph><p>Using for example the following Argo CD Application we can deploy everything.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: in-cluster-setup-quay
  namespace: openshift-gitops
spec:
  destination:
    name: in-cluster <i class=conum data-value=1></i><b>(1)</b>
    namespace: default
  ignoreDifferences: <i class=conum data-value=2></i><b>(2)</b>
    - jsonPointers:
        - /data/password
      kind: Secret
      name: init-user
      namespace: quay-enterprise
  info:
    - name: Description
      value: ApplicationSet that Deploys on Management Cluster (Matrix Generator)
  project: in-cluster
  source:
    path: clusters/management-cluster/setup-quay <i class=conum data-value=3></i><b>(3)</b>
    repoURL: &#39;https://github.com/tjungbauer/openshift-cluster-bootstrap&#39;
    targetRevision: main</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>The destination cluster. Here the "in-cluster" means the local cluster of Argo CD.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>The initial credential for Quay is being generated and would change if the Argo CD application gets refreshed and therefore it would be out of sync. So, we are ignoring differences in the password field.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>The source of the Helm Chart.</td></tr></tbody></table></div><div class=paragraph><p>In Argo CD this Application will look like</p></div><div class=imageblock><div class=content><img src="/OpenShift/images/quay-setup/quay-in-argocd.png?width=640px" alt="Quay in Argo CD"></div><div class=title>Figure 2. Quay in Argo CD</div></div><div class=paragraph><p>Deployment means in GitOps approach: synchronizing the Argo CD Application.</p></div><div class=paragraph><p>This will install the Operator and spin up all required Pods and Jobs. It will take several minutes until everything is up and running. During the deployment, some Pods may fail and will get restarted automatically. This happens because they are dependent on the Postgres DB which must be started first.</p></div></div></div><div class=sect1><h2 id=_quay_is_alive>Quay is Alive</h2><div class=sectionbody><div class=paragraph><p>Congratulations, you have now a Quay instance. Use the auto-generated
credentials, that are stored in the Secret <code>init-user</code> to authenticate.</p></div><div class=imageblock><div class=content><img src="/OpenShift/images/quay-setup/quay-login.png?width=320px" alt="Quay Login"></div><div class=title>Figure 3. Quay Login</div></div></div></div><div class=sect1><h2 id=_is_that_all_kind_of_summary>Is that All - Kind of Summary?</h2><div class=sectionbody><div class=paragraph><p>Several configurations are done here now. However, there are tons to follow. For example, log forwarding or additional certificates. Some
settings will contain sensitive information some will not. All these settings can be added to the ConfigMap skeleton and be replaced
accordingly with "little" effort.
For me, it is simply not possible to test every setting and possibility. Maybe I will extend the
Helm Chart during the journey. If you find this useful, feel free to re-use it and of course, if you find any issues feel free to create a GitHub issue.</p></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/openshift/ title=OpenShift><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> OpenShift</a>
<a class="nav-next btn btn-default" href=/openshift/2023-10-23-openshift-falco/ title="Setting up Falco on OpenShift 4.12" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Setting up Falco on OpenShift 4.12</a></div><div class=copyright><p>Copyright &copy; 2020 - 2023 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><script>(function(){$("document").ready(function(){var s=$(".read-progress").waypoint({handler:function(e){e=="down"?($(".read-progress").addClass("position-fixed"),$(".read-progress").css("top",0)):($(".read-progress").removeClass("position-fixed"),$(".read-progress").css("top"))}}),t=$(window).height(),e=$(".post-content").height();$(window).on("scroll",n),$(window).on("resize",function(){t=$(window).height(),e=$(".post-content").height(),n()});function n(){var s=$(this).scrollTop(),o=$(".post-content").offset().top,i=e-(e-(t-(o-s))),n=i/e*100,n=n>100?100:n;$(".read-progress").width(n+"%")}})})()</script><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1699896392></script>
<script src=/js/perfect-scrollbar.min.js?1699896392></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1699896392></script>
<script src=/js/jquery.sticky.js?1699896392></script>
<script src=/js/featherlight.min.js?1699896392></script>
<script src=/js/highlight.pack.js?1699896392></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1699896392></script>
<script src=/js/learn.js?1699896392></script>
<script src=/js/hugo-learn.js?1699896392></script>
<script src=/js/yaub.js?1699896392></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script></body></html>