<!doctype html><html lang=en class="js csstransforms3d"><head><meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI"><meta charset=utf-8><meta name=color-scheme content="dark light"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=description content="Secrets Management with HashiCorp Vault"><meta name=author content="Toni Schmidbauer & Thomas Jungbauer"><meta name=keywords content="OCP,Day-2,OpenShift,Vault,Secrets"><link rel=canonical href=https://blog.stderr.at/openshift/2022-08-16-hashicorp-vault/><link rel=icon href=/images/favicon.ico type=image/png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png><link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png><link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png><link rel="shortcut icon" href=/images/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><title>Secrets Management - Vault on OpenShift :: TechBlog about OpenShift/Ansible/Satellite and much more</title><link rel=manifest href=/manifest.json><meta name=theme-color content="#317EFB"><link href=/css/nucleus.min.css?1690740154 rel=stylesheet><link href=/css/fontawesome-all.min.css?1690740154 rel=stylesheet><link href=/css/font-awesome-animation.min.css?1690740154 rel=stylesheet><link href=/css/hybrid.css?1690740154 rel=stylesheet><link href=/css/featherlight.min.css?1690740154 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1690740154 rel=stylesheet><link href=/css/auto-complete.css?1690740154 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1690740154 rel=stylesheet><link href=/css/theme.min.css?1690740154 rel=stylesheet><link href=/css/hugo-theme.css?1690740154 rel=stylesheet><link href=/css/theme-yaub.css?1690740154 rel=stylesheet><script src=/js/jquery-3.6.0.min.js?1690740154></script>
<script src=/js/jquery.waypoints.min.js?1690740154></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/openshift/2022-08-16-hashicorp-vault/><button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<span class=read-progress></span><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class="fa fa-cloud-upload-alt faa-float animated"></p><span class=text>YAUB</span><p class=logoarea><span class="text small">Yet another Useless Blog</span></p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1690740154></script>
<script type=text/javascript src=/js/auto-complete.js?1690740154></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script><script type=text/javascript src=/js/search.js?1690740154></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/openshift/ title=OpenShift class="dd-item
parent"><a href=/openshift/>OpenShift</a><ul><li data-nav-id=/openshift/2023-03-20-operator-installation-with-argocd/ title="Operator installation with Argo CD" class=dd-item><a href=/openshift/2023-03-20-operator-installation-with-argocd/>Operator installation with Argo CD</a></li><li data-nav-id=/openshift/2023-16-02-ssl-certificate-management/ title="SSL Certificate Management for OpenShift on AWS" class=dd-item><a href=/openshift/2023-16-02-ssl-certificate-management/>SSL Certificate Management for OpenShift on AWS</a></li><li data-nav-id=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD" class=dd-item><a href=/openshift/2022-11-04-argocd-and-serversideapply/>Using ServerSideApply with ArgoCD</a></li><li data-nav-id=/openshift/2022-08-16-hashicorp-vault/ title="Secrets Management - Vault on OpenShift" class="dd-item active"><a href=/openshift/2022-08-16-hashicorp-vault/>Secrets Management - Vault on OpenShift</a></li><li data-nav-id=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" class=dd-item><a href=/openshift/2022-04-22-multi-cloud-gateway/>Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></li><li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item><a href=/openshift/2021-09-25-sealed_secrets/>Secure your secrets with Sealed Secrets</a></li><li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item><a href=/openshift/2021-02-27-understanding-block-devices/>Understanding RWO block device handling in OpenShift</a></li><li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item><a href=/openshift/2021-01-27-writingoperatoransible/>Writing Operator using Ansible</a></li><li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item><a href=/openshift/2020-12-10-thanos-vs-thanos/>Thanos Querier vs Thanos Querier</a></li><li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item><a href=/openshift/2020-08-06-argocd/>GitOps - Argo CD</a></li><li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item><a href=/openshift/2020-04-16-tekton/>OpenShift Pipelines - Tekton Introduction</a></li><li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item><a href=/openshift/2020-04-01-oc-commands/>Helpful oc / kubectl commands</a></li></ul></li><li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item><a href=/day-2/>OpenShift Day-2</a><ul><li data-nav-id=/day-2/etcd/ title=etcd class=dd-item><a href=/day-2/etcd/>etcd</a><ul><li data-nav-id=/day-2/etcd/2022-01-29-automatedetcdbackup/ title="Automated ETCD Backup" class=dd-item><a href=/day-2/etcd/2022-01-29-automatedetcdbackup/>Automated ETCD Backup</a></li></ul></li><li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item><a href=/day-2/labels_environmets/>Labels & Environments</a><ul><li data-nav-id=/day-2/labels_environmets/2022-01-12-creatingenvironment/ title="Working with Environments" class=dd-item><a href=/day-2/labels_environmets/2022-01-12-creatingenvironment/>Working with Environments</a></li></ul></li><li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item><a href=/day-2/pod-placement/>Pod Placement</a><ul><li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item><a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>Introduction</a></li><li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-29-node-affinity/>Node Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item><a href=/day-2/pod-placement/2021-08-27-podplacement/>NodeSelector</a></li><li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item><a href=/day-2/pod-placement/2021-08-28-affinity/>Pod Affinity/Anti-Affinity</a></li><li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item><a href=/day-2/pod-placement/2021-08-30-taints/>Taints and Tolerations</a></li><li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item><a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>Topology Spread Constraints</a></li><li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item><a href=/day-2/pod-placement/2021-09-01-descheduler/>Using Descheduler</a></li></ul></li></ul></li><li data-nav-id=/securesupplychain/ title="Secure Supply Chain" class=dd-item><a href=/securesupplychain/>Secure Supply Chain</a><ul><li data-nav-id=/securesupplychain/2023-06-15-securesupplychain-intro/ title="Introduction to a Secure Supply Chain" class=dd-item><a href=/securesupplychain/2023-06-15-securesupplychain-intro/>Introduction to a Secure Supply Chain</a></li><li data-nav-id=/securesupplychain/2023-06-16-securesupplychain-step1/ title="Step 1 - Listen to Events" class=dd-item><a href=/securesupplychain/2023-06-16-securesupplychain-step1/>Step 1 - Listen to Events</a></li><li data-nav-id=/securesupplychain/2023-06-17-securesupplychain-step2/ title="Step 2 - Pipelines" class=dd-item><a href=/securesupplychain/2023-06-17-securesupplychain-step2/>Step 2 - Pipelines</a></li><li data-nav-id=/securesupplychain/2023-06-18-securesupplychain-step3/ title="Step 3 - SonarQube" class=dd-item><a href=/securesupplychain/2023-06-18-securesupplychain-step3/>Step 3 - SonarQube</a></li><li data-nav-id=/securesupplychain/2023-06-19-securesupplychain-step4/ title="Step 4 - Verify Git Commit" class=dd-item><a href=/securesupplychain/2023-06-19-securesupplychain-step4/>Step 4 - Verify Git Commit</a></li><li data-nav-id=/securesupplychain/2023-06-20-securesupplychain-step5/ title="Step 5 - Build and Sign Image" class=dd-item><a href=/securesupplychain/2023-06-20-securesupplychain-step5/>Step 5 - Build and Sign Image</a></li><li data-nav-id=/securesupplychain/2023-06-21-securesupplychain-step6/ title="Step 6 - Scanning with ACS" class=dd-item><a href=/securesupplychain/2023-06-21-securesupplychain-step6/>Step 6 - Scanning with ACS</a></li><li data-nav-id=/securesupplychain/2023-06-22-securesupplychain-step7/ title="Step 7 - Generating a SBOM" class=dd-item><a href=/securesupplychain/2023-06-22-securesupplychain-step7/>Step 7 - Generating a SBOM</a></li><li data-nav-id=/securesupplychain/2023-06-23-securesupplychain-step8/ title="Step 8 - Updating Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-23-securesupplychain-step8/>Step 8 - Updating Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-24-securesupplychain-step9/ title="Step 9 - Linting Kubernetes Manifests" class=dd-item><a href=/securesupplychain/2023-06-24-securesupplychain-step9/>Step 9 - Linting Kubernetes Manifests</a></li><li data-nav-id=/securesupplychain/2023-06-25-securesupplychain-step10/ title="Step 10 - The Example Application" class=dd-item><a href=/securesupplychain/2023-06-25-securesupplychain-step10/>Step 10 - The Example Application</a></li><li data-nav-id=/securesupplychain/2023-06-26-securesupplychain-step11/ title="Step 11 - ACS Deployment Check" class=dd-item><a href=/securesupplychain/2023-06-26-securesupplychain-step11/>Step 11 - ACS Deployment Check</a></li><li data-nav-id=/securesupplychain/2023-06-27-securesupplychain-step12/ title="Step 12 - Verify TLog Signature" class=dd-item><a href=/securesupplychain/2023-06-27-securesupplychain-step12/>Step 12 - Verify TLog Signature</a></li><li data-nav-id=/securesupplychain/2023-06-28-securesupplychain-step13/ title="Step 13 - Bring it to Production" class=dd-item><a href=/securesupplychain/2023-06-28-securesupplychain-step13/>Step 13 - Bring it to Production</a></li></ul></li><li data-nav-id=/compliance/ title=Compliance class=dd-item><a href=/compliance/>Compliance</a><ul><li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item><a href=/compliance/2021/07/oc-compliance-command-line-plugin/>oc compliance command line plugin</a></li><li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item><a href=/compliance/2021/07/compliance-operator/>Compliance Operator</a></li></ul></li><li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item><a href=/service-mesh/>Service Mesh</a><ul><li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item><a href=/service-mesh/2020/05/enable-automatic-route-creation/>Enable Automatic Route Creation</a></li><li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item><a href=/service-mesh/2020/05/authorization-rbac/>Authorization (RBAC)</a></li><li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item><a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>Deploy Example Bookinfo Application</a></li><li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item><a href=/service-mesh/2020/04/service-mesh-1.1-released/>Service Mesh 1.1 released</a></li><li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item><a href=/service-mesh/2020/04/authentication-jwt/>Authentication JWT</a></li><li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item><a href=/service-mesh/2020/04/mutual-tls-authentication/>Mutual TLS Authentication</a></li><li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item><a href=/service-mesh/2020/04/fault-injection/>Fault Injection</a></li><li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item><a href=/service-mesh/2020/04/limit-egress/external-traffic/>Limit Egress/External Traffic</a></li><li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item><a href=/service-mesh/2020/04/advanced-routing-example/>Advanced Routing Example</a></li><li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item><a href=/service-mesh/2020/04/routing-example/>Routing Example</a></li><li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item><a href=/service-mesh/2020/03/ingress-with-custom-domain/>Ingress with custom domain</a></li><li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item><a href=/service-mesh/2020/03/ingress-traffic/>Ingress Traffic</a></li><li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item><a href=/service-mesh/2020/03/deploy-microservices/>Deploy Microservices</a></li><li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item><a href=/service-mesh/2020/03/installation/>Installation</a></li></ul></li><li data-nav-id=/general/ title=General class=dd-item><a href=/general/>General</a><ul><li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item><a href=/general/2020/05/basic-usage-of-git/>Basic usage of git</a></li><li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item><a href=/general/2020/04/red-hat-satellite-cheat-sheet/>Red Hat Satellite Cheat Sheet</a></li></ul></li><li data-nav-id=/ansible/ title=Ansible class=dd-item><a href=/ansible/>Ansible</a><ul><li data-nav-id=/ansible/2021/11/ansible-style-guide/ title="Ansible Style Guide" class=dd-item><a href=/ansible/2021/11/ansible-style-guide/>Ansible Style Guide</a></li><li data-nav-id=/ansible/2021/10/automation-controller-and-ldap-authentication/ title="Automation Controller and LDAP Authentication" class=dd-item><a href=/ansible/2021/10/automation-controller-and-ldap-authentication/>Automation Controller and LDAP Authentication</a></li><li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item><a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>Ansible Tower and downloading collections</a></li><li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item><a href=/ansible/2020/04/ansible-azure-resource-manager-example/>Ansible - Azure Resource Manager Example</a></li><li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item><a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>DO410 Ansible and Ansible Tower training notes</a></li></ul></li><li data-nav-id=/acs/ title="Advanced Cluster Security" class=dd-item><a href=/acs/>Advanced Cluster Security</a><ul><li data-nav-id=/acs/2021-12-11-acsauth/ title="Advanced Cluster Security - Authentication" class=dd-item><a href=/acs/2021-12-11-acsauth/>Advanced Cluster Security - Authentication</a></li></ul></li><li data-nav-id=/azure/ title=Azure class=dd-item><a href=/azure/>Azure</a><ul><li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item><a href=/azure/2021-10-29-private-aro/>Stumbling into Azure Part II: Setting up a private ARO cluster</a></li><li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class=dd-item><a href=/azure/2021-10-17-s2s-vpn/>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing</a></li></ul></li><li data-nav-id=/java/ title=Java class=dd-item><a href=/java/>Java</a><ul><li data-nav-id=/java/2022-02-25-jpa-disconnected-entity/ title="Adventures in Java Land: JPA disconnected entities" class=dd-item><a href=/java/2022-02-25-jpa-disconnected-entity/>Adventures in Java Land: JPA disconnected entities</a></li></ul></li><li data-nav-id=/quay/ title=Quay class=dd-item><a href=/quay/>Quay</a><ul><li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item><a href=/quay/2021-09-07-quay-upgrade-3.4/>Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator</a></li><li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item><a href=/quay/2020-05-13-quay-tutorial1/>Red Hat Quay Registry - Overview and Installation</a></li></ul></li><li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item><a href=/legaldisclosure/>Legal Disclosure</a></li><li data-nav-id=/rss/ title="RSS Feeds" class=dd-item><a href=/rss/>RSS Feeds</a></li></ul><section id=shortcuts><h3 class=shortcut-title>More</h3><ul><li><a class=padding href=https://blog.stderr.at/tags><i class='fas fa-tags'></i> Tags</a></li><li><a class=padding href=https://blog.stderr.at/categories><i class='far fa-bookmark'></i> Catagories</a></li><li><a class=padding href=https://blog.stderr.at/archive><i class='fas fa-box'></i> Archive</a></li><li><a class=padding href=https://charts.stderr.at/><i class='fas fa-book'></i> Helm Charts</a></li><li><a class=padding href=https://www.redhat.com><i class='fab fa-redhat'></i> Red Hat</a></li></ul></section><section id=footer></section></div></nav><section id=body class=post-content><div id=overlay></div><aside id=toc-field class="hidden lg:block tableOfContentContainer"><header id=TableOfContentsHeader>What's on this Page</header><nav id=TableOfContents><ul><li><a href=#_hashicorp_vault>HashiCorp Vault</a></li><li><a href=#_installing_vault>Installing Vault</a></li><li><a href=#_raft_storage>Raft Storage</a></li><li><a href=#_initialize_and_unseal_vault>Initialize and Unseal Vault</a></li><li><a href=#_verify_vault_cluster>Verify Vault Cluster</a></li><li><a href=#_configure_kubernetes_authentication>Configure Kubernetes Authentication</a></li><li><a href=#_configure_a_secret>Configure a Secret</a></li><li><a href=#_configuring_policies>Configuring policies</a></li><li><a href=#_lets_start_an_application>Let’s start an Application</a></li><li><a href=#_tip_using_vault_cli_on_your_local_environment>TIP: Using vault CLI on your local environment</a></li><li><a href=#_thanks>Thanks</a></li></ul></nav><div id=navigation><a class=nav-prev href=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD"><i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></aside><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/><span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span>> <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/openshift/><span itemprop=name>OpenShift</span><meta itemprop=position content="2"></a></span>> Secrets Management - Vault on OpenShift</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#_hashicorp_vault>HashiCorp Vault</a></li><li><a href=#_installing_vault>Installing Vault</a></li><li><a href=#_raft_storage>Raft Storage</a></li><li><a href=#_initialize_and_unseal_vault>Initialize and Unseal Vault</a></li><li><a href=#_verify_vault_cluster>Verify Vault Cluster</a></li><li><a href=#_configure_kubernetes_authentication>Configure Kubernetes Authentication</a></li><li><a href=#_configure_a_secret>Configure a Secret</a></li><li><a href=#_configuring_policies>Configuring policies</a></li><li><a href=#_lets_start_an_application>Let’s start an Application</a></li><li><a href=#_tip_using_vault_cli_on_your_local_environment>TIP: Using vault CLI on your local environment</a></li><li><a href=#_thanks>Thanks</a></li></ul></nav></div></div><div class=social><a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f" class="facebook no-highlight" aria-label="share on Facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-facebook" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a href="https://twitter.com/intent/tweet?hashtags=codingnconcepts&url=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f&text=Secrets%20Management%20-%20Vault%20on%20OpenShift" class="twitter no-highlight" aria-label="share on Twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg></div></div></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f&source=https%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f&title=Secrets%20Management%20-%20Vault%20on%20OpenShift&summary=Secrets%20Management%20-%20Vault%20on%20OpenShift" class="linkedin no-highlight" aria-label="share on Linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg></div></div></a><a href="whatsapp://send?text=Secrets%20Management%20-%20Vault%20on%20OpenShift%2c%20by%20TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more%0aSecrets%20Management%20with%20HashiCorp%20Vault%0a%0ahttps%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f%0a" class="whatsapp no-highlight" aria-label="share on Whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-whatsapp" width="24" height="24" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a href="mailto:?subject=TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more - Secrets%20Management%20-%20Vault%20on%20OpenShift.&body=Secrets%20Management%20-%20Vault%20on%20OpenShift%2c%20by%20TechBlog%20about%20OpenShift%2fAnsible%2fSatellite%20and%20much%20more%0aSecrets%20Management%20with%20HashiCorp%20Vault%0a%0ahttps%3a%2f%2fblog.stderr.at%2fopenshift%2f2022-08-16-hashicorp-vault%2f%0a" class="email no-highlight" aria-label="share on Email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg class="icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg></div></div></a></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/ocp>OCP</a>
<a class=tag-link href=/tags/day-2>Day-2</a>
<a class=tag-link href=/tags/openshift>OpenShift</a>
<a class=tag-link href=/tags/vault>Vault</a>
<a class=tag-link href=/tags/secrets>Secrets</a></div></div><div id=body-inner><h1>Secrets Management - Vault on OpenShift</h1><p class=tracked><time class="f6 mv4 dib tracked" datetime=2022-08-16T00:00:00Z><strong>August 16, 2022</strong></time>
- By:
Thomas Jungbauer
( Lastmod: 2022-09-02 ) - <span class=readtime><strong>10 min read</strong></span></p><div class=paragraph><p>Sensitive information in OpenShift or Kubernetes is stored as a so-called Secret. The management of these Secrets is one of the most important questions,
when it comes to OpenShift. Secrets in Kubernetes are encoded in base64. This is <strong>not</strong> an encryption format.
Even if etcd is encrypted at rest, everybody can decode a given base64 string which is stored in the Secret.</p></div><div class=paragraph><p>For example: The string <code>Thomas</code> encoded as base64 is <code>VGhvbWFzCg==</code>. This is simply a masked plain text and it is not secure to share these values, especially not on Git.
To make your CI/CD pipelines or Gitops process secure, you need to think of a secure way to manage your Secrets. Thus, your Secret objects must be encrypted somehow. HashiCorp Vault is one option to achieve this requirement.</p></div><div class=sect1><h2 id=_hashicorp_vault>HashiCorp Vault</h2><div class=sectionbody><div class=paragraph><p>HashiCorp Vault is a solution to solve our Secret management problem. It stores and encrypts our sensitive information at rest and in transit and enables you to create fine grained access
controls (ACL). This defines who has access to a specific secret. Application A should only get access to secret A and so on. However, that is just the tip of the iceberg. Vault can do much more.
If you are interested in further details, check out the introduction video by Armon, the Co-Founder of Hashicorp Vault at: <a href="https://learn.hashicorp.com/tutorials/vault/getting-started-intro?in=vault/getting-started" class=bare>https://learn.hashicorp.com/tutorials/vault/getting-started-intro?in=vault/getting-started</a></p></div><div class=paragraph><p>For this article we will keep it simple and cover:</p></div><div class=ulist><ul><li><p>Installing HashiCorp Vault to OpenShift</p></li><li><p>Integrating the plugin "Kubernetes Authentication" to access the Secrets</p></li><li><p>Accessing a static secret stored in HashiCorp Vault by an example application</p></li></ul></div></div></div><div class=sect1><h2 id=_installing_vault>Installing Vault</h2><div class=sectionbody><div class=paragraph><p>The easiest way to install Vault is by using the supported Helm chart.</p></div><div class=paragraph><p>Add the Helm repository to your repo:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>helm repo add hashicorp https://helm.releases.hashicorp.com</code></pre></div></div><div class=paragraph><p>Update the repository to get the latest updates.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>helm repo update</code></pre></div></div><div class=paragraph><p>Before we install Vault, we need to create a values file to set certain variables. Let’s create a file called "overwrite-values.yaml" with the following content</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>global:
  openshift: true

server:
  ha:
    enabled: true
    replicas: 3
    raft:
      enabled: true</code></pre></div></div><div class=paragraph><p>This will tell HashiCorp Vault the environment we are going to install is (OpenShift), enables high availability with 3 replicas and enables RAFT (see below for some introduction).</p></div><div class=paragraph><p>Finally, let us deploy HashiCorp Vault into the namespace <strong>vault</strong> using the values file we have created in the previous step:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>helm upgrade --install vault hashicorp/vault --values bootstrap/vault/overwrite-values.yaml --namespace=vault --create-namespace</code></pre></div></div><div class=paragraph><p>This will start the agent-injector and 3 vault-pods:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc get pods -n vault

NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 0/1     Running   0          36s
vault-1                                 0/1     Running   0          36s
vault-2                                 0/1     Running   0          36s
vault-agent-injector-74c848f67b-sq4dq   1/1     Running   0          37s</code></pre></div></div><div class=ulist><ul><li><p>vault agent injector: detecting applications with annotations that require vault agent which will get injected</p></li><li><p>vault-0: vault server</p></li></ul></div><div class=paragraph><p>The vault servers remain in <strong>not-ready</strong> state until Vault has been unsealed by you.</p></div><div class=paragraph><p>When you check the logs of one of the pods you will see:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc logs vault-0 -n vault
...
2022-08-11T12:31:22.497Z [INFO]  core: security barrier not initialized
2022-08-11T12:31:22.497Z [INFO]  core: seal configuration missing, not initialized</code></pre></div></div><div class=paragraph><p>Vault always starts uninitialized and sealed, to protect the secrets. You need to give at least three different unseal-keys in order to be able to use Vault.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Vault’s seal mechanism uses <a href=https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing target=_blank rel=noopener>Shamir’s secret sharing</a>. This is a manual process to secure the cluster if it restarts. You can use auto-unseal for specific cloud providers to bypass the manual requirement.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_raft_storage>Raft Storage</h2><div class=sectionbody><div class=paragraph><p>During the deployment we have enabled Raft which is the integrated HA storage for Vault. Vault can use several different styles of storage backends, but when it comes to HA and Kubernetes, Raft is
easiest one since it has no other dependencies, and it is well known inside OpenShift. Etcd is using Raft as well. It is a distributed Consensus Algorithm where multiple members form a cluster and elect one leader. The leader has the responsibility to replicate everything to the followers. Since this leader election requires a majority an odd number of cluster members must be available to ensure there is a minimum number left if a member is failing.</p></div></div></div><div class=sect1><h2 id=_initialize_and_unseal_vault>Initialize and Unseal Vault</h2><div class=sectionbody><div class=paragraph><p>As mentioned, the Vault Pods are not fully available yet, since Vault it currently sealed and cannot be used. The first thing to do is to initialize and unseal it.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>The following commands will login into one Pod and execute commands from there.</td></tr></tbody></table></div><div class=paragraph><p>Let’s get the status of our Vault fist:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n vault exec -it vault-0 -- vault operator init -status</code></pre></div></div><div class=paragraph><p>This will return the message:
<code>Vault is not initialized</code></p></div><div class=paragraph><p>The following command will initialize Vault for further usage:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc exec -ti -n vault vault-0 -- vault operator init -format=json &gt; unseal.json</code></pre></div></div><div class=paragraph><p>This will create the file <strong>unseal.json</strong> locally on your machine. <strong>Keep this file secure</strong> It contains by default 5 key shards and the root token you will need to unseal Vault and authenticate as root.</p></div><div class="admonitionblock caution"><table><tbody><tr><td class=icon><i class="fa icon-caution" title=Caution></i></td><td class=content>Keep this file secure, it contains keys to unseal Vault and the root_token to authenticate against.</td></tr></tbody></table></div><div class=paragraph><p>Never share this file. It will look like this:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-json data-lang=json>{
  &#34;unseal_keys_b64&#34;: [
    &#34;key_1&#34;,
    &#34;key_2&#34;,
    &#34;key_3&#34;,
    &#34;key_4&#34;,
    &#34;key_5&#34;
  ],
  &#34;unseal_keys_hex&#34;: [
    &#34;key_hex_1&#34;,
    &#34;key_hex_2&#34;,
    &#34;key_hex_3&#34;,
    &#34;key_hex_4&#34;,
    &#34;key_hex_5&#34;
  ],
  &#34;unseal_shares&#34;: 5,
  &#34;unseal_threshold&#34;: 3,
  &#34;recovery_keys_b64&#34;: [],
  &#34;recovery_keys_hex&#34;: [],
  &#34;recovery_keys_shares&#34;: 5,
  &#34;recovery_keys_threshold&#34;: 3,
  &#34;root_token&#34;: &#34;root.token&#34;
}</code></pre></div></div><div class=paragraph><p>With the initialization in place Vault is put into a sealed mode. This means Vault cannot decrypt secrets at this moment.
To unseal Vault you need the unseal key, which is split into multiple shards using <a href=https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing target=_blank rel=noopener>Shamir’s secret sharing</a>. A certain number of individual shards (default 3) must be provided to reconstruct the unseal key.</p></div><div class=paragraph><p>To unseal Vault lets login to our Pod "vault-0" and unseal it. Use the following command and provide one of the keys:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc exec -ti -n vault vault-0 -- vault operator unseal

Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Initialized        true <i class=conum data-value=1></i><b>(1)</b>
Sealed             true <i class=conum data-value=2></i><b>(2)</b>
Total Shares       5
Threshold          3
Unseal Progress    1/3 <i class=conum data-value=3></i><b>(3)</b>
Unseal Nonce       08b01535-be15-e865-251c-f948ed0661c9
Version            1.11.2
Build Date         2022-07-29T09:48:47Z
Storage Type       raft
HA Enabled         true</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Vault is initialized</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Vault is still sealed</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>The unseal progress: Currently 1 out of 3 keys have been provided</td></tr></tbody></table></div><div class=paragraph><p>Use the same command another 2 times using <strong>different</strong> keys to complete the unseal process:</p></div><div class=paragraph><p>At the end the following output should be shown:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>Unseal Key (will be hidden):
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false <i class=conum data-value=1></i><b>(1)</b>
Total Shares            5
Threshold               3
Version                 1.11.2
Build Date              2022-07-29T09:48:47Z
Storage Type            raft
Cluster Name            vault-cluster-f7402e5b <i class=conum data-value=2></i><b>(2)</b>
Cluster ID              aff648f0-b3a2-1fdd-12f6-492842b08b2b
HA Enabled              true
HA Cluster              https://vault-0.vault-internal:8201
HA Mode                 active <i class=conum data-value=3></i><b>(3)</b>
Active Since            2022-08-16T07:20:45.828215961Z
Raft Committed Index    36
Raft Applied Index      36</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Vault is now unsealed</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Name of our cluster</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>High availability is enabled</td></tr></tbody></table></div><div class=paragraph><p><strong>Vault-0</strong> is now initialized, but there are 2 other members in our HA cluster which must be added.
Let <strong>vault-1</strong> and <strong>vault-2</strong> join the cluster and perform the same unseal process as previously: use 3 different keys:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc exec -ti vault-1 -n vault -- vault operator raft join http://vault-0.vault-internal:8200

# 3 times....
oc exec -ti vault-1 -n vault -- vault operator unseal

oc exec -ti vault-2 -n vault -- vault operator raft join http://vault-0.vault-internal:8200

# 3 times...
oc exec -ti vault-2 -n vault -- vault operator unseal</code></pre></div></div></div></div><div class=sect1><h2 id=_verify_vault_cluster>Verify Vault Cluster</h2><div class=sectionbody><div class=paragraph><p>To verify if the Raft cluster has successfully been initialized, run the following.</p></div><div class=paragraph><p>First, login using the <strong>root_token</strong>, that was created above, on the vault-0 pod.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc exec -ti vault-0 -n vault -- vault login

Token (will be hidden): &lt;root_token&gt;</code></pre></div></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc exec -ti vault-0 -n vault -- vault operator raft list-peers</code></pre></div></div><div class=paragraph><p>This should return:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>Node                                    Address                        State       Voter
----                                    -------                        -----       -----
16ec7490-f621-42ea-976d-5f054cfaeecc    vault-0.vault-internal:8201    leader      true
60ba2885-432a-c7d3-d280-a824f0acce42    vault-1.vault-internal:8201    follower    true
bcc4f551-79bc-47e5-d01b-97fc12d1afa5    vault-2.vault-internal:8201    follower    true</code></pre></div></div><div class=paragraph><p>As you can see Vault-0 is the leader while the other two members are followers.</p></div></div></div><div class=sect1><h2 id=_configure_kubernetes_authentication>Configure Kubernetes Authentication</h2><div class=sectionbody><div class=paragraph><p>There are multiple ways how an application can interact with Vault. One example is to use Tokens. This is quite easy but has the disadvantage that it does require additional steps of managing the life cycle of such token, moreover they might be shared, which is not what we want.</p></div><div class=paragraph><p>HashiCorp Vault supports different authentication methods. One of which is the <strong>Kubernetes Auth Method</strong> that must be enabled before we can use.
The Kubernetes Auth Method makes use of Jason Web Tokens (JWT)s that are bound to a Service Account. When we tell Vault that a Service Account is fine to authenticate, then a Deployment using this account is able to authenticate and
request Secrets.</p></div><div class=paragraph><p>Vault has a plugin ecosystem, which allows to enable certain plugins. To enable <strong>Kubernetes Auth Method</strong> use the following process:</p></div><div class="olist arabic"><ol class=arabic><li><p>Login vault-0 pods
<code>oc exec -it vault-0 -n vault — /bin/sh</code></p></li><li><p>execute the command:
<code>vault auth enable kubernetes</code> which returns:
<em>Success! Enabled kubernetes auth method at: kubernetes/</em></p></li><li><p>Set up the Kubernetes configuration to use Vault’s service account JWT.</p></li></ol></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>the address to the OpenShift API (KUBERNETES_PORT_443_TCP_ADDR) is automatically available via an environment variable.</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>vault write auth/kubernetes/config issuer=&#34;&#34; \
 	token_reviewer_jwt=&#34;$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&#34; \
 	kubernetes_host=&#34;https://$KUBERNETES_PORT_443_TCP_ADDR:443&#34; \
 	kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

Success! Data written to: auth/kubernetes/config</code></pre></div></div><div class=paragraph><p>With this step authentication against OpenShift is enabled.</p></div></div></div><div class=sect1><h2 id=_configure_a_secret>Configure a Secret</h2><div class=sectionbody><div class=paragraph><p>With the Kubernetes Auth Method in place we can configure a secret to test our setup. We will use an example application called <strong>expenses</strong> that has a MySQL database.
The static password to bootstrap this database shall be stored in Vault. A plugin called <strong>key-value secrets</strong> engine will be used to achieve this.</p></div><div class=paragraph><p>There are other plugins that are specifically designed to automatically rotate secrets. For example, it is possible to dynamically create user credentials für MySQL.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>You can list available engines by using the command: <code>oc -n vault exec -it vault-0 — vault secrets list</code></td></tr></tbody></table></div><div class=paragraph><p>There are currently two versions of this key/value engine:</p></div><div class=ulist><ul><li><p>KV Version 1: does not versionize the key/values, thus updates will overwrite the old values.</p></li><li><p>KV Version 2: does versionize the key/value pairs</p></li></ul></div><div class=paragraph><p>In our example we will use version 2.</p></div><div class=paragraph><p>Like the authentication method, we need to enable the secrets engine:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n vault exec -it vault-0 -- vault secrets enable \
  -path=expense/static \ <i class=conum data-value=1></i><b>(1)</b>
  -version=2 \ <i class=conum data-value=2></i><b>(2)</b>
  kv <i class=conum data-value=3></i><b>(3)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>API path where our secrets are stored</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Version 2</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>name of our engine</td></tr></tbody></table></div><div class=paragraph><p>You can list the enabled engines with the following command:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n vault exec -it vault-0 -- vault secrets list

Path                Type         Accessor              Description
----                ----         --------              -----------
cubbyhole/          cubbyhole    cubbyhole_f1e955f9    per-token private secret storage
expense/static/    kv           kv_6db09e5d           n/a
identity/           identity     identity_ca05e6ab     identity store <i class=conum data-value=1></i><b>(1)</b>
sys/                system       system_e34a76c3       system endpoints used for control, policy and debugging</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Enabled KV secrets engine using the path <strong>expense/static/</strong></td></tr></tbody></table></div><div class=paragraph><p>Now lets put a secret into our store. We will store our super-secure MySQL password into <strong>expense/static/mysql</strong></p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>MYSQL_DB_PASSWORD=mysuperpassword$

oc -n vault exec -it vault-0 -- vault kv put expense/static/mysql db_login_password=${MYSQL_DB_PASSWORD}</code></pre></div></div><div class=paragraph><p>This command will store the key <strong>db_login_password</strong> with the database as value. We can get the secret by calling:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n vault exec -it vault-0 -- vault kv get expense/static/mysql

====== Secret Path ======
expense/static/data/mysql <i class=conum data-value=1></i><b>(1)</b>

======= Metadata =======
Key                Value
---                -----
created_time       2022-08-17T06:08:05.839663508Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            1

========== Data ==========
Key                  Value
---                  -----
db_login_password    mysuperpassword$ <i class=conum data-value=2></i><b>(2)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>The data path of our secret</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>our password</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_configuring_policies>Configuring policies</h2><div class=sectionbody><div class=paragraph><p>The Secret is now stored at <strong>expense/static/mysql</strong> but there is no policy in place. Everybody who is authenticated and is calling this path will get to see the secrets.
Luckily, one or more policies can be assigned to the authentication method. A policy defines capabilities that allow you to perform certain actions.</p></div><div class=paragraph><p>The following capabilities are known:</p></div><div class=ulist><ul><li><p><strong>create</strong> - to create new data</p></li><li><p><strong>read</strong> - to read data</p></li><li><p><strong>delete</strong> - to delete data</p></li><li><p><strong>list</strong> - to list data</p></li></ul></div><div class=paragraph><p>Policies can be written either in JSON or HCL (HashiCorp Configuration Language). Let’s create a file with the following content:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-json data-lang=json>path &#34;expense/static/data/mysql&#34; {
  capabilities = [&#34;read&#34;, &#34;list&#34;]
}</code></pre></div></div><div class="admonitionblock caution"><table><tbody><tr><td class=icon><i class="fa icon-caution" title=Caution></i></td><td class=content>KV Version2 stores the secrets in a path with the prefix <code>data/</code></td></tr></tbody></table></div><div class=paragraph><p>This will limit my access to <strong>read</strong> and <strong>list</strong> only.</p></div><div class=paragraph><p>Write the policy:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>cat my-policy.hcl | oc -n vault exec -it vault-0 -- vault policy write expense-db-mysql -</code></pre></div></div><div class=paragraph><p>Next, we are going to bind the Vault secret to a service account and a namespace. Both objects will be created later, when we deploy the application.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n vault exec -it vault-0 -- vault write auth/kubernetes/role/expense-db-mysql \ <i class=conum data-value=1></i><b>(1)</b>
bound_service_account_names=expense-db-mysql \ <i class=conum data-value=2></i><b>(2)</b>
bound_service_account_namespaces=expenses \ <i class=conum data-value=3></i><b>(3)</b>
policies=expense-db-mysql \ <i class=conum data-value=4></i><b>(4)</b>
ttl=1h <i class=conum data-value=5></i><b>(5)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Path or our new role</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Name of the service account we will create and that will be used by the application</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Name of the namespace we will create</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>Name of the policy we created earlier</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>The token is valid for 1 hour, after this period the service account must re-authenticate</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_lets_start_an_application>Let’s start an Application</h2><div class=sectionbody><div class=paragraph><p>Now we will create our MySQL application into the namespace <strong>expenses</strong>. Use the following command to create the namespace and the application containing the objects Deployment, ServiceAccount (expense-db-mysql) and Service.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>See at the <a href=https://raw.githubusercontent.com/joatmon08/vault-argocd/part-1/database/deployment.yaml target=_blank rel=noopener>Github Page</a> for a full yaml specification of the three objects.</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc new-project expenses

oc apply -f https://raw.githubusercontent.com/joatmon08/vault-argocd/part-1/database/deployment.yaml</code></pre></div></div><div class=paragraph><p>The deployment will start a Pod with a sidecar container <strong>vault-agent</strong>. This sidecar is automatically created and must not be defined inside the Deployment specification.
Instead, some annotations in the Deployment define what the container should be automatically injected and also where to find our secret:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>      annotations:
        vault.hashicorp.com/agent-inject: &#34;true&#34; <i class=conum data-value=1></i><b>(1)</b>
        vault.hashicorp.com/role: &#34;expense-db-mysql&#34; <i class=conum data-value=2></i><b>(2)</b>
        vault.hashicorp.com/agent-inject-secret-db: &#34;expense/static/data/mysql&#34; <i class=conum data-value=3></i><b>(3)</b>
        vault.hashicorp.com/agent-inject-template-db: | <i class=conum data-value=4></i><b>(4)</b>
          {{ with secret &#34;expense/static/data/mysql&#34; -}}
          export MYSQL_ROOT_PASSWORD=&#34;{{ .Data.data.db_login_password }}&#34;
          {{- end }}
    ...
    spec:
      serviceAccountName: expense-db-mysql <i class=conum data-value=5></i><b>(5)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Defines that the <strong>vault-agent</strong> side car container shall be automatically injected. This is the most important annotation.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Name of the role that was created created previously</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>The agent will inject the data from <strong>expense/static/data/mysql</strong> and stores it in a file <strong>db</strong> The file name is everything that comes after <strong>vault.hashicorp.com/agent-inject-secret-</strong></td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>Configuration…​ the template that defines how the secret will be rendered</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>The service account name we bound our secret to, using the Consul language. In this case the MySQL password is simply exported</td></tr></tbody></table></div><div class=paragraph><p>The vault-agent is requesting the database password from Vault and provides it to the application where it is stored at <code>/vault/secrets/db</code></p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc -n expenses exec -it $(oc get pods -l=app=expense-db-mysql -o jsonpath=&#39;{.items[0].metadata.name}&#39;) -c expense-db-mysql -- cat /vault/secrets/db

# output
export MYSQL_ROOT_PASSWORD=&#34;mysuperpassword$&#34;</code></pre></div></div><div class=paragraph><p>The Deployment sources this file when it starts and MySQL will take this information to configure itself.</p></div></div></div><div class=sect1><h2 id=_tip_using_vault_cli_on_your_local_environment>TIP: Using vault CLI on your local environment</h2><div class=sectionbody><div class=paragraph><p>All above commands that are dealing with Vault commands, first login to a pod and then execure the commands from there.</p></div><div class=paragraph><p>If you have the <a href=https://www.vaultproject.io/docs/install target=_blank rel=noopener>Vault CLI</a> installed on your local machine, you can open a port forwarding to your Vault cluster at OpenShift and execute the commands locally:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>oc port-forward -n vault svc/vault 8200

export VAULT_ADDR=http://localhost:8200

vault login
...</code></pre></div></div></div></div><div class=sect1><h2 id=_thanks>Thanks</h2><div class=sectionbody><div class=paragraph><p>Thanks to the wonderful Rosemary Wang and her Github repository: <a href=https://github.com/joatmon08/vault-argocd/tree/part-1 class=bare>https://github.com/joatmon08/vault-argocd/tree/part-1</a></p></div><div class=paragraph><p>Also check out the Youtube Video: <a href="https://www.youtube.com/watch?v=Bce_0qa6ias" target=_blank rel=noopener>GitOps Guide to the Galaxy (Ep 31) | GitOps With Vault Part 1</a> in which Rosemary and Christian discuss this setup</p></div></div></div><footer class=footline></footer></div></div><div id=navigation-bottom><a class="nav-prev btn btn-default" href=/openshift/2022-11-04-argocd-and-serversideapply/ title="Using ServerSideApply with ArgoCD"><i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous:</span> Using ServerSideApply with ArgoCD</a>
<a class="nav-next btn btn-default" href=/openshift/2022-04-22-multi-cloud-gateway/ title="Overview of Red Hat's Multi Cloud Gateway (Noobaa)" style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Overview of Red Hat's Multi Cloud Gateway (Noobaa)</a></div><div class=copyright><p>Copyright &copy; 2020 - 2023 Toni Schmidbauer & Thomas Jungbauer</p><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p></div></section><script>(function(){$("document").ready(function(){var s=$(".read-progress").waypoint({handler:function(e){e=="down"?($(".read-progress").addClass("position-fixed"),$(".read-progress").css("top",0)):($(".read-progress").removeClass("position-fixed"),$(".read-progress").css("top"))}}),t=$(window).height(),e=$(".post-content").height();$(window).on("scroll",n),$(window).on("resize",function(){t=$(window).height(),e=$(".post-content").height(),n()});function n(){var s=$(this).scrollTop(),o=$(".post-content").offset().top,i=e-(e-(t-(o-s))),n=i/e*100,n=n>100?100:n;$(".read-progress").width(n+"%")}})})()</script><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1690740159></script>
<script src=/js/perfect-scrollbar.min.js?1690740159></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1690740159></script>
<script src=/js/jquery.sticky.js?1690740159></script>
<script src=/js/featherlight.min.js?1690740159></script>
<script src=/js/highlight.pack.js?1690740159></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1690740159></script>
<script src=/js/learn.js?1690740159></script>
<script src=/js/hugo-learn.js?1690740159></script>
<script src=/js/yaub.js?1690740159></script>
<script>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${t}"]`).parentElement.classList.add("active"))})});document.querySelectorAll("h1[id],h2[id],h3[id]").forEach(t=>{e.observe(t)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll("aside nav li").forEach(e=>{e.classList.remove("active")})}</script><script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script><script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script></body></html>