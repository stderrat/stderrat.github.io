<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta name=google-site-verification content="yq2Ib3doJVHVlEW2wtHap5WY54JhS2CCvI40y30F0FI">
<meta charset=utf-8>
<meta name=color-scheme content="dark light">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.87.0">
<meta name=description content="TechBlog about OpenShift/Ansible/Satellite and much more">
<meta name=author content="Toni Schmidbauer & Thomas Jungbauer">
<link rel=icon href=/images/favicon.ico type=image/png>
<link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-180x180.png>
<link rel=apple-touch-icon sizes=128x128 href=/images/apple-touch-icon-128x128.png>
<link rel=apple-touch-icon sizes=144x144 href=/images/apple-touch-icon-144x144.png>
<link rel=apple-touch-icon sizes=114x114 href=/images/apple-touch-icon-114x114.png>
<link rel=apple-touch-icon sizes=72x72 href=/images/apple-touch-icon-72x72.png>
<link rel=apple-touch-icon href=/images/apple-touch-icon-57x57.png>
<link rel="shortcut icon" href=/images/favicon.ico>
<link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png>
<link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<title>Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing :: TechBlog about OpenShift/Ansible/Satellite and much more</title>
<link rel=manifest href=/manifest.json>
<meta name=theme-color content="#317EFB">
<link href=/css/nucleus.min.css?1637052715 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1637052715 rel=stylesheet>
<link href=/css/font-awesome-animation.min.css?1637052715 rel=stylesheet>
<link href=/css/hybrid.css?1637052715 rel=stylesheet>
<link href=/css/featherlight.min.css?1637052715 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1637052715 rel=stylesheet>
<link href=/css/auto-complete.css?1637052715 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1637052715 rel=stylesheet>
<link href=/css/theme.min.css?1637052715 rel=stylesheet>
<link href=/css/hugo-theme.css?1637052715 rel=stylesheet>
<link href=/css/theme-yaub.css?1637052715 rel=stylesheet>
<script src=/js/jquery-3.6.0.min.js?1637052715></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
</head>
<body data-url=/azure/2021-10-17-s2s-vpn/>
<button onclick=scrollTopAnimated() id=myBtn class="top-btn button fa fa-arrow-up" title="Go to top"></button>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/>
<p class="fa fa-cloud-upload-alt faa-float animated"></p>
<span class=text>YAUB</span>
<p class=logoarea><span class="text small">Yet another Useless Blog</span></p>
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1637052715></script>
<script type=text/javascript src=/js/auto-complete.js?1637052715></script>
<script type=text/javascript>var baseurl="https://blog.stderr.at/"</script>
<script type=text/javascript src=/js/search.js?1637052715></script>
</div>
<div class=togglemode>
<button id=dark-mode-toggle class="btn-toggle btn-default btn">Toggle Dark-Mode</button>
</div>
<section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Home</a>
</li>
</ul>
</section>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/openshift/ title=OpenShift class=dd-item>
<a href=/openshift/>
OpenShift
</a>
<ul>
<li data-nav-id=/openshift/2021-09-25-sealed_secrets/ title="Secure your secrets with Sealed Secrets" class=dd-item>
<a href=/openshift/2021-09-25-sealed_secrets/>
Secure your secrets with Sealed Secrets
</a>
</li>
<li data-nav-id=/openshift/2021-02-27-understanding-block-devices/ title="Understanding RWO block device handling in OpenShift" class=dd-item>
<a href=/openshift/2021-02-27-understanding-block-devices/>
Understanding RWO block device handling in OpenShift
</a>
</li>
<li data-nav-id=/openshift/2021-01-27-writingoperatoransible/ title="Writing Operator using Ansible" class=dd-item>
<a href=/openshift/2021-01-27-writingoperatoransible/>
Writing Operator using Ansible
</a>
</li>
<li data-nav-id=/openshift/2020-12-10-thanos-vs-thanos/ title="Thanos Querier vs Thanos Querier" class=dd-item>
<a href=/openshift/2020-12-10-thanos-vs-thanos/>
Thanos Querier vs Thanos Querier
</a>
</li>
<li data-nav-id=/openshift/2020-08-06-argocd/ title="GitOps - Argo CD" class=dd-item>
<a href=/openshift/2020-08-06-argocd/>
GitOps - Argo CD
</a>
</li>
<li data-nav-id=/openshift/2020-04-16-tekton/ title="OpenShift Pipelines - Tekton Introduction" class=dd-item>
<a href=/openshift/2020-04-16-tekton/>
OpenShift Pipelines - Tekton Introduction
</a>
</li>
<li data-nav-id=/openshift/2020-04-01-oc-commands/ title="Helpful oc / kubectl commands" class=dd-item>
<a href=/openshift/2020-04-01-oc-commands/>
Helpful oc / kubectl commands
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/ title="OpenShift Day-2" class=dd-item>
<a href=/day-2/>
OpenShift Day-2
</a>
<ul>
<li data-nav-id=/day-2/labels_environmets/ title="Labels & Environments" class=dd-item>
<a href=/day-2/labels_environmets/>
Labels & Environments
</a>
<ul>
<li data-nav-id=/day-2/labels_environmets/2021-11-12-creatingenvironment/ title="Working with Environments" class=dd-item>
<a href=/day-2/labels_environmets/2021-11-12-creatingenvironment/>
Working with Environments
</a>
</li>
</ul>
</li>
<li data-nav-id=/day-2/pod-placement/ title="Pod Placement" class=dd-item>
<a href=/day-2/pod-placement/>
Pod Placement
</a>
<ul>
<li data-nav-id=/day-2/pod-placement/2021-08-26-podplacement-intro/ title=Introduction class=dd-item>
<a href=/day-2/pod-placement/2021-08-26-podplacement-intro/>
Introduction
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-29-node-affinity/ title="Node Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-29-node-affinity/>
Node Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-27-podplacement/ title=NodeSelector class=dd-item>
<a href=/day-2/pod-placement/2021-08-27-podplacement/>
NodeSelector
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-28-affinity/ title="Pod Affinity/Anti-Affinity" class=dd-item>
<a href=/day-2/pod-placement/2021-08-28-affinity/>
Pod Affinity/Anti-Affinity
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-30-taints/ title="Taints and Tolerations" class=dd-item>
<a href=/day-2/pod-placement/2021-08-30-taints/>
Taints and Tolerations
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/ title="Topology Spread Constraints" class=dd-item>
<a href=/day-2/pod-placement/2021-08-31-topologyspreadcontraints/>
Topology Spread Constraints
</a>
</li>
<li data-nav-id=/day-2/pod-placement/2021-09-01-descheduler/ title="Using Descheduler" class=dd-item>
<a href=/day-2/pod-placement/2021-09-01-descheduler/>
Using Descheduler
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/compliance/ title=Compliance class=dd-item>
<a href=/compliance/>
Compliance
</a>
<ul>
<li data-nav-id=/compliance/2021/07/oc-compliance-command-line-plugin/ title="oc compliance command line plugin" class=dd-item>
<a href=/compliance/2021/07/oc-compliance-command-line-plugin/>
oc compliance command line plugin
</a>
</li>
<li data-nav-id=/compliance/2021/07/compliance-operator/ title="Compliance Operator" class=dd-item>
<a href=/compliance/2021/07/compliance-operator/>
Compliance Operator
</a>
</li>
</ul>
</li>
<li data-nav-id=/service-mesh/ title="Service Mesh" class=dd-item>
<a href=/service-mesh/>
Service Mesh
</a>
<ul>
<li data-nav-id=/service-mesh/2020/05/enable-automatic-route-creation/ title="Enable Automatic Route Creation" class=dd-item>
<a href=/service-mesh/2020/05/enable-automatic-route-creation/>
Enable Automatic Route Creation
</a>
</li>
<li data-nav-id=/service-mesh/2020/05/authorization-rbac/ title="Authorization (RBAC)" class=dd-item>
<a href=/service-mesh/2020/05/authorization-rbac/>
Authorization (RBAC)
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/deploy-example-bookinfo-application/ title="Deploy Example Bookinfo Application" class=dd-item>
<a href=/service-mesh/2020/04/deploy-example-bookinfo-application/>
Deploy Example Bookinfo Application
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/service-mesh-1.1-released/ title="Service Mesh 1.1 released" class=dd-item>
<a href=/service-mesh/2020/04/service-mesh-1.1-released/>
Service Mesh 1.1 released
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/authentication-jwt/ title="Authentication JWT" class=dd-item>
<a href=/service-mesh/2020/04/authentication-jwt/>
Authentication JWT
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/mutual-tls-authentication/ title="Mutual TLS Authentication" class=dd-item>
<a href=/service-mesh/2020/04/mutual-tls-authentication/>
Mutual TLS Authentication
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/fault-injection/ title="Fault Injection" class=dd-item>
<a href=/service-mesh/2020/04/fault-injection/>
Fault Injection
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/limit-egress/external-traffic/ title="Limit Egress/External Traffic" class=dd-item>
<a href=/service-mesh/2020/04/limit-egress/external-traffic/>
Limit Egress/External Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/advanced-routing-example/ title="Advanced Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/advanced-routing-example/>
Advanced Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/04/routing-example/ title="Routing Example" class=dd-item>
<a href=/service-mesh/2020/04/routing-example/>
Routing Example
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-with-custom-domain/ title="Ingress with custom domain" class=dd-item>
<a href=/service-mesh/2020/03/ingress-with-custom-domain/>
Ingress with custom domain
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/ingress-traffic/ title="Ingress Traffic" class=dd-item>
<a href=/service-mesh/2020/03/ingress-traffic/>
Ingress Traffic
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/deploy-microservices/ title="Deploy Microservices" class=dd-item>
<a href=/service-mesh/2020/03/deploy-microservices/>
Deploy Microservices
</a>
</li>
<li data-nav-id=/service-mesh/2020/03/installation/ title=Installation class=dd-item>
<a href=/service-mesh/2020/03/installation/>
Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/general/ title=General class=dd-item>
<a href=/general/>
General
</a>
<ul>
<li data-nav-id=/general/2020/05/basic-usage-of-git/ title="Basic usage of git" class=dd-item>
<a href=/general/2020/05/basic-usage-of-git/>
Basic usage of git
</a>
</li>
<li data-nav-id=/general/2020/04/red-hat-satellite-cheat-sheet/ title="Red Hat Satellite Cheat Sheet" class=dd-item>
<a href=/general/2020/04/red-hat-satellite-cheat-sheet/>
Red Hat Satellite Cheat Sheet
</a>
</li>
</ul>
</li>
<li data-nav-id=/ansible/ title=Ansible class=dd-item>
<a href=/ansible/>
Ansible
</a>
<ul>
<li data-nav-id=/ansible/2021/10/automation-controller-ad-ldap-authentication/ title="Automation Controller ad LDAP Authentication" class=dd-item>
<a href=/ansible/2021/10/automation-controller-ad-ldap-authentication/>
Automation Controller ad LDAP Authentication
</a>
</li>
<li data-nav-id=/ansible/2021/07/ansible-tower-and-downloading-collections/ title="Ansible Tower and downloading collections" class=dd-item>
<a href=/ansible/2021/07/ansible-tower-and-downloading-collections/>
Ansible Tower and downloading collections
</a>
</li>
<li data-nav-id=/ansible/2020/04/ansible-azure-resource-manager-example/ title="Ansible - Azure Resource Manager Example" class=dd-item>
<a href=/ansible/2020/04/ansible-azure-resource-manager-example/>
Ansible - Azure Resource Manager Example
</a>
</li>
<li data-nav-id=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/ title="DO410 Ansible and Ansible Tower training notes" class=dd-item>
<a href=/ansible/2020/04/do410-ansible-and-ansible-tower-training-notes/>
DO410 Ansible and Ansible Tower training notes
</a>
</li>
</ul>
</li>
<li data-nav-id=/azure/ title=Azure class="dd-item
parent">
<a href=/azure/>
Azure
</a>
<ul>
<li data-nav-id=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster" class=dd-item>
<a href=/azure/2021-10-29-private-aro/>
Stumbling into Azure Part II: Setting up a private ARO cluster
</a>
</li>
<li data-nav-id=/azure/2021-10-17-s2s-vpn/ title="Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing" class="dd-item active">
<a href=/azure/2021-10-17-s2s-vpn/>
Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing
</a>
</li>
</ul>
</li>
<li data-nav-id=/quay/ title=Quay class=dd-item>
<a href=/quay/>
Quay
</a>
<ul>
<li data-nav-id=/quay/2021-09-07-quay-upgrade-3.4/ title="Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator" class=dd-item>
<a href=/quay/2021-09-07-quay-upgrade-3.4/>
Stumbling into Quay: Upgrading from 3.3 to 3.4 with the quay-operator
</a>
</li>
<li data-nav-id=/quay/2020-05-13-quay-tutorial1/ title="Red Hat Quay Registry - Overview and Installation" class=dd-item>
<a href=/quay/2020-05-13-quay-tutorial1/>
Red Hat Quay Registry - Overview and Installation
</a>
</li>
</ul>
</li>
<li data-nav-id=/archive/ title=Archive class=dd-item>
<a href=/archive/>
Archive
</a>
</li>
<li data-nav-id=/legaldisclosure/ title="Legal Disclosure" class=dd-item>
<a href=/legaldisclosure/>
Legal Disclosure
</a>
</li>
<li data-nav-id=/rss/ title="RSS Feeds" class=dd-item>
<a href=/rss/>
RSS Feeds
</a>
</li>
</ul>
<section id=shortcuts>
<h3 class=shortcut-title>More</h3>
<ul>
<li>
<a class=padding href=https://blog.stderr.at/tags><i class="fas fa-tags"></i> Tags</a>
</li>
<li>
<a class=padding href=https://blog.stderr.at/categories><i class="far fa-bookmark"></i> Catagories</a>
</li>
<li>
<a class=padding href=https://www.redhat.com><i class="fab fa-redhat"></i> Red Hat</a>
</li>
</ul>
</section>
<section id=footer>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<aside id=toc-field class="hidden lg:block tableOfContentContainer">
<header id=TableOfContentsHeader>What's on this Page</header>
<nav id=TableOfContents>
<ul>
<li><a href=#headline-1>Azure Setup</a>
<ul>
<li><a href=#headline-2>Creating the required Azure resources</a>
</li>
</ul>
</li>
<li><a href=#headline-3>IPsec basics</a>
</li>
<li><a href=#headline-4>Required iptables (nf tables) hacks for libvirt</a>
<ul>
<li><a href=#headline-5>Skip NAT rules if the destination network is in Azure and the client network deploy via libvirt</a>
</li>
<li><a href=#headline-6>Skip NAT rules if the destination network is in Azure and the client is connected via tailscale</a>
</li>
</ul>
</li>
<li><a href=#headline-7>Libreswan setup on CentOS Stream</a>
</li>
<li><a href=#headline-8>Libreswan IPSEC debugging tips</a>
</li>
<li><a href=#headline-9>Additonal Resources</a>
</li>
</ul>
</nav>
<div id=navigation>
<a class=nav-prev href=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster"> <i class="fa fa-chevron-left"></i></a>
<a class=nav-next href=/quay/ title=Quay style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</aside>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://schema.org/BreadcrumbList>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/> <span itemprop=name>YAUB Yet Another Useless Blog</span><meta itemprop=position content="1"></a></span> > <span itemscope itemprop=itemListElement itemtype=http://schema.org/ListItem><a itemprop=item href=/azure/> <span itemprop=name>Azure</span><meta itemprop=position content="2"></a></span> > Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#headline-1>Azure Setup</a>
<ul>
<li><a href=#headline-2>Creating the required Azure resources</a>
</li>
</ul>
</li>
<li><a href=#headline-3>IPsec basics</a>
</li>
<li><a href=#headline-4>Required iptables (nf tables) hacks for libvirt</a>
<ul>
<li><a href=#headline-5>Skip NAT rules if the destination network is in Azure and the client network deploy via libvirt</a>
</li>
<li><a href=#headline-6>Skip NAT rules if the destination network is in Azure and the client is connected via tailscale</a>
</li>
</ul>
</li>
<li><a href=#headline-7>Libreswan setup on CentOS Stream</a>
</li>
<li><a href=#headline-8>Libreswan IPSEC debugging tips</a>
</li>
<li><a href=#headline-9>Additonal Resources</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Stumbling into Azure Part I: Building a site-to-site VPN tunnel for testing
</h1>
<p class=tracked>
<time class="f6 mv4 dib tracked" datetime=2021-10-16T00:00:00Z>
<strong>October 16, 2021</strong>
</time>
- By:
Toni Schmidbauer
( Lastmod: 2021-11-16 )
</p>
<p>
So we want to play with ARO (Azure Red Hat OpenShift) private
clusters. A private cluster is <strong>not</strong> reachable from the internet
(surprise) and is only reachable via a VPN tunnel from other networks.</p>
<p>
This blog post describes how we created a site-to-site VPN between a
Hetzner dedicated server running multiple VM's via libvirt and Azure.</p>
<p>
An upcoming blog post is going to cover the setup of the private ARO
cluster.</p>
<div id=outline-container-headline-1 class=outline-2>
<h2 id=headline-1>
Azure Setup
</h2>
<div id=outline-text-headline-1 class=outline-text-2>
<p>
The diagram below depicts our planned setup:</p>
<p><img src=/Azure/images/azure_network_setup.png alt=/Azure/images/azure_network_setup.png title=/Azure/images/azure_network_setup.png></p>
<p>
On the right hand side can see the resources required for our lab:</p>
<ul>
<li>
<p>a virtual network (vnet 192.168.128.0/19). This vnet will be split
into 3 separate subnets</p>
</li>
<li>
<p>a master subnet (192.168.129.0/24) holding the ARO control plane nodes</p>
</li>
<li>
<p>a node subnet (192.168.130.0/24) holding ARO worker nodes</p>
</li>
<li>
<p>and finally a subnet call <code>GatewaySubnet</code> where we are going to
deploy our Azure VPN gateway (called a <code>vnet-gateway</code>)</p>
<p>
<div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=warning></i></td><td class=content><p>
The subnet where the Azure VPN gateway is located needs to have
the name <code>GatewaySubnet</code>. Otherwise creating the Azure VPN gateway
will fail.</p>
</td></tr></tbody></table></div>
</p>
</li>
<li>
<p>we also need a <code>publicIP</code> resource that we are going to connect to
our <code>vnet-gateway</code> (the VPN gateway)</p>
</li>
<li>
<p>and finally a <code>local-gateway</code> resource that tells the
<code>vnet-gateway</code> which networks are reachable on the left, in our
case the Hetzner server.</p>
</li>
</ul>
<div id=outline-container-headline-2 class=outline-3>
<h3 id=headline-2>
Creating the required Azure resources
</h3>
<div id=outline-text-headline-2 class=outline-text-3>
<ol>
<li>
<p>First we are going to set some environment variable. Those
variables are used in the upcoming commands:</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>export RESOURCEGROUP<span style=color:#f92672>=</span>aro-rg
export GATWAY_SUBNET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.128.0/24&#34;</span>
export MASTER_SUBNET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.129.0/24&#34;</span>
export WORKER_SUBNET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.130.0/24&#34;</span>
export HETZNER_VM_NETWORKS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;10.0.0.0/24 192.168.122.0/24 172.16.100.0/24&#34;</span></code></pre></div>
</div>
</li>
<li>
<p>Next create a VNET resource holding our sub networks:</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vnet create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name aro-vnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--address-prefixes 192.168.128.0/18</code></pre></div>
</div>
</li>
<li>
<p>Create the <code>GatewaySubnet</code> subnet</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vnet subnet create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vnet-name aro-vnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name GatewaySubnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--address-prefixes $GATEWAY_SUBNET</code></pre></div>
</div>
</li>
<li>
<p>Create the master subnet</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vnet subnet create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vnet-name aro-vnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name master-subnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--address-prefixes $MASTER_SUBNET <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--service-endpoints Microsoft.ContainerRegistry</code></pre></div>
</div>
</li>
<li>
<p>Create the worker subnet</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vnet subnet create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vnet-name aro-vnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name worker-subnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--address-prefixes $WORKER_SUBNET <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--service-endpoints Microsoft.ContainerRegistry</code></pre></div>
</div>
</li>
<li>
<p>Create a <code>public IP</code> resource</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network public-ip create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name GatewayIP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--allocation-method Dynamic</code></pre></div>
</div>
</li>
<li>
<p>Create a <code>local-gateway</code> resource</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network local-gateway create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name playground <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--local-address-prefixes $HETZNER_VM_NETWORKS <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--gateway-ip-address 95.217.42.98</code></pre></div>
</div>
</li>
<li>
<p>Create a <code>vnet-gateway</code> resource (takes around 30 minutes)</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vnet-gateway create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name vpn-gateway <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--public-ip-address GatewayIP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vnet aro-vnet <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--gateway-type Vpn <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vpn-type RouteBased <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--sku Basic <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--no-wait</code></pre></div>
</div>
</li>
<li>
<p>Define a <code>vpn-connection</code></p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>az network vpn-connection create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--name VNet1toSite2 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--resource-group $RESOURCEGROUP <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--vnet-gateway1 vpn-gateway <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--local-gateway2 playground <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--location westeurope <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--shared-key thepassword</code></pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id=outline-container-headline-3 class=outline-2>
<h2 id=headline-3>
IPsec basics
</h2>
<div id=outline-text-headline-3 class=outline-text-2>
<p>
A few basic points in regards to</p>
</div>
</div>
<div id=outline-container-headline-4 class=outline-2>
<h2 id=headline-4>
Required iptables (nf tables) hacks for libvirt
</h2>
<div id=outline-text-headline-4 class=outline-text-2>
<div id=outline-container-headline-5 class=outline-3>
<h3 id=headline-5>
Skip NAT rules if the destination network is in Azure and the client network deploy via libvirt
</h3>
<div id=outline-text-headline-5 class=outline-text-3>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>iptables -I LIBVIRT_PRT <span style=color:#ae81ff>2</span> -t nat -d 192.168.129.0/24 -j RETURN
iptables -I LIBVIRT_PRT <span style=color:#ae81ff>2</span> -t nat -d 192.168.130.0/24 -j RETURN</code></pre></div>
</div>
</div>
</div>
<div id=outline-container-headline-6 class=outline-3>
<h3 id=headline-6>
Skip NAT rules if the destination network is in Azure and the client is connected via tailscale
</h3>
<div id=outline-text-headline-6 class=outline-text-3>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>iptables -I ts-postrouting <span style=color:#ae81ff>1</span> -t nat -d 192.168.129.0/24 -j RETURN
iptables -I ts-postrouting <span style=color:#ae81ff>1</span> -t nat -d 192.168.130.0/24 -j RETURN</code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id=outline-container-headline-7 class=outline-2>
<h2 id=headline-7>
Libreswan setup on CentOS Stream
</h2>
<div id=outline-text-headline-7 class=outline-text-2>
<ol>
<li>
<p>Install the Libreswan packages</p>
<div class="src src-h">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-h data-lang=h>dnf install libreswan</code></pre></div>
</div>
</li>
<li>
<p>Create a Azure configuration for Libreswan in ~/etc/ipsec.d/azure.conf</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>conn masterSubnet
also=azureTunnel
leftsubnet=192.168.129.0/24
rightsubnet=172.16.100.0/24
auto=start

conn workerSubnet
also=azureTunnel
leftsubnet=192.168.130.0/24
rightsubnet=172.16.100.0/24
auto=start

conn azureTunnel
authby=secret
auto=start
dpdaction=restart
dpddelay=30
dpdtimeout=120
ike=aes256-sha1;modp1024
ikelifetime=3600s
ikev2=insist
keyingtries=3
pfs=yes
phase2alg=aes128-sha1
left=51.137.113.44
leftsubnets=192.168.128.0/24
right=%defaultroute
rightsubnets=172.16.100.0/24
salifetime=3600s
type=tunnel
ipsec-interface=yes</code></pre></div>
</div>
</li>
<li>
<p>Create a Libreswan secrets file for Azure in <code>/etc/ipsec.d/azure.secrets</code>:</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>%any %any : PSK &#34;abc123&#34;</code></pre></div>
</div>
</li>
<li>
<p>Enable and start the IPsec service</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl enable --now ipsec</code></pre></div>
</div>
</li>
<li>
<p>We had to explicitly load the IPsec configuration via</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ipsec addconn --config /etc/ipsec.d/azure.conf azureTunnel</code></pre></div>
</div>
</li>
</ol>
</div>
</div>
<div id=outline-container-headline-8 class=outline-2>
<h2 id=headline-8>
Libreswan IPSEC debugging tips
</h2>
<div id=outline-text-headline-8 class=outline-text-2>
<ul>
<li>
<p>Check the state of the IPsec systemd service</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl status ipsec</code></pre></div>
</div>
</li>
<li>
<p>Check the full log of the IPsec systemd service</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>journalctl -e -u ipsec</code></pre></div>
</div>
</li>
<li>
<p>Check the state of the tunnels with the <code>ipsec</code> command line tool</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ipsec status</code></pre></div>
</div>
<p>
Check for the following lines</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#ae81ff>000</span> Total IPsec connections: loaded 5, active <span style=color:#ae81ff>2</span>
<span style=color:#ae81ff>000</span>
<span style=color:#ae81ff>000</span> State Information: DDoS cookies not required, Accepting new IKE connections
<span style=color:#ae81ff>000</span> IKE SAs: total<span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>, half-open<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, open<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, authenticated<span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>, anonymous<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>
<span style=color:#ae81ff>000</span> IPsec SAs: total<span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>, authenticated<span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>, anonymous<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>
<span style=color:#ae81ff>000</span>
<span style=color:#ae81ff>000</span> <span style=color:#75715e>#130: &#34;azureTunnel/1x1&#34;:500 STATE_V2_ESTABLISHED_CHILD_SA (IPsec SA established); EVENT_SA_REKEY in 2003s; newest IPSEC; eroute owner; isakmp#131; idle;</span>
<span style=color:#ae81ff>000</span> <span style=color:#75715e>#130: &#34;azureTunnel/1x1&#34; esp.56cf4304@51.137.113.44 esp.6f49e8d3@95.217.42.98 tun.0@51.137.113.44 tun.0@95.217.42.98 Traffic: ESPin=0B ESPout=0B! ESPmax=0B</span>
<span style=color:#ae81ff>000</span> <span style=color:#75715e>#129: &#34;masterSubnet/0x0&#34;:500 STATE_V2_ESTABLISHED_CHILD_SA (IPsec SA established); EVENT_SA_REKEY in 1544s; newest IPSEC; eroute owner; isakmp#131; idle;</span>
<span style=color:#ae81ff>000</span> <span style=color:#75715e>#129: &#34;masterSubnet/0x0&#34; esp.6e81e8da@51.137.113.44 esp.6f72bbc8@95.217.42.98 tun.0@51.137.113.44 tun.0@95.217.42.98 Traffic: ESPin=0B ESPout=0B! ESPmax=0B</span>
<span style=color:#ae81ff>000</span> <span style=color:#75715e>#131: &#34;masterSubnet/0x0&#34;:500 STATE_V2_ESTABLISHED_IKE_SA (established IKE SA); EVENT_SA_REKEY in 2121s; newest ISAKMP; idle;</span></code></pre></div>
</div>
<p>
IPsec specifies properties of connections via <a href=https://en.wikipedia.org/wiki/IPsec#Security_association>security
associations (SA)</a>. The parent SA is describes the IKEv2
connections, the child SA is the ESP (encapsulated security
payload) connection.</p>
<p>
Check IPsec transformation policies</p>
<div class="src src-sh">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ip xfrm policy</code></pre></div>
</div>
<p>
Check the state of IPsec transformation policies</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ip xfrm state</code></pre></div>
</div>
<p>
Check for dropped packages on the IPsec interface (ipsec1 in our case)</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ip -s link show dev ipsec1</code></pre></div>
</div>
</li>
</ul>
</div>
</div>
<div id=outline-container-headline-9 class=outline-2>
<h2 id=headline-9>
Additonal Resources
</h2>
<div id=outline-text-headline-9 class=outline-text-2>
<ul>
<li>
<p><a href=https://blog.notnot.ninja/2020/09/19/azure-site-to-site-vpn/>Build an Azure site-to-site VPN for DevTest</a></p>
</li>
<li>
<p><a href=https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli>Create a virtual network with a Site-to-Site VPN connection using CLI</a></p>
</li>
<li>
<p><a href=https://libreswan.org/wiki/FAQ#Why_is_it_recommended_to_disable_rp_filter_in_.2Fproc.2Fsys.2Fnet_.3F>Libreswan: Disable rp_filter for IPsec</a></p>
</li>
<li>
<p><a href=https://libreswan.org/wiki/FAQ#NAT_.2B_IPsec_is_not_working>Libreswan: NAT and IPsec not working</a></p>
</li>
<li>
<p><a href=https://libreswan.org/wiki/Subnet_to_subnet_VPN>Libreswan: Subnet to subnet VPN</a></p>
</li>
</ul>
</div>
</div>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation-bottom>
<a class="nav-prev btn btn-default" href=/azure/2021-10-29-private-aro/ title="Stumbling into Azure Part II: Setting up a private ARO cluster"> <i class="fa fa-chevron-left btn-bottom-prev"></i><span class=btn-bottom-text>Previous: </span> Stumbling into Azure Part II: Setting up a private ARO cluster</a>
<a class="nav-next btn btn-default" href=/quay/ title=Quay style=margin-right:0><i class="fa fa-chevron-right btn-bottom-next"></i><span class=btn-bottom-text>Next:</span> Quay</a>
</div>
<div class=copyright>
<p>Copyright &copy; 2020 - 2021 Toni Schmidbauer & Thomas Jungbauer</p>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn target=_blank rel="noopener noreferrer">Hugo Learn Theme</i></a> and <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a></p>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1637052716></script>
<script src=/js/perfect-scrollbar.min.js?1637052716></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1637052716></script>
<script src=/js/jquery.sticky.js?1637052716></script>
<script src=/js/featherlight.min.js?1637052716></script>
<script src=/js/highlight.pack.js?1637052716></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1637052716></script>
<script src=/js/learn.js?1637052716></script>
<script src=/js/hugo-learn.js?1637052716></script>
<script src=/js/yaub.js?1637052716></script>
<script>window.addEventListener('DOMContentLoaded',()=>{const a=new IntersectionObserver(a=>{a.forEach(a=>{const b=a.target.getAttribute('id');a.intersectionRatio>0&&(clearActiveStatesInTableOfContents(),document.querySelector(`aside nav li a[href="#${b}"]`).parentElement.classList.add('active'))})});document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach(b=>{a.observe(b)})});function clearActiveStatesInTableOfContents(){document.querySelectorAll('aside nav li').forEach(a=>{a.classList.remove('active')})}</script>
<script type=text/javascript>function scrollTopAnimated(){$("html, body").animate({scrollTop:"0"},500)}</script>
<script>function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".summary-box").click(function(){return window.location=$(this).find("a").attr("href"),!1})</script>
<script>const btn=document.querySelector(".btn-toggle"),prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)"),currentTheme=localStorage.getItem("theme");currentTheme=="dark"?document.body.classList.toggle("dark-theme"):currentTheme=="light"&&document.body.classList.toggle("light-theme"),btn.addEventListener("click",function(){var a;prefersDarkScheme.matches?(document.body.classList.toggle("light-theme"),a=document.body.classList.contains("light-theme")?"light":"dark"):(document.body.classList.toggle("dark-theme"),a=document.body.classList.contains("dark-theme")?"dark":"light"),localStorage.setItem("theme",a)})</script>
</body>
</html>